{"version":3,"sources":["webpack:///./src/filesystem.ts","webpack:///./src/game/world/world.ts","webpack:///./src/util/assert.ts","webpack:///./src/game/game.ts","webpack:///./src/game/island-renderer.ts","webpack:///./src/game/renderer/isometric/renderered-ship.ts","webpack:///./src/game/world/ship-course.ts","webpack:///./src/game/world/ship.ts","webpack:///./src/game/radius.ts","webpack:///./src/game/game-renderer.ts","webpack:///./src/game-loader.ts","webpack:///./src/game/animation-renderer.ts","webpack:///./src/game/field-type.ts","webpack:///./src/game/config-loader.ts","webpack:///./src/game/font-loader.ts","webpack:///./src/game/ui/slider-sprite.ts","webpack:///./src/game/gad-renderer.ts","webpack:///./src/game/island-sprite-loader.ts","webpack:///./src/util/pixi.ts","webpack:///./src/game/world/island-ore-location.ts","webpack:///./src/game/world/castle.ts","webpack:///./src/game/world/city.ts","webpack:///./src/game/world/island.ts","webpack:///./src/game/world/good.ts","webpack:///./src/game/world/contract.ts","webpack:///./src/game/world/kontor.ts","webpack:///./src/game/world/player-event.ts","webpack:///./src/game/world/player.ts","webpack:///./src/game/world/soldier.ts","webpack:///./src/game/world/producer.ts","webpack:///./src/game/world/task.ts","webpack:///./src/game/world/timers.ts","webpack:///./src/game/world/world-generation-settings.ts","webpack:///./src/parsers/GAM/block.ts","webpack:///./src/parsers/GAM/world-generator.ts","webpack:///./src/translation/translations.ts","webpack:///./src/parsers/GAM/gam-parser.ts","webpack:///./src/game/world/trader.ts","webpack:///./src/translation/translator.ts","webpack:///./src/game/menu/missions.ts","webpack:///./src/game/menu-structure.ts","webpack:///./src/game/music-player.ts","webpack:///./src/game/world/field.ts","webpack:///./src/parsers/GAM/island-loader.ts","webpack:///./src/sprite-loader.ts","webpack:///./src/parsers/BSH/bsh-color-palette.ts","webpack:///./src/parsers/BSH/bin-packer.ts","webpack:///./src/parsers/BSH/bsh-image.ts","webpack:///./src/parsers/BSH/bsh-parser.ts","webpack:///./src/parsers/DAT/dat-parser.ts","webpack:///./src/parsers/SMK/smk-parser.ts","webpack:///./src/parsers/WAV/wav-parser.ts","webpack:///./src/parsers/ZEI/bitmap-font-generator.ts","webpack:///./src/translation/translation-parser.ts","webpack:///./src/uploadInfo.tsx","webpack:///./src/upload.ts","webpack:///./src/index.ts","webpack:///./src/util/ffmpeg.ts","webpack:///./src/parsers/stream.ts","webpack:///./src/parsers/COD/cod-parser.ts","webpack:///./src/util/util.ts"],"names":["SimulationSpeed","Filer","require","FileSystem","filer","this","size","Promise","resolve","reject","init","persistent","filename","create","foldername","mkdir","directory","filterByExtensions","ls","entries","extensions","split","filter","entry","isFile","some","extension","name","endsWith","entryOrPath","path","fullPath","startsWith","Error","parts","part","undefined","find","open","getTextContentFromFile","Stream","getUint8ContentFromFile","file","fileReader","FileReader","onload","event","result","onerror","readAsText","Uint8Array","readAsArrayBuffer","df","used","free","cap","pathOrEntry","content","write","data","rm","all","map","downloadFile","downloadDirectory","fileName","openAndGetContentAsUint8Array","doDownload","zip","JSZip","addToZip","console","log","subEntries","generateAsync","type","zipContent","blob","Blob","element","document","createElement","href","window","URL","createObjectURL","download","click","assert","expr","message","World","islands","players","tasks","gameName","soldiers","ships","kontors","castles","cities","trader","timers","producers","table","Game","configLoader","world","state","timerId","getFieldAtIsland","island","islandPos","fields","x","y","getFieldAt","globalPos","Object","values","each","positionRect","contains","Point","position","tick","timeGame","cntCity","inc","cntIsland","cntShipyard","cntMilitary","cntProduction","watchTicksForUpkeep","watchTicksForProducing","emit","value","max","interval","mapArrayById","simulationSpeed","Paused","speed","clearInterval","setInterval","arr","reduce","objectMap","obj","id","upkeeps","calculateUpkeeps","keys","playerId","upkeep","Math","floor","addMoney","parseInt","money","fieldData","getFieldData","forEach","producer","active","islandId","buildingId","fieldId","fieldConfig","get","producedGood","timer","newStock","stock","newFirstGoodStock","firstGoodStock","production","amount1","newSecondGoodStock","secondGoodStock","amount2","canProduceEvenMore","maxStock","updateProcuder","canProduce","producerId","patch","assign","field","EventEmitter","TILE_WIDTH","TILE_HEIGHT","IslandRenderer","spriteLoader","render","getIslandSprites","islandSprites","spritesOfIsland","sprites","row","sprite","addChild","CourseState","RenderedShip","isTrader","animation","bugAnimation","whiteFlag","flag","hp","HP_WIDTH","HP_HEIGHT","ship","animationRenderer","getShipAnimation","config","Bugfignr","getAnimation","flagAnimationName","Graphics","beginFill","drawRect","viewport","rotation","GameRenderer","fieldPosToWorldPos","main","animations","rotations","mainX","width","mainY","Posoffs","n","sign","abs","Fahnoffs","flagOffsetX","SQRT2","assertNever","flagOffsetY","waveSprite","play","flagAnimation","flagX","flagY","hpX","hpY","height","set","ShipCourse","num","read32","byte2","byte3","byte4","SHIP_TYPES","shipFromSaveGame","readString","read16","read","fromSaveGame","read8","kind","tradeStops","i","push","kontor_id","_1","goods","parseShipGoods","_2","parseShipTradeStops","cargo","good_id","amount","action","isWithinRadius","building","radius","point","center","ceil","game","islandSpriteLoader","app","myPlayerId","simulationSpeedDisplay","WIDTH","HEIGHT","keyboardManager","showRadiusOfAllBuildings","radiusSprites","setMoney","text","cull","viewportBounds","getVisibleBounds","topLeft","worldPosToFieldPos","bottomRight","visible","KeyboardManager","setupHotKeys","Text","fontFamily","fontSize","fill","fieldPos","xx","yy","worldX","worldY","worldPos","round","adjustedWorldPos","copyFrom","enable","ticker","add","update","removeChildren","debugControls","dbg","w","h","rect","spritesPerIsland","smokeSprites","smokeSprite","make2DArray","mapPosition","waterTexture","texture","Sprite","anchor","moveCameraToStartPosition","renderedShips","begin","merge","from","fromEvent","pipe","auditTime","subscribe","addListener","onProduced","highlightField","annoX","annoY","color","landFieldPosToWorldPos","tmp","alpha","drawPolygon","base","actualSizeX","actualSizeY","buildingRectangle","Rectangle","showTaskKey","Key","F1","onKeyPressedWithPreventDefault","player","assignedTask","assignedTaskId","info","zoomKeys","key","F2","zoom","F3","F4","zoomKey","speedKeys","PAUSE","F5","Slow","F6","Medium","F7","Fast","SHIFT","F8","SuperFast","speedKey","onKeysPressedWithPreventDefault","setSimulationSpeed","LEFT","RIGHT","UP","DOWN","setPreventDefault","on","moveCorner","corner","R","toggleShowRadiusOfAllBuildings","scale","moveCenter","pos","startTime","lastTime","fn","deltaMS","remove","removeChild","debugContainer","Container","coordinates","islandNumber","producerInfo","interactionManager","renderer","plugins","interaction","updatePosition","worldPosToFieldPosLand","toWorld","mouse","global","localPosition","good","good1","good2","parent","myKontor","kontor","myShip","moveTo","kontorIsland","GameLoader","fs","gamParser","musicPlayer","loadSavesAndMissions","games","saveGame","saveOrMission","join","load","openAndGetContentAsStream","saveGameData","getWorld","gameLogic","gameRenderer","playAll","Default","saves","missions","concat","AnimationRenderer","animationData","objects","FIGUR","items","includes","ANIM","0","FAHNEMARKT","nested_objects","length","baseGfx","Gfx","baseFramesPerRotation","Rotate","GfxCategoryMapped","gfxFilename","substr","getTextures","textures","animatedSprites","animIdx","animatedSpritesForAnim","numSteps","AnimAnz","AnimSpeed","gfxPerStep","AnimAdd","AnimRept","framesPerRotation","rotationIdx","spritesForRotation","gfx","AnimOffs","frames","step","animatedSprite","AnimatedSprite","loop","Kind","animationSpeed","debugDrawSprite","animationName","lineStyle","FieldType","gfxId","rotate","animAdd","yOffset","animTime","animAnz","Id","Size","AnimTime","productionConfig","HAUS_PRODTYP","inactive","Array","isArray","Kosten","Ware","Rohstoff","Workstoff","Rohmenge","Workmenge","Radius","Interval","Maxlager","smokeAnimationNames","Rauchfignr","islandPosition","animationStep","smokeAnimations","sx","sy","getTexture","animatedTextures","pixelPosition","mapPositionOnIsland","smokeAnimationName","smokeAnimation","tileId","ConfigLoader","loaded","Map","JSON","openAndGetContentAsText","parse","HAUS","FontLoader","fonts","ZEI20V","fontName","font","Loader","shared","uInt8ToBase64","SliderSprite","dragging","topY","sizeY","offsetY","sliderSizeY","eventY","originalEvent","clamp","val","min","GADRenderer","stage","videos","destroyVideos","blockNumMapping","variables","substring","radioButtons","selectableCount","gadgets","GADGET","gadget","blockNr","Blocknr","Gfxnr","Pos","selectable","Noselflg","pressOff","Pressoff","isRadioButton","Reiheflg","isSlider","Slidverflg","sliderOffset","Slidoffs","sliderSize","Slidsize","defaultTexture","activeTexture","setSliderData","buttonMode","interactive","callback","buttons","button","BitmapText","pivot","hitArea","warn","onLoad","videoSprite","onEnd","baseTexture","resource","source","addEventListener","once","video","destroy","IslandSpriteLoader","inited","lock","AsyncLock","acquire","loadSpritesOfField","origin","getSprites","ani","newSprites","newSprite","textureFromUint8ArrayMP4","tmpVideo","src","Texture","OreLocationKind","OreLocationSize","Unit","ready","flags","castleFromSaveGame","numSwords","numMuscets","numCanons","units","parseUnits","cityFromSaveGame","cityIslandNum","progressAllowed","read8Bool","inhabitants","taxes","IslandFertilityFlags","GoodAction","OreLocation","discoveredBy","islandFromIsland3File","isSouth","numBaseIsland","numOreLocations","oreLocations","fertility","tobacco","sugarcane","wine","cotton","cacao","spice","differsFromBaseIsland","fertilityDiscovered","islandFromIsland4File","islandFromIsland5File","islandFromSaveGame","every","e","TOBACCO","SUGARCANE","WINE","COTTON","CACAO","SPICE","parseFertility","ContractState","Good","goodId","sellingPrice","buyingPrice","wantedSellingAmount","wantedBuyingAmount","currentAmount","kontorFromSaveGame","parseGoods","PlayerEventKind","Contract","time","PlayerKind","SoldierType","PlayerEvent","otherPlayerId","playerFromSaveGame","read32S","killedByPlayerId","_3_3","_3_2","palaceBuilt","cathedralBuilt","enemiesDefeated","triumphArchesBuilt","soldiersKilled","soldiersFallen","shipsSunken","shipsKilled","_4","enablePositiveWillInfluence","enableNegativeWillInfluence","_5","positiveWillInfluence","negativeWillInfluence","accessibleBuildings","statues","statuesBuilt","tradeContracts","peaceContracts","playerEvents","fullName","shortName","producerFromSaveGame","speedCount","Number","isInteger","prodCnt","timeCnt","flags1","connectedToMarket","animCnt","allowGoodPickup","noGoodCnt","soldierFromSaveGame","isPatrolling","taskFromSaveGame","monopolyGoodId1","monopolyGoodId2","helpOtherToReachInhabitantsPlayerId","playersToKill","_3","requiredBalance","successVideoId","requiredTradeBalance","_6","ownCityReachInhabitants","count","requiredLevel","requiredLevelCount","_7","helpOtherToReachInhabitants","timersFromSaveGame","cntSettlers","cntGrowth","timeCity","timeIsland","timeShipyard","timeMilitary","timeProduction","timeGoodToolsCnt","timeGoodToolsMax","noErzOutFlg","tutorFlg","aiLevel","missionNumber","enableTrader","bigIronRunsOut","enableDroughts","enablePirate","enableVulcano","gameId","cityNameNumber","timeNextDrought","timePirateSec","missionSubNumber","shipMax","timeNextVulcano","cntVulcano","timeSettlers","timeGrowth","WorldGenerationSettings","numNativesNorth","numNativesSouth","numBigIronOre","numSmallIronOre","numGoldOre","numWine","numSugarCane","numSpice","numCacao","numTobacco","numCotton","numTreasures","islandTemplates","slice","numIslands","forceNorth","forceSouth","islandSize","climate","Block","WorldGenerator","islandLoader","worldGenerationSettings","nextIslandId","islandTemplate","loadRandomIslandFile","loadIslandFileNum","blocks","eof","fromStream","inselBlock","block","inselHausBlock","newIsland","setIslandFields","GAME","LEISTE","PLAYCOL","VIDEOKIND","SPEECHKIND","PATH","ENDLESSKIND","TUTORKIND","KAMPAGNE","FIGKIND","WARE","ROHST","ROHSTFELD","MILITAR","WOHNHAUS","STRASSE","BERGWERK","HANDWERK","FARM","HAFEN","DIVERS","ABRISS","LANDSCHAFT","GAMParser","worldGenerator","has","lastIslandBlock","inselHausBlocks","doParse","populateWorld","nameBlock","playerBlock","parsePlayers","islandBlocks","parseIslands","handleBlock","empty","entities","islandBlock","islandBuildingBlocks","islandTopBlock","islandBottomBlock","loadIslandFile","islandFile","lookup","translations","t","loadTranslations","jsonData","translationIdx","domain","keyToIdxMapping","translationKey","Missions","menuStructure","renderNewGame","bind","renderLoadGame","renderScreen","currentPage","newGameLines","ROWS","SCROLL_UP","SCROLL_DOWN","getNewGameLines","_playMainMenuMusic","currentTopItem","bitmapText","getChildByName","off","line","save","toString","padStart","loadMissions","mission","missionNum","replace","ranking","campaignNum","sort","a","b","MenuStructure","gadRenderer","structure","menu_main","stop","loadVideoSprite","renderVideo","renderVideoFullscreen","menu_missions","menu_loading","menu_mission_details","screen","videoNumber","videoData","utils","Sound","pixiSound","MusicPlayer","playing","songs","currentSongIdx","files","buffer","loadSound","sound","song","isPlaying","playNext","preload","singleInstance","err","preloadedSound","Field","islandCityNum","random","bits","saveGameDataLength","IslandLoader","islandSizes","maxSize","sizeId","islandFiles","loadIslandsWithSizeAndClimate","randomIslandFile","parsedFields","parseIslandFields","parsedField","dataLength","sizeName","exec","SpriteLoader","loadTextures","textureMap","lastIndexOf","dataFileName","spriteSheetData","spriteSheetImageData","tex","spritesheet","Spritesheet","sheet","hmm","BinPacker","root","node","findNode","splitNode","right","down","idxToColors","colorsToIdxInner","colorsToIdx","UPNG","BSHImage","pixels","encode","BSHParser","SPRITESHEET_SIZE","HEADER_SIZE","decode","images","sheets","binPacker","atlasData","meta","image","addBlock","png","startX","startY","j","idx","frame","rotated","trimmed","spriteSourceSize","sourceSize","outName","saveSpriteSheet","SmartBuffer","writeString","padEnd","writeUInt32LE","imageBuffer","encodeImage","toBuffer","writeOffset","writeBuffer","fileLength","imageOffsets","numImages","seek","bshImage","decodeImage","rowIdx","targetIdx","ch","coloredPixels","colorPalette","FEs","skipPixelsEmpty","writeUInt8","coloredPixelsSlice","pixel","colorIdx","padding","spritesheetIndex","stringify","DATParser","template","gfxMap","lastGfxName","currentObject","currentNestedObject","currentItem","currentNestedItem","initialVariables","trim","handleConstantAssignment","handleObjFill","handleNestedObjectBegin","handleProperty","handleNestedObjectEnd","mapToObject","gfx_category_map","item","prototype","hasOwnProperty","call","baseItemNum","getValue","baseItem","deepCopy","GfxCategory","isMath","constant","currentGfx","objectName","valueAsString","nestedItem","isObject","deepMerge","arrayElement","oldVal","parseFloat","arrayIdx","res","v","index","op","val1","val2","target","output","SMKParser","ffmpeg","memory","loadFFmpeg","inputFiles","args","prepareArguments","convert","mergeAudio","handleOutput","str","arguments","print","printErr","stdin","TOTAL_MEMORY","noExitRuntime","returnCallback","WAVParser","adpcmIndexTable","adpcmStepTable","wav","WaveFile","bitsPerSample","fmt","sampleRate","channels","numChannels","c1","step_index","predictor","c2","samples","left","Int16Array","decodeADPCM_IMA","rawData","numSamples","fromScratch","c","nibble","stepIndex","av_clip","diff","av_clip_int16","xml","BitmapFontGenerator","pages","chars","pageId","page","_attr","char","xoffset","yoffset","xadvance","chnl","letter","String","fromCharCode","face","spacing","italic","bold","stretchH","smooth","aa","common","lineHeight","packed","indent","parseTranslations","currentDomain","UploadInfo","props","msg","error","setState","prevState","messages","zipUploaded","evt","alert","isUploading","onUploaded","worked","resetFiles","onReset","location","reload","setLogger","style","marginLeft","marginRight","maxWidth","multiple","accept","onChange","disabled","toUpperCase","onSaveOrMissionUploaded","onClick","onDownloadFiles","React","escapeStringRegexp","UploadHandler","logger","notes","ReactDOM","uploadAndParse","reset","uploadSaveOrMission","appendChild","exists","rmRoot","zipFileEntry","loadAsync","annoRoot","findRootInZip","copyIslands","copySaves","customMissionPath","copyMissions","decryptCODs","parseDATs","parseGADs","parseBSHs","parseZEIs","parseMusic","parseVideos","r","inName","parser","toolsIncPath","toolsIncFile","findFileCaseInsensitive","async","toolsIncData","gadFile","CODParser","codFile","fromZipObject","codStream","decrypt","bshFile","decodeBSH","createSpriteSheets","saveSpriteSheets","translationFile","codParser","bitmapFontGenerator","zeiFile","decodeZEI","createBitmapFont","hasFolderCaseInsensitive","wavParser","findFilesInZip","wavData","smkParser","copyFolderFromZip","inPath","outPath","fileExtensions","makeLowerCase","fileAndPath","relativePath","toLowerCase","targetPath","fileExtension","caseInsensitiveFileName","RegExp","caseInsensitiveFolderName","folder","innerText","version","innerHTML","__VERSION__","head","body","uploadHandler","isUploaded","settings","SCALE_MODE","SCALE_MODES","NEAREST","MIPMAP_TEXTURES","MIPMAP_MODES","OFF","Application","innerWidth","innerHeight","antialias","transparent","insertAdjacentElement","view","Viewport","screenWidth","screenHeight","passiveWheel","drag","direction","wheel","mouseEdges","distance","menuViewport","worldWidth","worldHeight","fontLoader","gameLoader","queryGameName","getQueryParameter","gad","islandName","loadByName","renderAnimation","loadIslandFileByName","islandRenderer","loadedFFmpeg","doLoadFFmpeg","loadFFmpegInBrowser","eval","__dirname","ffmpeg_run","self","getElementsByTagName","script","onreadystatechange","done","character","readNBytes","encoding","decryptedBytes","Buffer","iconv_decode","iconv_encode","encryptedBytes","CHUNK_SIZE","subarray","apply","btoa","defaultValue","url","results","decodeURIComponent","gfxFolder"],"mappings":"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I,4BAAAA,I,oCAAAA,I,oCAAAA,I,4BAAAA,I,sCAAAA,I,kCAAAA,I,gCAAAA,I,8BAAAA,I,8BAAAA,I,6BAAAA,I,iCAAAA,I,mCAAAA,I,mCAAAA,I,6BAAAA,I,qDAAAA,I,iCAAAA,I,+BAAAA,I,iCAAAA,I,+BAAAA,I,mCAAAA,I,iCAAAA,I,+BAAAA,I,6BAAAA,I,kCAAAA,Q,cA8BAC,O,gCAAAA,I,oCAAAA,I,kCAAAA,I,wCAAAA,I,kCAAAA,I,gCAAAA,I,gCAAAA,I,8CAAAA,I,8BAAAA,I,kCAAAA,I,+BAAAA,I,yCAAAA,I,gCAAAA,Q,cAgBAC,O,4CAAAA,I,gDAAAA,I,8CAAAA,I,oDAAAA,I,8CAAAA,I,4CAAAA,I,4CAAAA,I,0DAAAA,I,0CAAAA,I,8CAAAA,I,2CAAAA,I,qDAAAA,I,4CAAAA,Q,cAgBAC,O,sEAAAA,I,sEAAAA,I,kFAAAA,I,oEAAAA,I,oEAAAA,I,gFAAAA,I,4EAAAA,I,wEAAAA,I,0EAAAA,I,yEAAAA,Q,cAaAC,O,qDAAAA,Q,cAIAC,O,kEAAAA,I,oEAAAA,I,kEAAAA,I,oEAAAA,I,4DAAAA,I,4DAAAA,I,4DAAAA,I,6DAAAA,Q,cAWAC,O,oDAAAA,I,gDAAAA,I,0DAAAA,I,iDAAAA,Q,cAOAC,O,gEAAAA,I,kEAAAA,I,wEAAAA,I,gEAAAA,I,kEAAAA,I,wEAAAA,I,gEAAAA,I,4EAAAA,I,wEAAAA,I,wEAAAA,I,2EAAAA,I,yEAAAA,I,yEAAAA,I,qEAAAA,I,6EAAAA,I,gFAAAA,Q,cAmBAC,O,oDAAAA,I,wDAAAA,I,sDAAAA,I,kDAAAA,I,oDAAAA,I,kDAAAA,I,oDAAAA,I,sDAAAA,I,wDAAAA,I,kDAAAA,I,qDAAAA,I,iDAAAA,I,mDAAAA,I,2DAAAA,I,6DAAAA,I,qDAAAA,I,uDAAAA,I,mDAAAA,I,sDAAAA,Q,cAsBAC,O,gEAAAA,I,gEAAAA,I,gEAAAA,I,gEAAAA,I,sDAAAA,I,kDAAAA,I,sEAAAA,I,uEAAAA,Q,cAWAC,O,sDAAAA,I,kEAAAA,I,wDAAAA,I,wDAAAA,I,8DAAAA,I,wDAAAA,I,wDAAAA,I,wDAAAA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GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,EAAM,GAAM,EACZ,GAAM,GAAM,EACZ,GAAM,GAAM,EACZ,GAAM,GAAM,EACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,EACZ,GAAM,GAAM,EACZ,GAAM,GAAM,EACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,IACZ,GAAM,GAAM,EACZ,GAAM,GAAM,EACZ,GAAM,GAAM,GACZ,GAAM,IAAM,GACZ,GAAM,IAAM,GACZ,GAAM,IAAM,IACZ,GAAM,IAAM,IACZ,EAAM,GAAM,IACZ,EAAM,GAAM,IACZ,IAAM,IAAM,GACZ,EAAM,GAAM,IACZ,EAAM,GAAM,IACZ,GAAM,GAAM,IACZ,GAAM,GAAM,IACZ,EAAM,GAAM,IACZ,GAAM,GAAM,IACZ,EAAM,GAAM,IACZ,GAAM,GAAM,IACZ,GAAM,GAAM,IACZ,GAAM,IAAM,IACZ,GAAM,IAAM,IACZ,EAAM,GAAM,IACZ,EAAM,GAAM,IACZ,GAAM,IAAM,IACZ,GAAM,IAAM,IACZ,EAAM,IAAM,IACZ,GAAM,IAAM,IACZ,GAAM,IAAM,IACZ,GAAM,IAAM,IACZ,GAAM,IAAM,IACZ,GAAM,IAAM,IACZ,GAAM,IAAM,IACZ,GAAM,IAAM,IACZ,EAAM,IAAM,IACZ,GAAM,IAAM,IACZ,GAAM,IAAM,IACZ,GAAM,IAAM,IACZ,EAAM,IAAM,IACZ,GAAM,IAAM,IACZ,EAAM,IAAM,IACZ,GAAM,IAAM,IACZ,IAAM,IAAM,GACZ,GAAM,IAAM,IACZ,EAAM,IAAM,IACZ,EAAM,IAAM,IACZ,GAAM,IAAM,IACZ,GAAM,IAAM,IACZ,GAAM,IAAM,IACZ,GAAM,IAAM,IACZ,GAAM,IAAM,IACZ,GAAM,IAAM,IACZ,EAAM,IAAM,IACZ,GAAM,IAAM,IACZ,EAAM,IAAM,IACZ,IAAM,IAAM,IACZ,IAAM,IAAM,IACZ,IAAM,IAAM,EACZ,IAAM,IAAM,EACZ,EAAM,IAAM,IACZ,IAAM,IAAM,GACZ,IAAM,IAAM,GACZ,GAAM,IAAM,IACZ,GAAM,IAAM,IACZ,GAAM,IAAM,IACZ,IAAM,IAAM,IACZ,GAAM,IAAM,IACZ,GAAM,GAAM,EACZ,GAAM,GAAM,EACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,EACZ,GAAM,GAAM,GACZ,GAAM,IAAM,EACZ,GAAM,IAAM,EACZ,GAAM,GAAM,EACZ,GAAM,IAAM,GACZ,GAAM,IAAM,EACZ,GAAM,IAAM,GACZ,GAAM,IAAM,EACZ,GAAM,IAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,IAAM,GACZ,GAAM,GAAM,IACZ,GAAM,GAAM,IACZ,GAAM,IAAM,IACZ,GAAM,GAAM,EACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,GAAM,GACZ,GAAM,IAAM,GACZ,GAAM,GAAM,GACZ,GAAM,IAAM,GACZ,GAAM,IAAM,GACZ,GAAM,GAAM,GACZ,GAAM,IAAM,GACZ,GAAM,GAAM,GACZ,GAAM,IAAM,IACZ,IAAM,GAAM,GACZ,IAAM,GAAM,GACZ,IAAM,GAAM,GACZ,IAAM,GAAM,GACZ,IAAM,IAAM,GACZ,IAAM,IAAM,GACZ,IAAM,IAAM,IACZ,IAAM,GAAM,EACZ,IAAM,GAAM,GACZ,IAAM,GAAM,GACZ,IAAM,GAAM,GACZ,IAAM,GAAM,EACZ,IAAM,GAAM,GACZ,IAAM,GAAM,EACZ,IAAM,GAAM,GACZ,GAAM,IAAM,EACZ,GAAM,IAAM,EACZ,GAAM,IAAM,EACZ,GAAM,IAAM,EACZ,GAAM,IAAM,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","file":"app.ce5d965e18a316266566.js","sourcesContent":["import Stream from \"./parsers/stream\";\nimport JSZip from \"jszip\";\n\n// eslint-disable-next-line @typescript-eslint/no-var-requires\nconst Filer = require(\"filer.js\");\n\nexport default class FileSystem {\n  private filer: any;\n  constructor() {\n    this.filer = new Filer();\n  }\n\n  public async init(size: number) {\n    return new Promise((resolve, reject) =>\n      this.filer.init(\n        {\n          persistent: true,\n          size: size\n        },\n        resolve,\n        reject\n      )\n    );\n  }\n\n  public async create(filename: string | WebKitEntry) {\n    return new Promise((resolve, reject) =>\n      this.filer.create(filename, false, resolve, reject)\n    );\n  }\n\n  public async mkdir(foldername: string | WebKitEntry) {\n    return new Promise((resolve, reject) =>\n      this.filer.mkdir(foldername, false, resolve, reject)\n    );\n  }\n\n  public async ls(\n    directory: string | WebKitEntry,\n    filterByExtensions?: string\n  ): Promise<WebKitEntry[]> {\n    const entries = await new Promise<WebKitEntry[]>((resolve, reject) => {\n      this.filer.ls(directory, resolve, reject);\n    });\n\n    if (!filterByExtensions) {\n      return entries;\n    }\n\n    const extensions = filterByExtensions.split(\"|\");\n    return entries.filter((entry: WebKitEntry) => {\n      return (\n        entry.isFile &&\n        extensions.some(extension => entry.name.endsWith(extension))\n      );\n    });\n  }\n\n  public async exists(entryOrPath: string | WebKitEntry) {\n    let path: string;\n    if ((entryOrPath as WebKitEntry).fullPath) {\n      path = (entryOrPath as WebKitEntry).fullPath;\n    } else {\n      path = entryOrPath as string;\n    }\n    if (!path.startsWith(\"/\")) {\n      throw new Error(\n        `exists() only works with absolute paths, \"${path}\" given.`\n      );\n    }\n    const parts = path.split(\"/\").filter(part => part !== \"\");\n    path = \"\";\n    for (const part of parts) {\n      path += \"/\";\n      const entries = await this.ls(path);\n      // eslint-disable-next-line require-atomic-updates\n      path += part;\n      if (entries.find(entry => entry.fullPath === path) === undefined) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  public async open(entryOrPath: string | WebKitEntry): Promise<File> {\n    return new Promise((resolve, reject) =>\n      this.filer.open(entryOrPath, resolve, reject)\n    );\n  }\n\n  public async openAndGetContentAsText(entryOrPath: string | WebKitEntry) {\n    return this.getTextContentFromFile(await this.open(entryOrPath));\n  }\n\n  public async openAndGetContentAsStream(\n    entryOrPath: string | WebKitEntry\n  ): Promise<Stream> {\n    return new Stream(\n      await this.getUint8ContentFromFile(await this.open(entryOrPath))\n    );\n  }\n\n  public async openAndGetContentAsUint8Array(\n    entryOrPath: string | WebKitEntry\n  ): Promise<Uint8Array> {\n    return this.getUint8ContentFromFile(await this.open(entryOrPath));\n  }\n\n  public async getTextContentFromFile(file: File): Promise<string> {\n    return new Promise<string>((resolve, reject) => {\n      const fileReader = new FileReader();\n      fileReader.onload = event => {\n        if (fileReader.result !== null) {\n          resolve(fileReader.result as string);\n        } else {\n          reject();\n        }\n      };\n      fileReader.onerror = event => {\n        reject();\n      };\n      fileReader.readAsText(file);\n    });\n  }\n\n  public async getUint8ContentFromFile(file: File): Promise<Uint8Array> {\n    return new Promise<Uint8Array>((resolve, reject) => {\n      const fileReader = new FileReader();\n      fileReader.onload = event => {\n        if (fileReader.result !== null) {\n          resolve(new Uint8Array(fileReader.result as ArrayBuffer));\n        } else {\n          reject();\n        }\n      };\n      fileReader.onerror = event => {\n        reject();\n      };\n      fileReader.readAsArrayBuffer(file);\n    });\n  }\n\n  public async df() {\n    return new Promise((resolve, reject) => {\n      this.filer.df(\n        (used: number, free: number, cap: number) =>\n          resolve({ used: used, free: free, cap: cap }),\n        reject\n      );\n    });\n  }\n\n  public async write(pathOrEntry: string | WebKitEntry, content: any) {\n    return new Promise((resolve, reject) =>\n      this.filer.write(pathOrEntry, { data: content }, resolve, reject)\n    );\n  }\n\n  public async rm(pathOrEntry: string | WebKitEntry) {\n    return new Promise((resolve, reject) =>\n      this.filer.rm(pathOrEntry, resolve, reject)\n    );\n  }\n\n  public async rmRoot() {\n    const entries = await this.ls(\"/\");\n    return Promise.all(entries.map(entry => this.rm(entry.fullPath)));\n  }\n\n  public async download(pathOrEntry: string | WebKitEntry) {\n    let entries;\n    try {\n      entries = await this.ls(pathOrEntry);\n    } catch (e) {\n      return this.downloadFile(pathOrEntry);\n    }\n    return this.downloadDirectory(entries);\n  }\n\n  private async downloadFile(pathOrEntry: string | WebKitEntry) {\n    const fileName =\n      typeof pathOrEntry === \"string\" ? pathOrEntry : pathOrEntry.fullPath;\n\n    const content = await this.openAndGetContentAsUint8Array(pathOrEntry);\n    this.doDownload(fileName, content);\n  }\n\n  private async downloadDirectory(entries: WebKitEntry[]) {\n    const zip = new JSZip();\n\n    const addToZip = async (entries: WebKitEntry[]) =>\n      Promise.all(\n        entries.map(async entry => {\n          console.log(entry.fullPath);\n          if (entry.isFile) {\n            zip.file(entry.fullPath, this.openAndGetContentAsUint8Array(entry));\n          } else {\n            const subEntries = await this.ls(entry);\n            await addToZip(subEntries);\n          }\n        })\n      );\n    await addToZip(entries);\n\n    const zipContent = await zip.generateAsync({ type: \"uint8array\" });\n    this.doDownload(\"data.zip\", zipContent);\n  }\n\n  private doDownload(fileName: string, content: Uint8Array) {\n    const blob = new Blob([content], { type: \"application/zip\" });\n    const element = document.createElement(\"a\");\n    element.href = window.URL.createObjectURL(blob);\n    element.download = fileName;\n    element.click();\n  }\n}\n","import { Castle } from \"./castle\";\nimport { City } from \"./city\";\nimport { Island } from \"./island\";\nimport { Kontor } from \"./kontor\";\nimport { Player } from \"./player\";\nimport { Producer } from \"./producer\";\nimport { Ship } from \"./ship\";\nimport { Soldier } from \"./soldier\";\nimport { Task } from \"./task\";\nimport { Timers } from \"./timers\";\nimport { Trader } from \"./trader\";\n\nexport type Rotation4 = 0 | 1 | 2 | 3;\n\nexport type Rotation8 = 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7;\n\nexport enum SimulationSpeed {\n  Paused = 0,\n  Default = 1,\n  Slow = Default,\n  Medium = 2,\n  Fast = 4,\n  SuperFast = 8\n}\n\nexport default class World {\n  constructor(\n    public readonly islands: Island[],\n    public readonly players: Player[],\n    public readonly tasks: Task[],\n    public readonly gameName: string,\n    public readonly soldiers: Soldier[],\n    public readonly ships: Ship[],\n    public readonly kontors: Kontor[],\n    public readonly castles: Castle[],\n    public readonly cities: City[],\n    public readonly trader: Trader | null,\n    public readonly timers: Timers,\n    public readonly producers: Producer[]\n  ) {\n    console.log(\"Tasks\");\n    console.table(tasks);\n    console.log(\"Game Name\", gameName);\n    console.log(\"Islands\");\n    console.table(islands);\n    console.log(\"Players\");\n    console.table(players);\n    console.log(\"Soldiers\");\n    console.table(soldiers);\n    console.log(\"Ships\");\n    console.table(ships);\n    console.log(\"Kontors\");\n    console.table(kontors);\n    console.log(\"Castles\");\n    console.table(castles);\n    console.log(\"Cities\");\n    console.table(cities);\n    console.log(\"Trader\", trader);\n    console.log(\"Timers\", timers);\n    console.log(\"Producers\");\n    console.table(producers);\n  }\n}\n","/**\n * Based on the MIT-licensed browser-assert NPM package.\n * Copyright (c) 2015 Social Ally\n */\nexport default function assert(expr: any, message?: string) {\n  if (!expr) {\n    throw new Error(message || \"unknown assertion error\");\n  }\n}\n","import { EventEmitter } from \"events\";\nimport { Point } from \"pixi.js\";\nimport assert from \"../util/assert\";\nimport ConfigLoader from \"./config-loader\";\nimport { City } from \"./world/city\";\nimport { Island } from \"./world/island\";\nimport { Kontor } from \"./world/kontor\";\nimport { Player } from \"./world/player\";\nimport { Producer } from \"./world/producer\";\nimport { Ship } from \"./world/ship\";\nimport { Task } from \"./world/task\";\nimport { Timers } from \"./world/timers\";\nimport World, { SimulationSpeed } from \"./world/world\";\n\ninterface MapById<T> {\n  [k: string]: T;\n}\n\nexport const defaultTimers = {\n  simulationSpeed: 0,\n  cntCity: 0,\n  cntIsland: 0,\n  cntShipyard: 0,\n  cntMilitary: 0,\n  cntProduction: 0,\n  cntSettlers: [],\n  cntGrowth: [],\n  timeCity: 0,\n  timeIsland: 0,\n  timeShipyard: 0,\n  timeMilitary: 0,\n  timeProduction: 0,\n  timeGoodToolsCnt: 0,\n  timeGoodToolsMax: 0,\n  timeGame: 0,\n  noErzOutFlg: 0,\n  tutorFlg: 0,\n  aiLevel: 0,\n  missionNumber: 0,\n  gameId: 0,\n  cityNameNumber: 0,\n  timeNextDrought: 0,\n  timePirateSec: 0,\n  missionSubNumber: 0,\n  shipMax: 0,\n  timeNextVulcano: 0,\n  cntVulcano: 0,\n  timeSettlers: [],\n  timeGrowth: [],\n  enableTrader: false,\n  bigIronRunsOut: false,\n  enableDroughts: false,\n  enablePirate: false,\n  enableVulcano: false\n};\n\nexport interface GameState {\n  players: MapById<Player>;\n  islands: MapById<Island>;\n  tasks: MapById<Task>;\n  cities: City[];\n  kontors: Kontor[];\n  producers: Producer[];\n  ships: Ship[];\n  timers: Timers & { simulationSpeed: SimulationSpeed };\n}\n\nexport default class Game extends EventEmitter {\n  public state: GameState;\n  private timerId: number | null;\n\n  constructor(private readonly configLoader: ConfigLoader, world: World) {\n    super();\n    this.state = {\n      players: this.mapArrayById(world.players),\n      islands: this.mapArrayById(world.islands),\n      tasks: this.mapArrayById(world.tasks),\n      cities: world.cities,\n      kontors: world.kontors,\n      producers: world.producers,\n      ships: world.ships,\n      timers: { ...world.timers, simulationSpeed: SimulationSpeed.Paused }\n    };\n  }\n\n  public getFieldAtIsland = (island: Island, islandPos: Point) => {\n    return island.fields[islandPos.x][islandPos.y];\n  };\n\n  public getFieldAt = (globalPos: Point) => {\n    const island = Object.values(this.state.islands).find(each =>\n      each.positionRect.contains(globalPos.x, globalPos.y)\n    );\n    if (!island) {\n      return null;\n    }\n    const islandPos = new Point(\n      globalPos.x - island.position.x,\n      globalPos.y - island.position.y\n    );\n\n    return this.getFieldAtIsland(island, islandPos);\n  };\n\n  public setSimulationSpeed(speed: SimulationSpeed) {\n    this.state.timers.simulationSpeed = speed;\n\n    if (this.timerId) {\n      window.clearInterval(this.timerId);\n    }\n    if (speed !== SimulationSpeed.Paused) {\n      this.timerId = window.setInterval(this.tick, 100 / speed);\n    }\n\n    this.emit(\"simulation-speed\", speed);\n  }\n\n  private mapArrayById<T extends { id: number }>(arr: T[]) {\n    return arr.reduce((objectMap: { [k: string]: T }, obj: T) => {\n      objectMap[obj.id] = obj;\n      return objectMap;\n    }, {});\n  }\n\n  private watchTicksForUpkeep() {\n    const time = this.state.timers.timeGame;\n    if (time % 100 !== 0) {\n      return;\n    }\n\n    console.log(\"upkeep calculation\");\n    const upkeeps = this.calculateUpkeeps();\n    for (const playerId of Object.keys(upkeeps)) {\n      // This is how Anno 1602 does it, see\n      // https://www.annozone.de/Charlie/Cod/numerik.html\n      const upkeep = Math.floor(upkeeps[playerId] / 6);\n      this.addMoney(parseInt(playerId, 10), -upkeep);\n    }\n  }\n\n  private addMoney(playerId: number, money: number) {\n    this.state.players[playerId].money += money;\n    this.emit(\"player/money\", {\n      playerId,\n      money: this.state.players[playerId].money\n    });\n  }\n\n  private watchTicksForProducing() {\n    const time = this.state.timers.timeGame;\n    if (time % 10 !== 0) {\n      return;\n    }\n\n    console.log(\"update producers\");\n    const fieldData = this.configLoader.getFieldData();\n    this.state.producers.forEach((producer, id) => {\n      if (!producer.active) {\n        return [];\n      }\n      const island = this.state.islands[producer.islandId];\n      const buildingId = this.getFieldAtIsland(island, producer.position)!\n        .fieldId;\n      const fieldConfig = fieldData.get(buildingId)!;\n      assert(fieldConfig);\n\n      if (producer.producedGood === 128 && producer.timer === 1) {\n        // We have finished producing!\n        const newStock = producer.stock + 1;\n        const newFirstGoodStock =\n          producer.firstGoodStock - fieldConfig.production.amount1;\n        const newSecondGoodStock =\n          producer.secondGoodStock - fieldConfig.production.amount2;\n        const canProduceEvenMore =\n          newFirstGoodStock >= fieldConfig.production.amount1 &&\n          newSecondGoodStock >= fieldConfig.production.amount2 &&\n          newStock < fieldConfig.production.maxStock;\n\n        this.updateProcuder((id as unknown) as number, {\n          stock: newStock,\n          timer: canProduceEvenMore ? fieldConfig.production.interval : 11,\n          firstGoodStock: newFirstGoodStock,\n          secondGoodStock: newSecondGoodStock,\n          producedGood: canProduceEvenMore ? 128 : 0\n        });\n      } else if (\n        producer.producedGood === 0 &&\n        (producer.timer === 1 || this.state.timers.cntProduction === 0)\n      ) {\n        // We are not currently producing something but should now check\n        // whether we can start producing something new.\n        const canProduce =\n          producer.firstGoodStock >= fieldConfig.production.amount1 &&\n          producer.secondGoodStock >= fieldConfig.production.amount2 &&\n          producer.stock < fieldConfig.production.maxStock;\n        this.updateProcuder((id as unknown) as number, {\n          timer: canProduce\n            ? fieldConfig.production.interval\n            : producer.timer <= 1\n            ? 11\n            : producer.timer - 1,\n          producedGood: canProduce ? 128 : 0\n        });\n      } else {\n        this.updateProcuder((id as unknown) as number, {\n          // The timer never reaches 0.\n          timer: producer.timer <= 1 ? 11 : producer.timer - 1\n        });\n      }\n    });\n  }\n\n  private updateProcuder(producerId: number, patch: Partial<Producer>) {\n    const producer = this.state.producers[producerId];\n    Object.assign(producer, patch);\n\n    this.emit(\"producer/updated\", { producerId });\n    if (patch.stock !== undefined) {\n      this.emit(\"producer/good-produced\", {\n        island: this.state.islands[producer.islandId],\n        position: producer.position,\n        stock: producer.stock\n      });\n    }\n  }\n\n  private calculateUpkeeps() {\n    const upkeeps: Record<string, number> = Object.keys(\n      this.state.players\n    ).reduce((obj: Record<string, number>, id: string) => {\n      obj[id] = 0;\n      return obj;\n    }, {});\n\n    Object.values(this.state.producers).forEach(producer => {\n      const island = this.state.islands[producer.islandId];\n      const field = island.fields[producer.position.x][producer.position.y]!;\n      const buildingId = field.fieldId;\n      const playerId = field.playerId;\n      assert(buildingId !== 0xffff);\n      assert(playerId < 7);\n      const fieldConfig = this.configLoader.getFieldData().get(buildingId)!;\n      assert(fieldConfig);\n\n      upkeeps[playerId] +=\n        fieldConfig.production.upkeep[producer.active ? \"active\" : \"inactive\"];\n    }, this);\n\n    return upkeeps;\n  }\n\n  private tick = () => {\n    this.state.timers.timeGame++;\n    this.state.timers.cntCity = this.inc(this.state.timers.cntCity, 8, 100);\n    this.state.timers.cntIsland = this.inc(this.state.timers.cntIsland, 8, 100);\n    this.state.timers.cntShipyard = this.inc(\n      this.state.timers.cntShipyard,\n      8,\n      10\n    );\n    this.state.timers.cntMilitary = this.inc(\n      this.state.timers.cntMilitary,\n      8,\n      10\n    );\n    this.state.timers.cntProduction = this.inc(\n      this.state.timers.cntProduction,\n      8,\n      10\n    );\n\n    this.watchTicksForUpkeep();\n    this.watchTicksForProducing();\n    this.emit(\"tick\");\n  };\n\n  private inc = (value: number, max: number, interval: number) => {\n    const gameTime = this.state.timers.timeGame;\n    if (gameTime % interval !== 0) {\n      return value;\n    }\n    value++;\n    if (value >= max) {\n      value = 0;\n    }\n    return value;\n  };\n}\n","import { Container } from \"pixi.js\";\nimport IslandSpriteLoader from \"./island-sprite-loader\";\nimport { Island } from \"./world/island\";\n\nexport const TILE_WIDTH = 64;\n\nexport const TILE_HEIGHT = 32;\n\nexport const LAND_OFFSET = -20;\n\nexport default class IslandRenderer {\n  constructor(\n    private world: Container,\n    private spriteLoader: IslandSpriteLoader\n  ) {}\n\n  public render = async (islands: Island[]) => {\n    const islandSprites = await Promise.all(\n      islands.map(island => this.spriteLoader.getIslandSprites(island))\n    );\n    console.log(\"Map sprites loaded.\");\n\n    islandSprites.forEach(spritesOfIsland =>\n      spritesOfIsland.sprites.forEach(row =>\n        row\n          .filter(sprite => sprite !== null)\n          .forEach(sprite => this.world.addChild(sprite!.sprite))\n      )\n    );\n    console.log(\"Map sprites drawn.\");\n\n    return islandSprites;\n  };\n}\n","import { Viewport } from \"pixi-viewport\";\nimport { Graphics } from \"pixi.js\";\nimport assert from \"../../../util/assert\";\nimport { assertNever } from \"../../../util/util\";\nimport AnimationRenderer, { MyAnimation } from \"../../animation-renderer\";\nimport GameRenderer from \"../../game-renderer\";\nimport { TILE_HEIGHT, TILE_WIDTH } from \"../../island-renderer\";\nimport { Ship } from \"../../world/ship\";\n\nexport class RenderedShip {\n  private animation: MyAnimation;\n  private bugAnimation: MyAnimation;\n  private whiteFlag: MyAnimation;\n  private flag: MyAnimation;\n  private hp: Graphics;\n\n  private readonly HP_WIDTH = 38;\n  private readonly HP_HEIGHT = 7;\n\n  constructor(public readonly id: number, private readonly isTrader: boolean) {}\n\n  public async begin(ship: Ship, animationRenderer: AnimationRenderer) {\n    this.animation = await animationRenderer.getShipAnimation(ship);\n\n    assert(this.animation.config.Bugfignr);\n    this.bugAnimation = await animationRenderer.getAnimation(\n      this.animation.config.Bugfignr\n    );\n\n    this.whiteFlag = await animationRenderer.getAnimation(\"FAHNEWEISS\");\n    if (!this.isTrader) {\n      const flagAnimationName = `FAHNE${\n        ship.playerId === 5 ? \"PIRAT\" : ship.playerId + 1\n      }`;\n      this.flag = await animationRenderer.getAnimation(flagAnimationName);\n      this.hp = new Graphics();\n\n      this.hp.beginFill(0x00ff00);\n      this.hp.drawRect(0, 0, this.HP_WIDTH, this.HP_HEIGHT);\n    }\n  }\n\n  // TODO: Animations are added to the viewport multiple times if this is called multiple times.\n  public render(ship: Ship, viewport: Viewport) {\n    const { rotation } = ship;\n    const { x, y } = GameRenderer.fieldPosToWorldPos(ship.position);\n    const { main } = this.animation.animations[0].rotations[rotation];\n\n    const offsetX = -Math.floor(main.width / 2) + TILE_WIDTH / 2;\n    const offsetY = this.animation.config.Posoffs[0] + 18; // TODO: Where does the 18 come from?\n\n    const mainX = x + offsetX;\n    const mainY = y + offsetY;\n\n    // We can't simply use Math.floor, since Math.floor(-1.5) === -2.\n    // However, what we want is -1.\n    const floor = (n: number) => {\n      return Math.sign(n) * Math.floor(Math.abs(n));\n    };\n\n    // TODO: We should also use Fahnoffs[0]. However, this is not that big\n    // of an issue, since all ships have Fahnoffs[0] = 0.\n    const Fahnoffs = this.animation.config.Fahnoffs;\n\n    let flagOffsetX = x + TILE_WIDTH / 2;\n    switch (rotation) {\n      case 0:\n      case 2:\n        flagOffsetX += floor((Fahnoffs[1] * TILE_WIDTH) / 2);\n        break;\n      case 4:\n      case 6:\n        flagOffsetX += -floor((Fahnoffs[1] * TILE_WIDTH) / 2);\n        break;\n      case 1:\n        flagOffsetX += floor((Fahnoffs[1] * TILE_WIDTH * Math.SQRT2) / 2);\n        break;\n      case 5:\n        flagOffsetX += -floor((Fahnoffs[1] * TILE_WIDTH * Math.SQRT2) / 2);\n        break;\n      case 3:\n      case 7:\n        flagOffsetX += 0;\n        break;\n      default:\n        assertNever(rotation);\n    }\n\n    let flagOffsetY = y + 48;\n    switch (rotation) {\n      case 2:\n      case 4:\n        flagOffsetY += floor((Fahnoffs[1] * TILE_HEIGHT) / 2);\n        break;\n      case 0:\n      case 6:\n        flagOffsetY += -floor((Fahnoffs[1] * TILE_HEIGHT) / 2);\n        break;\n      case 3:\n        flagOffsetY += floor((Fahnoffs[1] * TILE_HEIGHT * Math.SQRT2) / 2);\n        break;\n      case 7:\n        flagOffsetY += -floor((Fahnoffs[1] * TILE_HEIGHT * Math.SQRT2) / 2);\n        break;\n      case 1:\n      case 5:\n        flagOffsetY += 0;\n        break;\n      default:\n        assertNever(rotation);\n    }\n\n    if (this.animation.config.Bugfignr) {\n      const waveSprite = this.bugAnimation.animations[0].rotations[rotation]\n        .main;\n      waveSprite.x = flagOffsetX - Math.floor(waveSprite.width / 2);\n      waveSprite.y = flagOffsetY - 30;\n      viewport.addChild(waveSprite);\n      waveSprite.play();\n    }\n\n    main.x = mainX;\n    main.y = mainY;\n    viewport.addChild(main);\n    main.play();\n\n    if (this.isTrader) {\n      // No flag or hp for the trader\n      return;\n    }\n\n    // TODO: Support for white flag\n    const flagAnimation = this.flag.animations[0].rotations[0].main;\n\n    const flagX = flagOffsetX - Math.floor(flagAnimation.width / 2);\n    const flagY = flagOffsetY - Math.floor(Fahnoffs[2] * TILE_HEIGHT);\n\n    flagAnimation.x = flagX;\n    flagAnimation.y = flagY;\n    viewport.addChild(flagAnimation);\n    flagAnimation.play();\n\n    // TODO: Check color and make it red if you lose hp\n\n    const hpX = x + TILE_WIDTH / 2 - this.HP_WIDTH / 2;\n    const hpY = flagY - flagAnimation.height - this.HP_HEIGHT;\n    this.hp.position.set(hpX, hpY);\n    viewport.addChild(this.hp);\n  }\n}\n","/*\n * The savegame data structure was reverse-engineered by Benedikt Freisen\n * as part of the 'mdcii-engine' project and released under GPLv2+.\n * https://github.com/roybaer/mdcii-engine\n */\n\nimport { Point } from \"pixi.js\";\nimport Stream from \"../../parsers/stream\";\nimport assert from \"../../util/assert\";\n\nexport enum CourseState {\n  Stopped = 0x00,\n  Sailing = 55,\n  Unknown = 53,\n  Unknown2 = 52,\n  Unknown3 = 54,\n  Unknown4 = 51\n}\n\nexport class ShipCourse {\n  public static fromSaveGame(data: Stream) {\n    const num = data.read32();\n    const byte1 = (num >> 0) & 0xff;\n    const byte2 = (num >> 8) & 0xff;\n    const byte3 = (num >> 16) & 0xff;\n    const byte4 = (num >> 24) & 0xff;\n\n    const state: CourseState = byte1;\n    assert(state in CourseState);\n\n    const position = new Point(\n      byte4 + ((byte2 & 0b00001111) << 8),\n      byte3 + ((byte2 & 0b11110000) << 4)\n    );\n\n    return new ShipCourse(position, state);\n  }\n\n  constructor(\n    public readonly position: Point,\n    public readonly state: CourseState\n  ) {}\n}\n","/*\n * The savegame data structure was reverse-engineered by Benedikt Freisen\n * as part of the 'mdcii-engine' project and released under GPLv2+.\n * https://github.com/roybaer/mdcii-engine\n */\n\nimport { Point } from \"pixi.js\";\nimport Stream from \"../../parsers/stream\";\nimport { ShipCourse } from \"./ship-course\";\nimport { Rotation8 } from \"./world\";\n\n/**\n * # Animation Notes\n *\n * There are the following flags:\n * FAHNE1, FAHNE2, FAHNE3, FAHNE4 and FAHNEWEISS\n *\n * and these ships:\n * HANDEL1, HANDEL2, HANDELD1, HANDELD2\n * KRIEG1, KRIEG2, KRIEGD1, KRIEGD2\n *\n * HANDLER, HANDLERD\n * PIRAT, PIRATD\n *\n */\n\nexport interface ShipGood {\n  good_id: number;\n  amount: number;\n  action: number;\n}\n\nexport interface ShipTradeStop {\n  id: number;\n  kontor_id: number;\n  _1: number;\n  goods: ShipGood[];\n  _2: number[];\n}\n\nexport type Ship = ReturnType<typeof shipFromSaveGame>;\n\nexport const SHIP_TYPES: Record<number, string> = {\n  0x15: \"HANDEL1\",\n  0x17: \"HANDEL2\",\n  0x19: \"KRIEG1\",\n  0x1b: \"KRIEG2\",\n  0x1d: \"HANDLER\", // This is the trade ship\n  0x1f: \"PIRAT\",\n  0x25: \"TRADER1\" // This is the guy that walks around islands.\n};\n\nexport function shipFromSaveGame(data: Stream) {\n  const name = data.readString(28);\n  const position = new Point(data.read16(), data.read16());\n  const _1 = data.read(3 * 4);\n\n  const courseFrom = ShipCourse.fromSaveGame(data);\n  const courseTo = ShipCourse.fromSaveGame(data);\n  const courseCurrent = ShipCourse.fromSaveGame(data);\n\n  const _2 = data.read32();\n  const hp = data.read16();\n  const _3 = data.read32();\n  const canons = data.read8();\n  const flags = data.read8();\n  const sellingPrice = data.read16();\n  const id = data.read16();\n  const type = data.read16();\n  const kind = data.read8(); // ?\n  const playerId = data.read8();\n  const _5 = data.read32();\n  const rotation = data.read16() as Rotation8;\n  const tradeStops = parseShipTradeStops(data, 8);\n  const _6 = data.read16();\n  const cargo = parseShipGoods(data, 8);\n\n  return {\n    id,\n    type,\n    kind,\n    playerId,\n    position,\n    rotation,\n    name,\n    hp,\n    tradeStops,\n    cargo\n  };\n}\n\nfunction parseShipTradeStops(data: Stream, n: number): ShipTradeStop[] {\n  const tradeStops = [];\n  for (let i = 0; i < n; i++) {\n    tradeStops.push({\n      id: data.read8(),\n      kontor_id: data.read8(),\n      _1: data.read16(),\n      goods: parseShipGoods(data, 2),\n      _2: data.read(16)\n    });\n  }\n  return tradeStops;\n}\n\nfunction parseShipGoods(data: Stream, n: number): ShipGood[] {\n  const cargo = [];\n  for (let i = 0; i < n; i++) {\n    cargo.push({\n      good_id: data.read16(),\n      amount: data.read16(),\n      action: data.read32() // 0 == 'load', 1 == 'unload'\n    });\n  }\n  return cargo;\n}\n","import { Point, Rectangle } from \"pixi.js\";\n\nexport const isWithinRadius = (\n  building: Rectangle,\n  radius: number,\n  point: Point\n) => {\n  const center = new Point(\n    building.x + building.width / 2,\n    building.y + building.height / 2\n  );\n\n  return (\n    (Math.abs(point.x + 0.5 - center.x) +\n      (building.width % 2 === 0 ? 0 : 0.5)) **\n      2 +\n      (Math.abs(point.y + 0.5 - center.y) +\n        (building.height % 2 === 0 ? 0 : 0.5)) **\n        2 <\n    Math.ceil((radius + 1.05) ** 2)\n  );\n};\n","import { Key, KeyboardManager, Keys } from \"pixi-keyboard\";\nimport { Viewport } from \"pixi-viewport\";\nimport {\n  Application,\n  Container,\n  Graphics,\n  interaction,\n  Point,\n  Sprite,\n  Text,\n  Texture,\n  Rectangle\n} from \"pixi.js\";\nimport { from, fromEvent, merge } from \"rxjs\";\nimport { auditTime } from \"rxjs/operators\";\nimport { make2DArray } from \"../util/util\";\nimport AnimationRenderer from \"./animation-renderer\";\nimport ConfigLoader from \"./config-loader\";\nimport Game from \"./game\";\nimport { LAND_OFFSET, TILE_HEIGHT, TILE_WIDTH } from \"./island-renderer\";\nimport IslandSpriteLoader from \"./island-sprite-loader\";\nimport { RenderedShip } from \"./renderer/isometric/renderered-ship\";\nimport { Island } from \"./world/island\";\nimport { SHIP_TYPES } from \"./world/ship\";\nimport { SimulationSpeed } from \"./world/world\";\nimport { isWithinRadius } from \"./radius\";\n\nexport default class GameRenderer {\n  public static fieldPosToWorldPos(fieldPos: Point) {\n    const xx = fieldPos.x;\n    const yy = fieldPos.y;\n    const worldX = (xx - yy) * (TILE_WIDTH / 2);\n    const worldY = (xx + yy) * (TILE_HEIGHT / 2);\n    return new Point(worldX, worldY);\n  }\n\n  public static landFieldPosToWorldPos(fieldPos: Point) {\n    const result = this.fieldPosToWorldPos(fieldPos);\n    result.y += LAND_OFFSET;\n    return result;\n  }\n\n  /**\n   * Converts PIXI world coordinates to isometric coordinates.\n   * Please note that these are *sea-level* coordinates. Use\n   * worldPosToFieldPosLand for *land-level* coordinates.\n   */\n  public static worldPosToFieldPos(worldPos: Point) {\n    const x =\n      (worldPos.x / (TILE_WIDTH / 2) + worldPos.y / (TILE_HEIGHT / 2)) / 2;\n    const y =\n      (worldPos.y / (TILE_HEIGHT / 2) - worldPos.x / (TILE_WIDTH / 2)) / 2;\n\n    return new Point(Math.round(x), Math.round(y) + 1);\n  }\n\n  public static worldPosToFieldPosLand(worldPos: Point) {\n    const adjustedWorldPos = new Point();\n    adjustedWorldPos.copyFrom(worldPos);\n    adjustedWorldPos.y -= LAND_OFFSET;\n\n    return this.worldPosToFieldPos(adjustedWorldPos);\n  }\n\n  private money: Text;\n  private simulationSpeedDisplay: Text;\n  private readonly WIDTH = 500;\n  private readonly HEIGHT = 350;\n  private fields: Array<Array<Sprite | null>>;\n  private readonly keyboardManager: KeyboardManager;\n\n  constructor(\n    private readonly game: Game,\n    private readonly islandSpriteLoader: IslandSpriteLoader,\n    private readonly app: Application,\n    private readonly viewport: Viewport,\n    private readonly configLoader: ConfigLoader,\n    private readonly animationRenderer: AnimationRenderer,\n    private readonly myPlayerId: number\n  ) {\n    this.keyboardManager = new KeyboardManager();\n    this.setupHotKeys();\n\n    this.money = new Text(\"\", {\n      fontFamily: \"Arial\",\n      fontSize: 24,\n      fill: 0xff1010\n    });\n    this.money.y = 0 * 30;\n    this.simulationSpeedDisplay = new Text(\"\", {\n      fontFamily: \"Arial\",\n      fontSize: 24,\n      fill: 0xff1010\n    });\n    this.simulationSpeedDisplay.y = 5 * 30;\n  }\n\n  public async begin() {\n    this.keyboardManager.enable();\n    this.app.ticker.add(() => {\n      // Necessary to update key down state used for moving around.\n      this.keyboardManager.update();\n    });\n\n    this.viewport.removeChildren();\n    this.debugControls();\n\n    const dbg = (xx: number, yy: number, w: number = 5, h: number = 5) => {\n      const rect = new Graphics();\n      rect.position.set(xx, yy);\n      rect.beginFill(0x00ff00);\n      rect.drawRect(0, 0, w, h);\n      this.viewport.addChild(rect);\n    };\n\n    // Render islands\n    const spritesPerIsland = await Promise.all(\n      Object.values(this.game.state.islands).map(island =>\n        this.islandSpriteLoader.getIslandSprites(island)\n      )\n    );\n    console.log(\"Map sprites loaded.\");\n\n    spritesPerIsland.forEach(spritesOfIsland => {\n      spritesOfIsland.sprites.forEach(row =>\n        row\n          .filter(sprite => sprite !== null)\n          .forEach(sprite => this.viewport.addChild(sprite!.sprite))\n      );\n      spritesOfIsland.smokeSprites.forEach(smokeSprite => {\n        this.viewport.addChild(smokeSprite);\n        smokeSprite.play();\n        dbg(smokeSprite.x, smokeSprite.y, 3, 3);\n      });\n    });\n    console.log(\"Map sprites drawn.\");\n\n    const fields = make2DArray<Sprite>(this.WIDTH, this.HEIGHT);\n    spritesPerIsland.forEach(spritesOfIsland =>\n      spritesOfIsland.sprites.forEach(row =>\n        row\n          .filter(sprite => sprite !== null)\n          .forEach(\n            sprite =>\n              (fields[sprite!.mapPosition.x][\n                sprite!.mapPosition.y\n              ] = sprite!.sprite)\n          )\n      )\n    );\n\n    // TODO: Hack to find the water texture.\n    let waterTexture: Texture | null = null;\n    for (let x = 0; x < this.WIDTH && !waterTexture; x++) {\n      for (let y = 0; y < this.HEIGHT; y++) {\n        if (fields[x][y]) {\n          waterTexture = fields[x][y]!.texture;\n          break;\n        }\n      }\n    }\n\n    // Fill in water between islands\n    fields.forEach((row, x) =>\n      row.forEach((field, y) => {\n        if (field === null) {\n          // TODO: This should be an animated sprite.\n          const sprite = new Sprite(waterTexture!);\n\n          const { x: worldX, y: worldY } = GameRenderer.fieldPosToWorldPos(\n            new Point(x, y)\n          );\n          // Set bottom left corner of sprite as origin.\n          sprite.anchor.set(0, 1);\n          sprite.x = worldX;\n          sprite.y = worldY;\n\n          fields[x][y] = sprite;\n          this.viewport.addChild(sprite);\n        }\n      })\n    );\n    this.fields = fields;\n\n    // Render ships\n    // ...\n\n    // Render soldiers\n    // ...\n\n    this.moveCameraToStartPosition(this.myPlayerId);\n\n    const renderedShips = this.game.state.ships\n      // TODO: We ignore the land trader for now\n      .filter(ship => SHIP_TYPES[ship.type] !== \"TRADER1\")\n      .map(ship => new RenderedShip(ship.id, ship.playerId === 4));\n\n    await Promise.all(\n      this.game.state.ships\n        .filter(ship => SHIP_TYPES[ship.type] !== \"TRADER1\")\n        .map(ship =>\n          renderedShips\n            .find(each => each.id === ship.id)!\n            .begin(ship, this.animationRenderer)\n        )\n    );\n    this.game.state.ships\n      .filter(ship => SHIP_TYPES[ship.type] !== \"TRADER1\")\n      .forEach(ship => {\n        renderedShips\n          .find(each => each.id === ship.id)!\n          .render(ship, this.viewport);\n      });\n\n    merge(\n      from([\"initial\"]),\n      fromEvent(this.viewport, \"zoomed\"),\n      fromEvent(this.viewport, \"moved\")\n    )\n      .pipe(auditTime(200))\n      .subscribe(this.cull);\n\n    this.game.addListener(\"player/money\", ({ playerId, money }) => {\n      if (playerId === this.myPlayerId) {\n        this.setMoney(money);\n      }\n    });\n    this.game.addListener(\n      \"producer/good-produced\",\n      ({ island, position, stock }) => {\n        this.onProduced(island, position, stock);\n      }\n    );\n    this.game.addListener(\n      \"simulation-speed\",\n      speed => (this.simulationSpeedDisplay.text = `Simulation speed: ${speed}`)\n    );\n\n    const highlightField = (\n      annoX: number,\n      annoY: number,\n      color: number = 0xff0000\n    ) => {\n      let { x, y } = GameRenderer.landFieldPosToWorldPos(\n        new Point(annoX, annoY)\n      );\n      x += TILE_WIDTH / 2;\n      y -= TILE_HEIGHT;\n      const tmp = new Graphics();\n      tmp.beginFill(color);\n      tmp.alpha = 0.2;\n      tmp.visible = this.showRadiusOfAllBuildings;\n      tmp.drawPolygon([\n        new Point(x, y),\n        new Point(x + TILE_WIDTH / 2, y + TILE_HEIGHT / 2),\n        new Point(x, y + TILE_HEIGHT),\n        new Point(x - TILE_WIDTH / 2, y + TILE_HEIGHT / 2)\n      ]);\n      this.radiusSprites.push(tmp);\n      this.viewport.addChild(tmp);\n    };\n\n    this.game.state.producers.forEach(producer => {\n      const island = this.game.state.islands[producer.islandId];\n\n      const base = new Point(\n        island.position.x + producer.position.x,\n        island.position.y + producer.position.y\n      );\n      const fieldData = this.game.getFieldAtIsland(island, producer.position)!;\n      const fieldConfig = this.configLoader\n        .getFieldData()\n        .get(fieldData.fieldId)!;\n      const size = fieldConfig.size;\n      const actualSizeX = fieldData.rotation % 2 === 0 ? size.x : size.y;\n      const actualSizeY = fieldData.rotation % 2 === 0 ? size.y : size.x;\n      const radius = fieldConfig.production.radius;\n\n      for (let x = 0; x < actualSizeX; x++) {\n        for (let y = 0; y < actualSizeY; y++) {\n          highlightField(base.x + x, base.y + y);\n        }\n      }\n\n      const buildingRectangle = new Rectangle(\n        base.x,\n        base.y,\n        actualSizeX,\n        actualSizeY\n      );\n      for (let x = -20; x < 20; x++) {\n        for (let y = -20; y < 20; y++) {\n          if (\n            isWithinRadius(\n              buildingRectangle,\n              radius,\n              new Point(base.x + x, base.y + y)\n            )\n          ) {\n            highlightField(base.x + x, base.y + y, 0xffff00);\n          }\n        }\n      }\n    });\n  }\n\n  private setupHotKeys() {\n    const showTaskKey = Key.F1;\n    this.keyboardManager.onKeyPressedWithPreventDefault(showTaskKey, () => {\n      const player = this.game.state.players[this.myPlayerId];\n      const assignedTask = this.game.state.tasks[player.assignedTaskId];\n      if (assignedTask !== undefined) {\n        console.info(assignedTask.text);\n      } else {\n        console.info(\"It appears like you have no task :/\");\n      }\n    });\n\n    const zoomKeys: Array<{ key: number; zoom: 1 | 2 | 3 }> = [\n      { key: Key.F2, zoom: 1 },\n      { key: Key.F3, zoom: 2 },\n      { key: Key.F4, zoom: 3 }\n    ];\n    for (const zoomKey of zoomKeys) {\n      this.keyboardManager.onKeyPressedWithPreventDefault(zoomKey.key, () =>\n        this.zoom(zoomKey.zoom)\n      );\n    }\n\n    const speedKeys = [\n      { keys: [Key.PAUSE], speed: SimulationSpeed.Paused },\n      { keys: [Key.F5], speed: SimulationSpeed.Slow },\n      { keys: [Key.F6], speed: SimulationSpeed.Medium },\n      { keys: [Key.F7], speed: SimulationSpeed.Fast },\n      { keys: [Key.SHIFT, Key.F8], speed: SimulationSpeed.SuperFast }\n    ];\n    for (const speedKey of speedKeys) {\n      this.keyboardManager.onKeysPressedWithPreventDefault(speedKey.keys, () =>\n        this.game.setSimulationSpeed(speedKey.speed)\n      );\n    }\n\n    const SCROLL_SPEED = 50;\n    [Key.LEFT, Key.RIGHT, Key.UP, Key.DOWN].forEach(key =>\n      this.keyboardManager.setPreventDefault(key)\n    );\n    this.keyboardManager.on(\"down\", (key: Keys) => {\n      console.log(\"key down\", key);\n      switch (key) {\n        case Key.LEFT:\n          this.viewport.moveCorner(\n            this.viewport.corner.x - SCROLL_SPEED,\n            this.viewport.corner.y\n          );\n          this.cull();\n          break;\n        case Key.RIGHT:\n          this.viewport.moveCorner(\n            this.viewport.corner.x + SCROLL_SPEED,\n            this.viewport.corner.y\n          );\n          this.cull();\n          break;\n        case Key.UP:\n          this.viewport.moveCorner(\n            this.viewport.corner.x,\n            this.viewport.corner.y - SCROLL_SPEED\n          );\n          this.cull();\n          break;\n        case Key.DOWN:\n          this.viewport.moveCorner(\n            this.viewport.corner.x,\n            this.viewport.corner.y + SCROLL_SPEED\n          );\n          this.cull();\n          break;\n        default:\n          break;\n      }\n    });\n\n    // TODO: Temporary and for debugging only\n    this.keyboardManager.onKeyPressedWithPreventDefault(Key.R, () => {\n      this.toggleShowRadiusOfAllBuildings();\n    });\n  }\n\n  private showRadiusOfAllBuildings = false;\n  private radiusSprites: Container[] = [];\n  private toggleShowRadiusOfAllBuildings() {\n    this.showRadiusOfAllBuildings = !this.showRadiusOfAllBuildings;\n    this.radiusSprites.forEach(\n      each => (each.visible = this.showRadiusOfAllBuildings)\n    );\n  }\n\n  private zoom(zoom: 1 | 2 | 3) {\n    const center = this.viewport.center;\n    this.viewport.scale.set(1.0 / zoom);\n    this.viewport.moveCenter(center.x, center.y);\n    this.cull();\n  }\n\n  // public onMove(listener: (viewport: Viewport) => void) {\n  //     new Observable<Viewport>((observer) => {\n  //         this.viewport.on(\"moved\", (viewport) => observer.next(viewport));\n  //     }).pipe(\n  //         debounceTime(1000),\n  //     ).subscribe(listener);\n  // }\n\n  private setMoney = (money: number) => {\n    this.money.text = `Money: ${money}`;\n  };\n\n  private onProduced(island: Island, position: Point, stock: number) {\n    console.log(\n      `Producer at island ${island.id} (${position.x}, ${position.y}) has now stock: ${stock}.`\n    );\n    // TODO: This uses the wrong color, position, font and timings.\n    const text = new Text(`Stock: ${stock}`, {\n      fontFamily: \"Arial\",\n      fontSize: 24,\n      fill: 0xff1010\n    });\n\n    const pos = GameRenderer.fieldPosToWorldPos(\n      new Point(island.position.x + position.x, island.position.y + position.y)\n    );\n    text.position.set(pos.x, pos.y);\n    this.viewport.addChild(text);\n\n    const duration = 2000;\n    const startTime = this.app.ticker.lastTime;\n    const fn = () => {\n      text.position.y =\n        text.position.y - (this.app.ticker.deltaMS * 100) / duration;\n      if (this.app.ticker.lastTime - startTime > duration) {\n        this.app.ticker.remove(fn);\n        this.viewport.removeChild(text);\n      }\n    };\n    this.app.ticker.add(fn);\n  }\n\n  private cull = () => {\n    const viewportBounds = this.viewport.getVisibleBounds();\n\n    const topLeft = GameRenderer.worldPosToFieldPos(\n      new Point(viewportBounds.x - TILE_WIDTH, viewportBounds.y - TILE_HEIGHT)\n    );\n    const bottomRight = GameRenderer.worldPosToFieldPos(\n      new Point(\n        viewportBounds.x + viewportBounds.width + TILE_WIDTH,\n        // we need to add the height of the highest sprite in the game, so\n        // that it is still drawn even if it is below the viewport.\n        // TODO: Verify that 200 fits.\n        viewportBounds.y + viewportBounds.height + TILE_HEIGHT + 200\n      )\n    );\n\n    for (let x = 0; x < this.WIDTH; x++) {\n      for (let y = 0; y < this.HEIGHT; y++) {\n        const field = this.fields[x][y];\n        if (!field) {\n          continue;\n        }\n        field.visible =\n          x + y >= topLeft.x + topLeft.y &&\n          x - y >= topLeft.x - topLeft.y &&\n          x + y <= bottomRight.x + bottomRight.y &&\n          x - y <= bottomRight.x - bottomRight.y;\n      }\n    }\n  };\n\n  private debugControls() {\n    const debugContainer = new Container();\n\n    debugContainer.addChild(this.money);\n    const coordinates = new Text(\"\", {\n      fontFamily: \"Arial\",\n      fontSize: 24,\n      fill: 0xff1010\n    });\n    coordinates.y = 1 * 30;\n    debugContainer.addChild(coordinates);\n\n    const islandNumber = new Text(\"\", {\n      fontFamily: \"Arial\",\n      fontSize: 24,\n      fill: 0xff1010\n    });\n    islandNumber.y = 2 * 30;\n    debugContainer.addChild(islandNumber);\n\n    const producerInfo = new Text(\"\", {\n      fontFamily: \"Arial\",\n      fontSize: 24,\n      fill: 0xff1010\n    });\n    producerInfo.y = 3 * 30;\n    debugContainer.addChild(producerInfo);\n\n    debugContainer.addChild(this.simulationSpeedDisplay);\n\n    const interactionManager: interaction.InteractionManager = this.app.renderer\n      .plugins.interaction;\n\n    const updatePosition = () => {\n      const pos = GameRenderer.worldPosToFieldPosLand(\n        this.viewport.toWorld(interactionManager.mouse.global)\n      );\n      coordinates.text = `x: ${pos.x}, y: ${pos.y}`;\n\n      const island = Object.values(this.game.state.islands).find(each => {\n        return each.positionRect.contains(pos.x, pos.y);\n      });\n\n      if (island) {\n        const localPosition = new Point(\n          pos.x - island.position.x,\n          pos.y - island.position.y\n        );\n\n        islandNumber.text = `Island id: ${island.id}, x: ${localPosition.x} y: ${localPosition.y}`;\n\n        const producer = this.game.state.producers.find(\n          each =>\n            each.islandId === island.id &&\n            each.position.x === localPosition.x &&\n            each.position.y === localPosition.y\n        );\n        if (producer) {\n          const fieldData = this.game.getFieldAtIsland(\n            island,\n            producer.position\n          )!;\n          const fieldConfig = this.configLoader\n            .getFieldData()\n            .get(fieldData.fieldId)!;\n\n          producerInfo.text = `Producer: Stock: ${producer.stock} (max: ${fieldConfig.production.maxStock}, good: ${fieldConfig.production.good}), Good A: ${producer.firstGoodStock} (required: ${fieldConfig.production.amount1}, good: ${fieldConfig.production.good1}), Good B: ${producer.secondGoodStock} (required: ${fieldConfig.production.amount2}, good: ${fieldConfig.production.good2}),\\n Active: ${producer.active}, Timer: ${producer.timer}, Rotation: ${fieldData.rotation}`;\n        } else {\n          producerInfo.text = \"No Producer\";\n        }\n      } else {\n        islandNumber.text = `Island id: ?`;\n      }\n    };\n    updatePosition();\n    this.viewport.on(\"moved\", updatePosition);\n    this.viewport.on(\"wheel-scroll\", updatePosition);\n    interactionManager.on(\"pointermove\", updatePosition);\n\n    this.viewport.parent.addChild(debugContainer);\n  }\n\n  private moveCameraToStartPosition(myPlayerId: number) {\n    const myKontor = this.game.state.kontors.find(\n      kontor => kontor.playerId === myPlayerId\n    );\n    if (myKontor !== undefined) {\n      const position = myKontor.position;\n      const kontorIsland = Object.values(this.game.state.islands).find(\n        island => island.id === myKontor.islandId\n      )!;\n      this.moveTo(\n        new Point(\n          kontorIsland.position.x + position.x,\n          kontorIsland.position.y + position.y\n        )\n      );\n      return;\n    }\n    const myShip = this.game.state.ships.find(\n      ship => ship.playerId === myPlayerId\n    );\n    if (myShip !== undefined) {\n      this.moveTo(myShip.position);\n      return;\n    }\n    this.moveTo(new Point(500 / 2, 300 / 2));\n  }\n\n  private moveTo(point: Point) {\n    this.viewport.moveCenter(GameRenderer.fieldPosToWorldPos(point));\n  }\n}\n","import { Viewport } from \"pixi-viewport\";\nimport { Application } from \"pixi.js\";\nimport FileSystem from \"./filesystem\";\nimport AnimationRenderer from \"./game/animation-renderer\";\nimport ConfigLoader from \"./game/config-loader\";\nimport Game from \"./game/game\";\nimport GameRenderer from \"./game/game-renderer\";\nimport IslandSpriteLoader from \"./game/island-sprite-loader\";\nimport MusicPlayer from \"./game/music-player\";\nimport { SimulationSpeed } from \"./game/world/world\";\nimport GAMParser from \"./parsers/GAM/gam-parser\";\n\nexport default class GameLoader {\n  constructor(\n    private readonly fs: FileSystem,\n    private readonly gamParser: GAMParser,\n    private readonly islandSpriteLoader: IslandSpriteLoader,\n    private readonly app: Application,\n    private readonly viewport: Viewport,\n    private readonly configLoader: ConfigLoader,\n    private readonly musicPlayer: MusicPlayer,\n    private readonly animationRenderer: AnimationRenderer\n  ) {}\n\n  public async loadByName(gameName: string) {\n    const games = await this.loadSavesAndMissions();\n    const saveGame = games.find(\n      saveOrMission => saveOrMission.name === gameName\n    );\n    if (!saveGame) {\n      throw new Error(\n        `Could not find ${gameName}. The following files are available: ${games\n          .map(game => game.name)\n          .join(\", \")}`\n      );\n    }\n    await this.load(saveGame);\n  }\n\n  public async load(saveGame: WebKitEntry | string) {\n    const saveGameData = await this.fs.openAndGetContentAsStream(saveGame);\n    const world = await this.gamParser.getWorld(saveGameData);\n    const myPlayerId = 0;\n\n    const gameLogic = new Game(this.configLoader, world);\n    const gameRenderer = new GameRenderer(\n      gameLogic,\n      this.islandSpriteLoader,\n      this.app,\n      this.viewport,\n      this.configLoader,\n      this.animationRenderer,\n      myPlayerId\n    );\n\n    await gameRenderer.begin();\n    await this.musicPlayer.playAll();\n\n    gameLogic.setSimulationSpeed(SimulationSpeed.Default);\n  }\n\n  private async loadSavesAndMissions() {\n    const saves = [];\n    try {\n      saves.push(...(await this.fs.ls(\"/saves\", \".gam\")));\n    } catch (e) {\n      // Ignore errors\n    }\n\n    const missions = [];\n    try {\n      missions.push(...(await this.fs.ls(\"/missions-original\", \".szs|.szm\")));\n      missions.push(...(await this.fs.ls(\"/missions-custom\", \".szs|.szm\")));\n    } catch (e) {\n      // Ignore errors\n    }\n    return saves.concat(missions);\n  }\n}\n","import { Viewport } from \"pixi-viewport\";\nimport { AnimatedSprite, Graphics, Texture } from \"pixi.js\";\nimport SpriteLoader from \"../sprite-loader\";\nimport assert from \"../util/assert\";\nimport { Ship, SHIP_TYPES } from \"./world/ship\";\n\ninterface AnimationConfig {\n  Kind: \"RANDOM\" | \"ENDLESS\" | \"JUMPTO\";\n  AnimOffs: number;\n  AnimAdd: number;\n  AnimAnz: number;\n  AnimSpeed: number;\n  AnimNr?: number | number[];\n  AnimRept?: number;\n  AnimSmp?: string | [string, number, number];\n  Rotate?: number;\n}\n\ninterface AnimationData {\n  nested_objects: {\n    ANIM: {\n      [k: string]: AnimationConfig;\n    };\n  };\n  Id: number;\n  Gfx: number;\n  Kind: string;\n  Stirbtime: number;\n  Speedtyp: number;\n  Bugfignr: string;\n  Nowalkani: number;\n  Rotate: number;\n  Worktime: number;\n  Posoffs: [number, number]; // TODO: What is this?!\n  Fahnoffs: [number, number, number];\n  GfxCategory: string;\n  GfxCategoryMapped: string;\n  // + more\n}\n\nexport interface MyAnimation {\n  config: AnimationData;\n  animations: Record<\n    string,\n    {\n      rotations: Array<{\n        main: AnimatedSprite;\n      }>;\n      config: AnimationConfig;\n    }\n  >;\n}\n\nexport default class AnimationRenderer {\n  constructor(private animationData: any, private spriteLoader: SpriteLoader) {}\n\n  public async getAnimation(name: string): Promise<MyAnimation> {\n    const animationData: AnimationData = this.animationData.objects.FIGUR.items[\n      name\n    ];\n    if (!animationData) {\n      console.log(this.animationData.objects.FIGUR.items);\n      throw new Error(`Invalid animation name: ${name}`);\n    }\n    console.log(animationData);\n\n    let ANIM: Record<string, AnimationConfig>;\n    if (\n      [\n        \"FAHNE1\",\n        \"FAHNE2\",\n        \"FAHNE3\",\n        \"FAHNE4\",\n        \"FAHNEWEISS\",\n        \"FAHNEPIRAT\"\n      ].includes(name)\n    ) {\n      // These animations do not include the necessary animation config.\n      // Simply copy the first animation config from the marketplace.\n      ANIM = {\n        0: this.animationData.objects.FIGUR.items.FAHNEMARKT.nested_objects\n          .ANIM[0]\n      };\n    } else {\n      if (Object.values(animationData.nested_objects).length === 0) {\n        throw new Error(\n          `Animation \"${name}\" does not include sufficient animation data.`\n        );\n      }\n      assert(animationData.nested_objects.ANIM);\n      ANIM = animationData.nested_objects.ANIM;\n    }\n\n    const baseGfx = animationData.Gfx;\n    const baseFramesPerRotation = animationData.Rotate;\n    const rotations = baseFramesPerRotation === 0 ? 1 : 8;\n\n    assert(animationData.GfxCategoryMapped.startsWith(\"GFX\"));\n    const gfxFilename = animationData.GfxCategoryMapped.substr(\"GFX\".length);\n\n    const textures = await this.spriteLoader.getTextures(gfxFilename);\n\n    const animatedSprites: MyAnimation = {\n      config: animationData,\n      animations: {}\n    };\n\n    for (const animIdx of Object.keys(ANIM)) {\n      const animatedSpritesForAnim: Array<{\n        main: AnimatedSprite;\n        bug?: AnimatedSprite;\n      }> = [];\n\n      const animation = ANIM[animIdx];\n\n      // Force 1 step for all ships. Ship animation data is incorrect.\n      const numSteps = animationData.Bugfignr ? 1 : animation.AnimAnz;\n      const speed = (1 / 60) * (1000.0 / animation.AnimSpeed);\n      const gfxPerStep = animation.AnimAdd;\n      const repeats = animation.AnimRept ? animation.AnimRept : 0;\n      const framesPerRotation = animation.Rotate\n        ? animation.Rotate\n        : baseFramesPerRotation;\n\n      for (let rotationIdx = 0; rotationIdx < rotations; rotationIdx++) {\n        const spritesForRotation: AnimatedSprite[] = [];\n\n        let gfx =\n          baseGfx + animation.AnimOffs + rotationIdx * framesPerRotation;\n\n        const frames: Texture[] = [];\n        for (let step = 0; step < numSteps; step++) {\n          frames.push(textures.get(gfx)!);\n          gfx += gfxPerStep;\n        }\n\n        const animatedSprite = new AnimatedSprite(frames);\n        animatedSprite.anchor.set(0, 1);\n        animatedSprite.loop = animation.Kind === \"ENDLESS\";\n        animatedSprite.animationSpeed = speed;\n        spritesForRotation.push(animatedSprite);\n\n        animatedSpritesForAnim.push({\n          main: animatedSprite\n        });\n      }\n\n      animatedSprites.animations[animIdx] = {\n        rotations: animatedSpritesForAnim, // One per rotation\n        config: animation\n      };\n    }\n\n    return animatedSprites;\n  }\n\n  public async renderAnimation(name: string, viewport: Viewport) {\n    const animationData = await this.getAnimation(name);\n    console.log(animationData);\n\n    let y = 200;\n\n    for (const animIdx of Object.keys(animationData.animations)) {\n      const animatedSpritesForAnim =\n        animationData.animations[animIdx].rotations;\n\n      let x = 0;\n      animatedSpritesForAnim.forEach(sprites => {\n        this.debugDrawSprite(sprites.main, viewport, x, y);\n        x += sprites.main.width;\n      });\n      y += 50;\n    }\n  }\n\n  public async getShipAnimation(ship: Ship) {\n    // @ts-ignore\n    const animationName = SHIP_TYPES[ship.type];\n    return this.getAnimation(animationName);\n  }\n\n  public debugDrawSprite(\n    sprite: AnimatedSprite,\n    viewport: Viewport,\n    x: number,\n    y: number\n  ) {\n    const rect = new Graphics();\n    rect.position.set(x, y);\n    rect.lineStyle(1, 0xff0000);\n    rect.drawRect(0, 0, sprite.width, -sprite.height);\n\n    sprite.position.set(x, y);\n    viewport.addChild(sprite);\n    viewport.addChild(rect);\n    sprite.play();\n  }\n}\n","import { AnimatedSprite, Point, Sprite, Texture } from \"pixi.js\";\nimport AnimationRenderer from \"./animation-renderer\";\nimport GameRenderer from \"./game-renderer\";\nimport { TILE_HEIGHT, TILE_WIDTH } from \"./island-renderer\";\nimport { SpriteWithPosition } from \"./island-sprite-loader\";\nimport { Rotation4 } from \"./world/world\";\n\nexport type GroundFieldType =\n  | \"BODEN\"\n  | \"FLUSS\"\n  | \"FLUSSECK\"\n  | \"HANG\"\n  | \"HANGQUELL\"\n  | \"HANGECK\"\n  | \"STRAND\"\n  | \"STRANDMUND\"\n  | \"STRANDECKI\"\n  | \"STRANDECKA\"\n  | \"STRANDVARI\"\n  | \"BRANDUNG\"\n  | \"BRANDECK\"\n  | \"MEER\"\n  | \"FELS\"\n  | \"MUENDUNG\";\n\nexport type LandFieldType =\n  | GroundFieldType\n  | \"STRANDRUINE\"\n  | \"PIER\"\n  | \"WALD\"\n  | \"RUINE\"\n  | \"STRANDHAUS\"\n  | \"HAFEN\";\n\nexport type BuildingFieldType =\n  | \"GEBAEUDE\"\n  | \"HQ\" // Kontor\n  | \"STRASSE\"\n  | \"BRUECKE\"\n  | \"PLATZ\"\n  | \"WMUEHLE\"\n  | \"MINE\"\n  | \"MAUER\"\n  | \"MAUERSTRAND\"\n  | \"TOR\"\n  | \"TURM\"\n  | \"TURMSTRAND\";\n\nexport type FieldKind = LandFieldType | BuildingFieldType;\n\nexport default class FieldType {\n  public readonly id: number;\n  public readonly gfxId: number;\n  public readonly kind: FieldKind;\n  public readonly size: Point;\n  public readonly rotate: number;\n  public readonly animAdd: number;\n  public readonly yOffset: number;\n  public readonly animTime: number;\n  public readonly animAnz: number;\n  public readonly production: {\n    good: string;\n    upkeep: {\n      active: number;\n      inactive: number;\n    };\n    good1: string;\n    good2: string;\n    amount1: number;\n    amount2: number;\n    radius: number;\n    interval: number;\n    maxStock: number;\n    smokeAnimationNames: string[];\n  };\n\n  constructor(config: any) {\n    this.id = config.Id;\n    this.gfxId = config.Gfx;\n    this.kind = config.Kind;\n    this.size = new Point(config.Size.x, config.Size.y);\n    this.rotate = config.Rotate;\n    this.animAdd = config.AnimAdd;\n    this.animAnz = config.AnimAnz;\n    this.animTime = config.AnimTime === \"TIMENEVER\" ? -1 : config.AnimTime;\n    this.yOffset = -config.Posoffs;\n\n    const productionConfig = config.nested_objects.HAUS_PRODTYP[0];\n    const upkeep = {\n      active: 0,\n      inactive: 0\n    };\n    if (Array.isArray(productionConfig.Kosten)) {\n      upkeep.active = productionConfig.Kosten[0];\n      upkeep.inactive = productionConfig.Kosten[1];\n    } else {\n      upkeep.active = upkeep.inactive =\n        productionConfig.Kosten !== undefined ? productionConfig.Kosten : 0;\n    }\n    this.production = {\n      good: productionConfig.Ware,\n      upkeep,\n      good1: productionConfig.Rohstoff,\n      good2: productionConfig.Workstoff,\n      amount1: productionConfig.Rohmenge,\n      amount2:\n        productionConfig.Workmenge !== undefined\n          ? productionConfig.Workmenge\n          : 0,\n      radius:\n        productionConfig.Radius === \"RADIUS_MARKT\" ||\n        productionConfig.Radius === \"RADIUS_HQ\"\n          ? 16\n          : productionConfig.Radius,\n      interval: productionConfig.Interval,\n      maxStock: productionConfig.Maxlager,\n      smokeAnimationNames: Array.isArray(productionConfig.Rauchfignr)\n        ? productionConfig.Rauchfignr\n        : productionConfig.Rauchfignr\n        ? [productionConfig.Rauchfignr]\n        : []\n    };\n  }\n\n  public async getSprites(\n    playerId: number,\n    islandPosition: Point,\n    fieldPos: Point,\n    rotation: Rotation4,\n    animationStep: number,\n    textures: Map<number, Texture>,\n    animationRenderer: AnimationRenderer\n  ) {\n    const smokeAnimations: AnimatedSprite[] = [];\n    const sprites: SpriteWithPosition[] = [];\n    const sx = rotation % 2 === 0 ? this.size.x : this.size.y;\n    const sy = rotation % 2 === 0 ? this.size.y : this.size.x;\n    for (let y = 0; y < sy; y++) {\n      for (let x = 0; x < sx; x++) {\n        const xx = fieldPos.x + x;\n        const yy = fieldPos.y + y;\n        const { x: worldX, y: worldY } = GameRenderer.fieldPosToWorldPos(\n          new Point(xx, yy)\n        );\n\n        let sprite: Sprite | AnimatedSprite;\n        if (this.animAdd === 0 || this.animTime === -1) {\n          const texture = this.getTexture(\n            x,\n            y,\n            rotation,\n            animationStep,\n            textures\n          );\n          sprite = new Sprite(texture);\n        } else {\n          const animatedTextures = [];\n          for (let i = 0; i < this.animAnz; i++) {\n            animatedTextures.push(this.getTexture(x, y, rotation, i, textures));\n          }\n          const animatedSprite = new AnimatedSprite(animatedTextures);\n          animatedSprite.animationSpeed =\n            (1.0 / 60.0) * (1000.0 / this.animTime);\n          animatedSprite.play();\n          sprite = animatedSprite;\n        }\n        // Set bottom left corner of sprite as origin.\n        sprite.anchor.set(0, 1);\n        sprite.x = worldX;\n        sprite.y = worldY + this.yOffset;\n        sprites.push({\n          sprite: sprite,\n          pixelPosition: new Point(sprite.x, sprite.y),\n          mapPosition: new Point(xx, yy),\n          mapPositionOnIsland: new Point(\n            xx - islandPosition.x,\n            yy - islandPosition.y\n          )\n        });\n      }\n    }\n\n    if (this.production.smokeAnimationNames) {\n      const { x: worldX, y: worldY } = GameRenderer.fieldPosToWorldPos(\n        new Point(fieldPos.x, fieldPos.y)\n      );\n      await Promise.all(\n        this.production.smokeAnimationNames.map(async smokeAnimationName => {\n          if (smokeAnimationName === \"FAHNEKONTOR\") {\n            // The pirate kontor actually uses an invalid animation name. That appears to be a bug in Anno1602 itself.\n            return;\n          }\n\n          const smokeAnimation = await animationRenderer.getAnimation(\n            smokeAnimationName\n          );\n          const animation =\n            Object.keys(smokeAnimation.animations).length > 1\n              ? smokeAnimation.animations[playerId]\n              : smokeAnimation.animations[0];\n          const smokeSprite = animation.rotations[0].main;\n\n          smokeSprite.x =\n            worldX -\n            Math.floor(smokeSprite.width / 2) + // calculate smoke center position\n            TILE_WIDTH * 0.75 -\n            (sy - sx + 1) * (TILE_WIDTH * 0.25) + // move to building center\n            Math.floor(\n              ((smokeAnimation.config.Fahnoffs[0] *\n                (rotation === 0 || rotation === 3 ? 1 : -1) -\n                smokeAnimation.config.Fahnoffs[1] *\n                  (rotation === 0 || rotation === 1 ? 1 : -1)) *\n                TILE_WIDTH) /\n                2\n            );\n\n          smokeSprite.y =\n            worldY -\n            TILE_HEIGHT / 2 +\n            (sx + sy - 2) * TILE_HEIGHT * 0.25 + // move bottom of smoke to building center\n            Math.floor(\n              ((smokeAnimation.config.Fahnoffs[0] *\n                (rotation === 0 || rotation === 1 ? 1 : -1) +\n                smokeAnimation.config.Fahnoffs[1] *\n                  (rotation === 0 || rotation === 3 ? 1 : -1)) *\n                TILE_HEIGHT) /\n                2\n            ) -\n            Math.floor(TILE_HEIGHT * smokeAnimation.config.Fahnoffs[2]);\n          smokeSprite.anchor = new Point(0, 1);\n          smokeAnimations.push(smokeSprite);\n\n          if (smokeAnimationName.startsWith(\"RAUCH\")) {\n            // TODO: This doesn't quite look like the original, but works for now.\n            smokeSprite.alpha = 0.7;\n          }\n        })\n      );\n    }\n\n    return { sprites, smokeAnimations };\n  }\n\n  private getTexture(\n    x: number,\n    y: number,\n    rotation: Rotation4,\n    animationStep: number,\n    textures: Map<number, Texture>\n  ): Texture {\n    let tileId = this.gfxId;\n    if (this.rotate > 0) {\n      tileId += rotation * this.size.x * this.size.y;\n    }\n    tileId += animationStep * this.animAdd;\n\n    if (rotation === 0) {\n      tileId += y * this.size.x + x;\n    } else if (rotation === 1) {\n      tileId +=\n        this.size.x * this.size.y -\n        1 -\n        (x * this.size.x + (this.size.x - 1 - y));\n    } else if (rotation === 2) {\n      tileId += (this.size.y - 1 - y) * this.size.x + (this.size.x - 1 - x);\n    } else if (rotation === 3) {\n      tileId += x * this.size.x + (this.size.x - 1 - y);\n    } else {\n      throw new Error(`Invalid building rotation: ${rotation}.`);\n    }\n\n    const texture = textures.get(tileId);\n    if (texture === undefined) {\n      throw new Error(`Could not load texture ${tileId}.`);\n    }\n\n    return texture;\n  }\n}\n","import FileSystem from \"../filesystem\";\nimport FieldType from \"./field-type\";\n\nexport default class ConfigLoader {\n  private loaded = false;\n  private readonly fieldData: Map<number, FieldType> = new Map();\n\n  constructor(private readonly fs: FileSystem) {}\n\n  public async load() {\n    const fieldConfig = JSON.parse(\n      await this.fs.openAndGetContentAsText(\"/fields.json\")\n    ).objects.HAUS.items;\n    for (const key of Object.keys(fieldConfig)) {\n      const fieldId = parseInt(fieldConfig[key].Id, 10);\n      this.fieldData.set(fieldId, new FieldType(fieldConfig[key]));\n    }\n    this.loaded = true;\n  }\n\n  public getFieldData(): ReadonlyMap<number, FieldType> {\n    if (!this.loaded) {\n      throw new Error(\"Configuration is not loaded. Call .load() first!\");\n    }\n    return this.fieldData;\n  }\n}\n","import { Loader } from \"pixi.js\";\nimport FileSystem from \"../filesystem\";\nimport { uInt8ToBase64 } from \"../util/util\";\n\nexport default class FontLoader {\n  constructor(private readonly fs: FileSystem) {}\n\n  public async load() {\n    const fonts: { [name: string]: { size: number } } = {\n      ZEI20V: { size: 24 }\n    };\n    for (const fontName of Object.keys(fonts)) {\n      // const size = fonts[fontName].size;\n      console.log(`Loading font ${fontName}.`);\n      const font = await this.fs.openAndGetContentAsUint8Array(\n        `/fonts/${fontName}/font.xml`\n      );\n      await new Promise(resolve => {\n        Loader.shared\n          .add(fontName, `data:application/xml;base64,${uInt8ToBase64(font)}`)\n          .load(resolve);\n      });\n      console.log(`Finished loading font ${fontName}.`);\n    }\n  }\n}\n","import { interaction, Sprite } from \"pixi.js\";\n\ntype InteractionEvent = interaction.InteractionEvent;\n\nexport default class SliderSprite extends Sprite {\n  private dragging = false;\n  private topY: number;\n\n  public setSliderData(sizeY: number, offsetY: number, sliderSizeY: number) {\n    this.position.set(\n      this.position.x,\n      this.position.y + (sizeY - sliderSizeY) / 2\n    );\n    this.topY = this.position.y;\n    // sprite.position.set(sprite.position.x + sliderOffset[0], sprite.position.y + sliderOffset[1]);\n    this.on(\"mousedown\", (event: InteractionEvent) => {\n      this.dragging = true;\n    });\n    this.on(\"mouseup\", (event: InteractionEvent) => {\n      this.dragging = false;\n    });\n    this.on(\"mousemove\", (event: InteractionEvent) => {\n      if (this.dragging) {\n        const originalEvent = event.data.originalEvent as\n          | MouseEvent\n          | PointerEvent;\n        const eventY = originalEvent.offsetY - this.texture.height / 2;\n        this.position.y = this.clamp(\n          eventY,\n          this.topY,\n          this.topY + sliderSizeY - this.texture.height / 2\n        );\n      }\n    });\n  }\n\n  /*\n    public moveDown() {\n\n    }\n\n    public moveUp() {\n\n    }\n    */\n\n  private clamp(val: number, min: number, max: number) {\n    return Math.min(Math.max(min, val), max);\n  }\n}\n","import {\n  BitmapText,\n  Container,\n  Point,\n  Rectangle,\n  resources,\n  Sprite,\n  Texture\n} from \"pixi.js\";\nimport SpriteLoader from \"../sprite-loader\";\nimport assert from \"../util/assert\";\nimport { ScreenConfig } from \"./menu-structure\";\nimport SliderSprite from \"./ui/slider-sprite\";\n\ninterface RadioButtonData {\n  sprite: Sprite;\n  defaultTexture: Texture;\n  activeTexture: Texture;\n}\n\nexport default class GADRenderer {\n  private videos: Sprite[] = [];\n\n  constructor(\n    private readonly stage: Container,\n    private readonly spriteLoader: SpriteLoader\n  ) {}\n\n  public async render(data: any, config: ScreenConfig) {\n    this.destroyVideos();\n    this.stage.removeChildren();\n\n    const blockNumMapping: Map<number, string> = new Map();\n    for (const name of Object.keys(data.variables)) {\n      const value = data.variables[name];\n      if (name.startsWith(\"BLK_\")) {\n        blockNumMapping.set(value, name.substring(4));\n      }\n    }\n\n    const radioButtons: RadioButtonData[] = [];\n    let selectableCount = 0;\n    const gadgets = data.objects.GADGET.items;\n    for (const num of Object.keys(gadgets)) {\n      const gadget = gadgets[num];\n      const id = gadget.Id;\n      const blockNr = gadget.Blocknr;\n      const gfx = gadget.Gfxnr;\n      const kind: string = gadget.Kind;\n      if (kind === \"GAD_UNUSED\") {\n        continue;\n      }\n      const position = new Point(gadget.Pos[0], gadget.Pos[1]);\n      if (gadget.Posoffs) {\n        position.set(\n          position.x + gadget.Posoffs[0],\n          position.y + gadget.Posoffs[1]\n        );\n      }\n      const size =\n        gadget.Size !== undefined\n          ? new Point(gadget.Size.x, gadget.Size.y)\n          : null;\n      const selectable = gadget.Noselflg === undefined || gadget.Noselflg === 0;\n      const pressOff = gadget.Pressoff;\n      const isRadioButton = gadget.Reiheflg === 1;\n      if (isRadioButton) {\n        assert(selectable);\n      }\n      assert(blockNr !== undefined);\n\n      const isSlider = gadget.Slidverflg !== undefined;\n      const sliderOffset = gadget.Slidoffs;\n      const sliderSize = gadget.Slidsize;\n\n      switch (kind) {\n        case \"GAD_GFX\": {\n          const textures = await this.spriteLoader.getTextures(\n            `TOOLS/${blockNumMapping.get(blockNr)}`\n          );\n\n          const defaultTexture = textures.get(gfx)!;\n          const activeTexture = textures.get(gfx + pressOff)!;\n\n          const sprite = !isSlider\n            ? new Sprite(defaultTexture)\n            : new SliderSprite(defaultTexture);\n          sprite.position.set(position.x, position.y);\n          sprite.name = `menu-${id}`;\n\n          if (isSlider) {\n            (sprite as SliderSprite).setSliderData(\n              size!.y,\n              sliderOffset[1],\n              sliderSize[1]\n            );\n          }\n\n          if (selectable) {\n            sprite.buttonMode = true;\n            sprite.interactive = true;\n            const callback = config.buttons[selectableCount];\n\n            if (isRadioButton) {\n              if (radioButtons.length === 0) {\n                // The first radio button is active at the start.\n                sprite.texture = activeTexture;\n              }\n              radioButtons.push({ sprite, activeTexture, defaultTexture });\n            }\n\n            sprite.on(\"mousedown\", () => {\n              sprite.texture = activeTexture;\n              if (isRadioButton) {\n                // If this IS a radio button, make all other radio buttons inactive.\n                for (const button of radioButtons) {\n                  if (button.sprite !== sprite) {\n                    button.sprite.texture = button.defaultTexture;\n                  }\n                }\n              }\n              callback(this.stage);\n            });\n\n            if (!isRadioButton) {\n              // If this is NOT a radio button, go back to normal state on mouse up.\n              sprite.on(\"mouseup\", () => (sprite.texture = defaultTexture));\n            }\n\n            selectableCount++;\n          }\n          this.stage.addChild(sprite);\n          break;\n        }\n        case \"GAD_TEXTL\":\n        case \"GAD_TEXTZ\":\n        case \"GAD_TEXTR\": {\n          // case \"GAD_TEXTFL\":\n          const fontSize = 24;\n          const text = new BitmapText(\"Here goes text!\", {\n            font: { name: \"ZEI20V\", size: fontSize }\n          });\n          text.position.set(position.x, position.y);\n          text.pivot.set(0, fontSize);\n          text.name = `menu-${id}`;\n          text.hitArea = new Rectangle(0, 0, size!.x, size!.y);\n          if (kind.endsWith(\"Z\")) {\n            // Center text\n            text.pivot.set(text.x / 2, text.pivot.y);\n          } else if (kind.endsWith(\"R\")) {\n            // text.pivot.set(text.x, text.pivot.y);\n          }\n          this.stage.addChild(text);\n          break;\n        }\n        default:\n          console.warn(`Unsupported kind: ${kind}`);\n      }\n    }\n\n    config.onLoad(this.stage);\n  }\n\n  public renderVideo(videoSprite: Sprite, onEnd: () => void) {\n    const videoTexture = videoSprite.texture.baseTexture\n      .resource as resources.VideoResource;\n    videoTexture.source.addEventListener(\n      \"ended\",\n      () => {\n        this.stage.removeChild(videoSprite);\n        onEnd();\n      },\n      { once: true }\n    );\n    this.stage.addChild(videoSprite);\n    this.videos.push(videoSprite);\n  }\n\n  public renderVideoFullscreen(videoSprite: Sprite, onEnd: () => void) {\n    this.destroyVideos();\n    this.stage.removeChildren();\n\n    const videoTexture = videoSprite.texture.baseTexture\n      .resource as resources.VideoResource;\n    videoTexture.source.addEventListener(\n      \"ended\",\n      () => {\n        this.stage.removeChild(videoSprite);\n        onEnd();\n      },\n      { once: true }\n    );\n\n    videoSprite.scale.set(2, 2);\n\n    // TODO: For some reason, this.stage.width/height are way to small.\n    const x =\n      /*this.stage.width*/ 1024 / 2 -\n      (videoSprite.texture.width * videoSprite.scale.x) / 2;\n    const y =\n      /*this.stage.height*/ 768 / 2 -\n      (videoSprite.texture.height * videoSprite.scale.y) / 2;\n    videoSprite.position.set(x, y);\n\n    this.stage.addChild(videoSprite);\n  }\n\n  private destroyVideos() {\n    this.videos.forEach(video =>\n      video.destroy({ texture: true, baseTexture: true })\n    );\n    this.videos = [];\n  }\n}\n","import AsyncLock from \"async-lock\";\nimport { AnimatedSprite, Point, Sprite, Texture } from \"pixi.js\";\nimport FileSystem from \"../filesystem\";\nimport SpriteLoader from \"../sprite-loader\";\nimport { make2DArray } from \"../util/util\";\nimport AnimationRenderer from \"./animation-renderer\";\nimport ConfigLoader from \"./config-loader\";\nimport { default as FieldX } from \"./field-type\";\nimport { Island } from \"./world/island\";\n\nexport interface SpriteWithPosition {\n  sprite: Sprite;\n  pixelPosition: Point;\n  mapPosition: Point;\n  mapPositionOnIsland: Point;\n}\n\nexport default class IslandSpriteLoader {\n  private inited = false;\n  private fields: ReadonlyMap<number, FieldX> = new Map();\n  private textures: Map<number, Texture> = new Map();\n  private lock: AsyncLock = new AsyncLock();\n\n  constructor(\n    private readonly configLoader: ConfigLoader,\n    private readonly spriteLoader: SpriteLoader,\n    private readonly animationRenderer: AnimationRenderer\n  ) {}\n\n  public init = async () => {\n    await this.lock.acquire(\"init\", async () => {\n      if (!this.inited) {\n        this.textures = await this.spriteLoader.getTextures(\"STADTFLD\");\n        this.fields = this.configLoader.getFieldData();\n        this.inited = true;\n      }\n    });\n  };\n\n  public getIslandSprites = async (island: Island) => {\n    await this.init();\n\n    const smokeSprites: AnimatedSprite[] = [];\n\n    const sprites = make2DArray<SpriteWithPosition>(\n      island.size.x,\n      island.size.y\n    );\n\n    for (let x = 0; x < island.size.x; x++) {\n      for (let y = 0; y < island.size.y; y++) {\n        await this.loadSpritesOfField(island, x, y, sprites, smokeSprites);\n      }\n    }\n\n    return { sprites, smokeSprites };\n  };\n\n  private loadSpritesOfField = async (\n    island: Island,\n    x: number,\n    y: number,\n    sprites: Array<Array<SpriteWithPosition | null>>,\n    smokeSprites: AnimatedSprite[]\n  ) => {\n    const field = island.fields[x][y];\n    if (field === null) {\n      return;\n    }\n    const fieldConfig = this.fields.get(field.fieldId);\n    if (fieldConfig === undefined) {\n      throw new Error(`Could not load config for ${field.fieldId}.`);\n    }\n    const origin = new Point(island.position.x + x, island.position.y + y);\n\n    const {\n      sprites: newSprites,\n      smokeAnimations\n    } = await fieldConfig.getSprites(\n      field.playerId,\n      island.position,\n      origin,\n      field.rotation,\n      field.ani,\n      this.textures,\n      this.animationRenderer\n    );\n    newSprites.forEach(newSprite => {\n      const { x: xx, y: yy } = newSprite.mapPositionOnIsland;\n      if (sprites[xx][yy] === null) {\n        sprites[xx][yy] = newSprite;\n      }\n    });\n    smokeSprites.push(...smokeAnimations);\n  };\n}\n","import { Texture } from \"pixi.js\";\nimport { uInt8ToBase64 } from \"./util\";\n\nexport function textureFromUint8ArrayPNG(data: Uint8Array) {\n  return Texture.from(`data:image/png;base64,${uInt8ToBase64(data)}`);\n}\n\nexport async function textureFromUint8ArrayMP4(\n  data: Uint8Array\n): Promise<Texture> {\n  const tmpVideo = document.createElement(\"video\");\n  tmpVideo.src = `data:video/mp4;base64,${uInt8ToBase64(data)}`;\n  const texture = Texture.from(tmpVideo);\n  await new Promise((resolve, reject) => {\n    texture.baseTexture.addListener(\"loaded\", resolve);\n    texture.baseTexture.addListener(\"error\", reject);\n  });\n  return texture;\n}\n","/*\n * The savegame data structure was reverse-engineered by Benedikt Freisen\n * as part of the 'mdcii-engine' project and released under GPLv2+.\n * https://github.com/roybaer/mdcii-engine\n */\n\nimport { Point } from \"pixi.js\";\nimport Stream from \"../../parsers/stream\";\nimport assert from \"../../util/assert\";\n\nexport enum OreLocationKind {\n  Iron = 2,\n  Gold = 3\n}\n\nexport enum OreLocationSize {\n  Small = 1,\n  Big = 0\n}\n\nexport class OreLocation {\n  public static fromSaveGame(data: Stream) {\n    const kind = data.read8();\n    const position = new Point(data.read8(), data.read8());\n    const discoveredBy = data.read8(); // unsure\n    const size = data.read8();\n    data.read8(); // mostly 0?\n    const amount = data.read16(); // unsure\n\n    return new OreLocation(kind, size, amount, position, discoveredBy);\n  }\n\n  constructor(\n    public kind: OreLocationKind,\n    public size: OreLocationSize,\n    public amount: number,\n    public position: Point,\n    public discoveredBy: number\n  ) {}\n}\n","/*\n * The savegame data structure was reverse-engineered by Benedikt Freisen\n * as part of the 'mdcii-engine' project and released under GPLv2+.\n * https://github.com/roybaer/mdcii-engine\n */\n\nimport { Point } from \"pixi.js\";\nimport Stream from \"../../parsers/stream\";\nimport { SoldierType } from \"./soldier\";\n\nclass Unit {\n  public static fromSaveGame(data: Stream) {\n    const type: SoldierType = data.read8();\n    const flags = data.read8();\n    data.read16();\n    const hp = data.read16();\n    data.read16();\n\n    return new Unit(type, (flags & 0x10) !== 0, hp);\n  }\n\n  constructor(\n    public type: SoldierType,\n    public ready: boolean,\n    public hp: number\n  ) {}\n}\n\nexport type Castle = ReturnType<typeof castleFromSaveGame>;\n\nexport function castleFromSaveGame(data: Stream) {\n  const islandId = data.read8();\n  const position = new Point(data.read8(), data.read8());\n  data.read8();\n  data.read32();\n  const numSwords = data.read16();\n  const numMuscets = data.read16();\n  const numCanons = data.read16();\n  data.read16();\n  const units = parseUnits(data);\n  data.read(32);\n\n  return {\n    islandId,\n    position,\n    numSwords,\n    numMuscets,\n    numCanons,\n    units\n  };\n}\n\nfunction parseUnits(data: Stream) {\n  const units = [];\n  for (let i = 0; i < 8; i++) {\n    units.push(Unit.fromSaveGame(data));\n  }\n  return units;\n}\n","/*\n * The savegame data structure was reverse-engineered by Benedikt Freisen\n * as part of the 'mdcii-engine' project and released under GPLv2+.\n * https://github.com/roybaer/mdcii-engine\n */\n\nimport Stream from \"../../parsers/stream\";\n\nexport type City = ReturnType<typeof cityFromSaveGame>;\n\nexport function cityFromSaveGame(data: Stream) {\n  const islandId = data.read8();\n  const cityIslandNum = data.read8();\n  const playerId = data.read16();\n  const progressAllowed = !data.read8Bool();\n  const _1 = data.read(87);\n  const inhabitants = [];\n  for (let i = 0; i < 5; i++) {\n    inhabitants.push(data.read32());\n  }\n  const _2 = data.read(15);\n  const taxes = [];\n  for (let i = 0; i < 5; i++) {\n    taxes.push(data.read8());\n  }\n  const _3 = data.read(3);\n  const name = data.readString(33);\n\n  return {\n    islandId,\n    playerId,\n    cityIslandNum,\n    progressAllowed,\n    inhabitants,\n    taxes,\n    name\n  };\n}\n","/*\n * The savegame data structure was reverse-engineered by Benedikt Freisen\n * as part of the 'mdcii-engine' project and released under GPLv2+.\n * https://github.com/roybaer/mdcii-engine\n */\n\nimport { Point, Rectangle } from \"pixi.js\";\nimport Stream from \"../../parsers/stream\";\nimport assert from \"../../util/assert\";\nimport Field from \"./field\";\nimport { OreLocation } from \"./island-ore-location\";\n\nenum IslandFertilityFlags {\n  TOBACCO = 1,\n  SUGARCANE = 3,\n  WINE = 5,\n  COTTON = 4,\n  CACAO = 6,\n  SPICE = 2\n}\n\nexport interface IslandFertility {\n  tobacco: boolean;\n  sugarcane: boolean;\n  wine: boolean;\n  cotton: boolean;\n  cacao: boolean;\n  spice: boolean;\n}\n\nexport type Island = ReturnType<typeof islandFromSaveGame>;\n\nexport function islandFromIsland3File(\n  id: number,\n  position: Point,\n  isSouth: boolean,\n  numBaseIsland: number,\n  data: Stream\n): Island {\n  data.read8(); // Ignore id\n  const size = new Point(data.read8(), data.read8());\n\n  return {\n    id,\n    position,\n    size,\n    positionRect: new Rectangle(position.x, position.y, size.x, size.y),\n    numBaseIsland,\n    numOreLocations: 0,\n    oreLocations: [],\n    fertility: {\n      tobacco: false,\n      sugarcane: false,\n      wine: false,\n      cotton: false,\n      cacao: false,\n      spice: false\n    },\n    isSouth,\n    differsFromBaseIsland: false,\n    fertilityDiscovered: false,\n    fields: []\n  };\n}\n\nexport function islandFromIsland4File(\n  id: number,\n  position: Point,\n  isSouth: boolean,\n  numBaseIsland: number,\n  data: Stream\n): Island {\n  return islandFromIsland3File(id, position, isSouth, numBaseIsland, data);\n}\n\nexport function islandFromIsland5File(\n  id: number,\n  position: Point,\n  isSouth: boolean,\n  numBaseIsland: number,\n  data: Stream\n): Island {\n  return islandFromIsland3File(id, position, isSouth, numBaseIsland, data);\n}\n\nexport function islandFromSaveGame(data: Stream) {\n  const id = data.read8();\n  const width = data.read8();\n  const height = data.read8();\n  /*\n    uint8      strtduerrflg:1;\n    uint8      nofixflg:1;\n    uint8      vulkanflg:1;\n     */\n  const _1 = data.read8();\n  const x = data.read16();\n  const y = data.read16();\n\n  const hirschreviercnt = data.read16();\n  const speedcnt = data.read16();\n  // the order in which players built their cities on this island\n  // is 7, 7, 7, 7, 7, 7, 7, 7, by default\n  // fills up from the beginning with player ids once a player builds a kontor.\n  // natives are also listed; islands with natives start with 6, 7, 7, ...\n  const stadtplayernr = data.read(8);\n\n  assert(data.read(3).every(e => e === 0));\n\n  const vulcanoCount = data.read8();\n  const treasureFlag = data.read8Bool();\n  const rohstanz = data.read8();\n\n  const numOreLocations = data.read8();\n  const fertilityDiscovered = data.read8();\n  const oreLocations = [\n    OreLocation.fromSaveGame(data),\n    OreLocation.fromSaveGame(data)\n  ];\n  // These look like even more ore locations.\n  const _5 = data.read(48);\n\n  const fertility = parseFertility(data.read32());\n  const numBaseIsland = data.read16();\n\n  // unsure\n  const sizenr = data.read16();\n\n  const isSouth = data.read8Bool();\n  const differsFromBaseIsland = data.read8Bool();\n\n  // unsure\n  const duerrproz = data.read8();\n  // unsure\n  const rotier = data.read8();\n\n  const seeplayerflags = data.read32(); // 1 nach bloem Vorbeifahren (= zeigt Eingebohrene), 0xFF nach Kontorbau\n\n  // unsure\n  const duerrcnt = data.read32();\n\n  data.read32(); // mostly 0?\n\n  const fields: Array<Array<Field | null>> = [];\n\n  return {\n    id,\n    position: new Point(x, y),\n    size: new Point(width, height),\n    positionRect: new Rectangle(x, y, width, height),\n    numBaseIsland,\n    numOreLocations,\n    oreLocations,\n    fertility,\n    isSouth,\n    differsFromBaseIsland,\n    fertilityDiscovered: fertilityDiscovered !== 0,\n    fields\n  };\n\n  // island.debug = {\n  //    _1,\n  //    _5,\n  //    hirschreviercnt,\n  //    speedcnt,\n  //    stadtplayernr,\n  //    vulcanoCount,\n  //    treasureFlag,\n  //    rohstanz,\n  //\n  //    sizenr,\n  //    duerrproz,\n  //    rotier,\n  //\n  //    seeplayerflags,\n  //    duerrcnt,\n  // };\n  // console.log(island.debug);\n}\n\nfunction parseFertility(fertility: number): IslandFertility {\n  return {\n    tobacco: (fertility & (1 << IslandFertilityFlags.TOBACCO)) > 0,\n    sugarcane: (fertility & (1 << IslandFertilityFlags.SUGARCANE)) > 0,\n    wine: (fertility & (1 << IslandFertilityFlags.WINE)) > 0,\n    cotton: (fertility & (1 << IslandFertilityFlags.COTTON)) > 0,\n    cacao: (fertility & (1 << IslandFertilityFlags.CACAO)) > 0,\n    spice: (fertility & (1 << IslandFertilityFlags.SPICE)) > 0\n  };\n}\n","/*\n * The savegame data structure was reverse-engineered by Benedikt Freisen\n * as part of the 'mdcii-engine' project and released under GPLv2+.\n * https://github.com/roybaer/mdcii-engine\n */\n\nimport Stream from \"../../parsers/stream\";\n\nexport enum GoodAction {\n  None = 0,\n  Sell = 1,\n  Buy = 2\n}\n\nexport default class Good {\n  public static fromSaveGame(data: Stream) {\n    const tmp = data.read32();\n    const sellingPrice = (tmp & 0b00000000000000000000001111111111) >> 0;\n    const buyingPrice = (tmp & 0b00000000000011111111110000000000) >> 10;\n    const action: GoodAction = (tmp & 0b11111111111100000000000000000000) >> 20;\n    const _1 = data.read32();\n    const wantedSellingAmount = data.read16() >> 5;\n    const wantedBuyingAmount = data.read16() >> 5;\n    const currentAmount = data.read16() >> 5;\n    const _2 = data.read16();\n\n    /*\n        100101100001 // iron ore\n        100101100101 // gold ore\n        010111100001 // wool\n        010111100111 // sugarcane\n        010111100011 // tobacco\n        010111101001 // cows\n        010111011111 // grain\n        000111110101 // flour\n        001000001001 // iron\n        001000000101 // swords\n        001000010001 // muskets\n        001000001111 // canons\n        010000110011 // food\n        001000001101 // tobacco\n        010111011101 // spice\n        010111100101 // cacao\n        001000000111 // wine\n        000111111011 // fabric\n        000111111001 // clothing\n        001000010101 // jewellery\n        001000000011 // tools\n        011111010001 // wood\n        001000000001 // stone\n         */\n    const goodId = data.read16();\n    const _3 = data.read16();\n\n    return new Good(\n      goodId,\n      sellingPrice,\n      buyingPrice,\n      wantedSellingAmount,\n      wantedBuyingAmount,\n      currentAmount,\n      action\n    );\n  }\n\n  constructor(\n    public goodId: number,\n    public sellingPrice: number,\n    public buyingPrice: number,\n    public wantedSellingAmount: number,\n    public wantedBuyingAmount: number,\n    public currentAmount: number,\n    public action: GoodAction\n  ) {}\n}\n","/*\n * The savegame data structure was reverse-engineered by Benedikt Freisen\n * as part of the 'mdcii-engine' project and released under GPLv2+.\n * https://github.com/roybaer/mdcii-engine\n */\n\nimport Stream from \"../../parsers/stream\";\n\nexport enum ContractState {\n  Inactive = 0,\n  OfferedByMe = 1,\n  OfferedByOther = 2,\n  Active = 3\n}\n\nexport default class Contract {\n  public static fromSaveGame(data: Stream) {\n    const state = data.read32();\n    const time = data.read32(); // unsure\n\n    return new Contract(state, time);\n  }\n\n  constructor(\n    public readonly state: ContractState,\n    public readonly time: number\n  ) {}\n}\n","/*\n * The savegame data structure was reverse-engineered by Benedikt Freisen\n * as part of the 'mdcii-engine' project and released under GPLv2+.\n * https://github.com/roybaer/mdcii-engine\n */\n\nimport { Point } from \"pixi.js\";\nimport Stream from \"../../parsers/stream\";\nimport Good from \"./good\";\n\nexport type Kontor = ReturnType<typeof kontorFromSaveGame>;\n\nexport function kontorFromSaveGame(data: Stream) {\n  const islandId = data.read8();\n  const position = new Point(data.read8(), data.read8());\n  const playerId = data.read8();\n  const goods = parseGoods(data);\n\n  return {\n    islandId,\n    position,\n    playerId,\n    goods\n  };\n}\n\nfunction parseGoods(data: Stream) {\n  const goods = [];\n  for (let i = 0; i < 2; i++) {\n    Good.fromSaveGame(data);\n  }\n  for (let i = 2; i < 2 + 23; i++) {\n    goods.push(Good.fromSaveGame(data));\n  }\n  for (let i = 2 + 23; i < 50; i++) {\n    Good.fromSaveGame(data);\n  }\n  return goods;\n}\n","import Stream from \"../../parsers/stream\";\nimport assert from \"../../util/assert\";\n\nenum PlayerEventKind {}\n// TODO\n\nexport default class PlayerEvent {\n  public static fromSaveGame(data: Stream) {\n    const kind = data.read8();\n    const otherPlayerId = data.read8();\n    assert(data.read16() === 0);\n    const time = data.read32(); // TODO: Which unit is time in?\n\n    return new PlayerEvent(kind, otherPlayerId, time);\n  }\n\n  constructor(\n    public readonly kind: PlayerEventKind,\n    public readonly otherPlayerId: number,\n    public readonly time: number\n  ) {}\n}\n","/*\n * The savegame data structure was reverse-engineered by Benedikt Freisen\n * as part of the 'mdcii-engine' project and released under GPLv2+.\n * https://github.com/roybaer/mdcii-engine\n */\n\nimport Stream from \"../../parsers/stream\";\nimport assert from \"../../util/assert\";\nimport Contract from \"./contract\";\nimport PlayerEvent from \"./player-event\";\n\nexport enum PlayerKind {\n  HUMAN = 0,\n  AI = 9,\n  TRADER = 13,\n  PIRATE = 14,\n  NATIVE = 11\n}\n\nexport type Player = ReturnType<typeof playerFromSaveGame>;\n\nexport function playerFromSaveGame(data: Stream) {\n  const money = data.read32S();\n  const kind: PlayerKind = data.read8();\n  const id = data.read8();\n  const humanPlayerCount = data.read8(); // unsure\n  const color = data.read8();\n  const killedByPlayerId = data.read8(); // killedByPlayerId\n  assert(data.read8() === 0);\n  const _3_3 = data.read16(); // unsure, time since no ships and cities\n  const assignedTaskId = data.read8(); // Can be 0, 1, 2, 3 or 0xFF (no task assigned)\n  const _3_2 = data.read8(); // unsure, may not be played by human\n  const palaceBuilt = data.read8Bool();\n  const cathedralBuilt = data.read8Bool();\n\n  const enemiesDefeated = data.read16();\n  const triumphArchesBuilt = data.read16();\n  const soldiersKilled = data.read16();\n  const soldiersFallen = data.read16();\n  const shipsSunken = data.read16();\n  const shipsKilled = data.read16();\n  const _4 = data.read8();\n  const flags = data.read8();\n  const enablePositiveWillInfluence = (flags & (1 << 0)) > 0;\n  const enableNegativeWillInfluence = (flags & (1 << 1)) > 0;\n  const _5 = data.read(6);\n  const positiveWillInfluence = data.read8() / 32.0 + 1.0; // Between 1.0 and 5.0\n  const negativeWillInfluence = data.read8() / 32.0 + 1.0; // Between 1.0 and 5.0\n  assert(data.read(14).every(e => e === 0));\n  const accessibleBuildings = data.read32();\n  const statues = data.read16();\n  const statuesBuilt = data.read16();\n  const tmp = data.read32();\n  assert(tmp === 0xffffffff);\n\n  const _8 = data.read(264);\n  const tradeContracts = [];\n  for (let i = 0; i < 3; i++) {\n    tradeContracts.push(Contract.fromSaveGame(data));\n  }\n  const peaceContracts = [];\n  for (let i = 0; i < 3; i++) {\n    peaceContracts.push(Contract.fromSaveGame(data));\n  }\n\n  const _9 = data.read(72);\n\n  const playerEvents = [];\n  for (let i = 0; i < 64; i++) {\n    playerEvents.push(PlayerEvent.fromSaveGame(data));\n  }\n\n  const fullName = data.readString(64);\n  const shortName = data.readString(48); // Only used in multiplayer\n\n  console.log(`player ${id}:  `, killedByPlayerId, _3_3, _3_2, _4, _5); // , _8, _9);\n\n  return {\n    id,\n    kind,\n    color,\n    fullName,\n    shortName,\n    tradeContracts,\n    peaceContracts,\n    money,\n    enemiesDefeated,\n    triumphArchesBuilt,\n    soldiersKilled,\n    soldiersFallen,\n    shipsSunken,\n    shipsKilled,\n    accessibleBuildings,\n    statues,\n    statuesBuilt,\n    palaceBuilt,\n    cathedralBuilt,\n\n    enablePositiveWillInfluence,\n    enableNegativeWillInfluence,\n    positiveWillInfluence,\n    negativeWillInfluence,\n\n    assignedTaskId,\n\n    playerEvents\n  };\n}\n","/*\n * The savegame data structure was reverse-engineered by Benedikt Freisen\n * as part of the 'mdcii-engine' project and released under GPLv2+.\n * https://github.com/roybaer/mdcii-engine\n */\n\nimport { Point } from \"pixi.js\";\nimport Stream from \"../../parsers/stream\";\nimport { Rotation8 } from \"./world\";\n\n/**\n * # Animation notes\n *\n * There is a seperate animation per player color (red, blue, yellow, white)\n *\n * KANONIER1, KANONIER2, KANONIER3, KANONIER4\n * KAVALERIE1, KAVALERIE2, KAVALERIE3, KAVALERIE4\n * MUSKETIER1, MUSKETIER2, MUSKETIER3, MUSKETIER4\n * SOLDAT1, SOLDAT2, SOLDAT3, SOLDAT4\n */\n\nexport enum SoldierType {\n  Swordsman = 0,\n  Cavalry = 1,\n  Musketeer = 2,\n  Gunner = 3,\n  Native = 8\n}\n\nexport type Soldier = ReturnType<typeof soldierFromSaveGame>;\n\nexport function soldierFromSaveGame(data: Stream) {\n  const position = new Point(data.read16() / 2, data.read16() / 2);\n  const hp = data.read16();\n  const type = data.read16();\n  const id = data.read16();\n  const course1 = data.read(4);\n  const _1 = data.read16();\n  const _2 = data.read16();\n  const _3 = data.read8();\n  const _4 = data.read8();\n  const _5 = data.read32();\n  const playerId = data.read8();\n  const _6 = data.read8();\n  const _7 = data.read8();\n  const rotation = data.read8() as Rotation8;\n  const _8 = data.read8();\n  const isPatrolling = data.read8Bool();\n  const course2 = data.read(4);\n  const course3 = data.read(4);\n  const empty = data.read(30);\n\n  return {\n    id,\n    playerId,\n    type,\n    position: position,\n    rotation,\n    isPatrolling,\n    hp\n  };\n}\n","/*\n * The savegame data structure was reverse-engineered by Benedikt Freisen\n * as part of the 'mdcii-engine' project and released under GPLv2+.\n * https://github.com/roybaer/mdcii-engine\n */\n\nimport { Point } from \"pixi.js\";\nimport Stream from \"../../parsers/stream\";\nimport assert from \"../../util/assert\";\n\nexport type Producer = Readonly<ReturnType<typeof producerFromSaveGame>>;\n\nexport function producerFromSaveGame(data: Stream) {\n  const islandId = data.read8();\n  const position = new Point(data.read8(), data.read8());\n  const speed = data.read8();\n  const speedCount = data.read8();\n\n  // TODO: Without Math.floor, some producers have x.5 goods. Investigate why.\n  const stock = Math.floor(data.read16() / 32);\n\n  assert(Number.isInteger(stock));\n\n  data.read8();\n\n  const timer = data.read16();\n\n  // TODO: Without Math.floor, some producers have x.5 goods. Investigate why.\n  const secondGoodStock = Math.floor(data.read16() / 32);\n  // TODO: Without Math.floor, some producers have x.5 goods. Investigate why.\n  const firstGoodStock = Math.floor(data.read16() / 32);\n\n  assert(Number.isInteger(firstGoodStock));\n  assert(Number.isInteger(secondGoodStock));\n\n  data.read8();\n\n  const producedGood = data.read8();\n\n  // The following two values are used to calculate the \"Auslastung\"\n\n  // Increased by 32 whenever \"stock\" is increased.\n  const prodCnt = data.read16() / 32;\n  const timeCnt = data.read16();\n\n  const flags1 = data.read8();\n  const active = (flags1 & (1 << 0)) > 0;\n  const connectedToMarket = (flags1 & (1 << 1)) > 0;\n\n  const animCnt = (flags1 >> 2) & 0b1111;\n  const allowGoodPickup = (flags1 & (1 << 6)) === 0;\n\n  const noGoodCnt = data.read8() & 0b1111;\n  assert(data.read16() === 0);\n\n  return {\n    // The island id.\n    islandId,\n    // The position relative to the island.\n    position,\n    /*\n      > BYTE speed; //  Welcher Speedzhler (MAXWACHSSPEEDKIND)\n      > immer 0\n\n      Always 0 in a big savegame.\n    */\n    speed,\n    /*\n      > UINT speedcnt:8; //  Wenn (Zeitzhler == Speedzhler) timer++ (MAXROHWACHSCNT)\n      > 0x07, 0x05, 0x04, 0x03, 0x00 (irgendetwas, blockweise konstant, unterscheidet sich pro Spielstand maximal um 1)\n\n      Always runs from 0 to 7 and repeats.\n      It appears to be synchronized across all buildings and was the same value for all buildings in a big savegame.\n      It is equal to the global \"timers.cntProduction\".\n    */\n    speedCount,\n\n    /**\n     * The amount of goods already produced and waiting for pickup.\n     */\n    stock,\n\n    /**\n     * The timer is decremented every second, regardless of whether or not\n     * the building has enough input goods to produce something. Once it would reach 0\n     * (i.e., the timer never actually reaches 0):\n     * If there are enough input goods to produce an output good (= producedGood is 128):\n     *   - the timer is set to \"HAUS_PRODTYP.Interval\"\n     *   - \"stock\" is incremented\n     *   - \"firstGoodStock\" is decremented by \"HAUS_PRODTYP.Rohmenge\"\n     *   - \"secondGoodStock\" ???\n     *   - \"noGoodCnt\" is set to 0\n     * If there are NOT enough goods (= producedGood is not 128):\n     *   - it is set to 11 (at least for \"Webstube\")\n     *   - \"noGoodCnt\" is increased (up to a maximum of 15)\n     *\n     * Whenever new input goods are delivered and there were previously not enough\n     * input goods to create output goods, the timer is immediately set to\n     * \"HAUS_PRODTYP.Interval\" ??\n     *\n     * I am unsure why the timer is running even when no goods are currently being\n     * produced.\n     */\n    timer,\n\n    // The amount of primary input goods waiting to be used.\n    // They are only \"taken\" when an output good is finished.\n    firstGoodStock,\n    // The amount of secondary input goods waiting to be used (normally wood).\n    // This is 0 for buildings which don't use secondary goods.\n    // They are only \"taken\" when an output good is finished.\n    secondGoodStock,\n\n    producedGood,\n    prodCnt,\n    timeCnt,\n    active,\n\n    /**\n     * Appears to always be false.\n     * In a big savegame, this was true only for a single building: One of the native HQs.\n     */\n    connectedToMarket,\n\n    // Always 0 for a \"Webstube\"\n    animCnt,\n    allowGoodPickup,\n\n    /**\n     * Increased up to a maximum of 15 whenever \"timer\" reaches 0 and no good could be produced,\n     * otherwise set to 0.\n     * Once it reaches (4?) the \"no input goods\" symbol is displayed above the building.\n     */\n    noGoodCnt\n  };\n}\n","/*\n * The savegame data structure was reverse-engineered by Benedikt Freisen\n * as part of the 'mdcii-engine' project and released under GPLv2+.\n * https://github.com/roybaer/mdcii-engine\n */\n\nimport Stream from \"../../parsers/stream\";\nimport assert from \"../../util/assert\";\n\ninterface ReachInhabitants {\n  count: number; // require n inhabitants\n  requiredLevel: number; // out of the n, a few need to reach level x\n  requiredLevelCount: number; // require y of n inhabitants with level x\n}\n\nexport type Task = ReturnType<typeof taskFromSaveGame>;\n\nexport function taskFromSaveGame(data: Stream) {\n  const id = data.read32();\n  const _1 = data.read(28);\n\n  const monopolyGoodId1 = data.read8();\n  assert(data.read8() === 0);\n  const monopolyGoodId2 = data.read8();\n  assert(data.read8() === 0);\n  const helpOtherToReachInhabitantsPlayerId = data.read8(); // Can be 0, 1, 2, 3 or 7 for any player.\n\n  assert(data.read(6).every(e => e === 0));\n\n  const playersToKill = [];\n  if (data.read8Bool()) {\n    // Any does not include trader, pirate and native.\n    playersToKill.push(\"any\");\n  }\n  if (data.read8Bool()) {\n    playersToKill.push(\"red\");\n  }\n  if (data.read8Bool()) {\n    playersToKill.push(\"blue\");\n  }\n  if (data.read8Bool()) {\n    playersToKill.push(\"yellow\");\n  }\n  if (data.read8Bool()) {\n    playersToKill.push(\"white\");\n  }\n  if (data.read8Bool()) {\n    // Should never be true\n    playersToKill.push(\"trader\");\n  }\n  if (data.read8Bool()) {\n    playersToKill.push(\"pirate\");\n  }\n  if (data.read8Bool()) {\n    // Should never be true\n    playersToKill.push(\"native\");\n  }\n\n  const _3 = data.read(25);\n\n  const requiredBalance = data.read32();\n  const successVideoId = data.read32();\n  const requiredTradeBalance = data.read32();\n  const _5 = data.read(16);\n\n  const text = data.readString(2048);\n\n  const _6 = data.read(8);\n\n  const ownCityReachInhabitants: ReachInhabitants[] = [];\n  for (let i = 0; i < 3; i++) {\n    ownCityReachInhabitants.push({\n      count: data.read32(),\n      requiredLevel: data.read32(),\n      requiredLevelCount: data.read32()\n    });\n  }\n\n  const _7 = data.read(36);\n\n  const helpOtherToReachInhabitants: ReachInhabitants = {\n    count: data.read32(),\n    requiredLevel: data.read32(),\n    requiredLevelCount: data.read32()\n  };\n\n  console.log(\"task\", id, _1, _3, _5, _6, _7);\n\n  return {\n    id,\n    text,\n    successVideoId,\n    playersToKill,\n    requiredBalance,\n    requiredTradeBalance,\n    ownCityReachInhabitants,\n    helpOtherToReachInhabitantsPlayerId,\n    helpOtherToReachInhabitants,\n    monopolyGoodId1,\n    monopolyGoodId2\n  };\n}\n","/*\n * The savegame data structure was reverse-engineered by Benedikt Freisen\n * as part of the 'mdcii-engine' project and released under GPLv2+.\n * https://github.com/roybaer/mdcii-engine\n */\n\nimport Stream from \"../../parsers/stream\";\nimport assert from \"../../util/assert\";\n\nexport type Timers = ReturnType<typeof timersFromSaveGame>;\n\nexport function timersFromSaveGame(data: Stream) {\n  const cntCity = data.read8();\n  const cntIsland = data.read8();\n  const cntShipyard = data.read8();\n  const cntMilitary = data.read8();\n  const cntProduction = data.read8();\n  assert(data.read(31 + 32).every(e => e === 0));\n  const cntSettlers = data.read(32);\n  const cntGrowth = data.read(32);\n\n  const timeCity = data.read32();\n  const timeIsland = data.read32();\n  const timeShipyard = data.read32();\n  const timeMilitary = data.read32();\n  const timeProduction = data.read32();\n  const timeGoodToolsCnt = data.read32();\n  const timeGoodToolsMax = data.read32();\n  const timeGame = data.read32(); // Incremented every 100ms\n\n  const noErzOutFlg = data.read8();\n  const tutorFlg = data.read8();\n  const aiLevel = data.read8();\n  const missionNumber = data.read8();\n\n  const flags = data.read32();\n  const enableTrader = (flags & (1 << 6)) === 0;\n  const bigIronRunsOut = (flags & (1 << 3)) === 0;\n  const enableDroughts = (flags & (1 << 2)) === 0; // TODO: Does not appear to be working for endless games.\n  const enablePirate = (flags & (1 << 0)) === 0;\n  const enableVulcano = (flags & (1 << 8)) === 0;\n\n  const gameId = data.read32();\n  const cityNameNumber = data.read32();\n  const timeNextDrought = data.read32();\n  const timePirateSec = data.read32();\n  const missionSubNumber = data.read32();\n  const shipMax = data.read32();\n\n  // vulcano\n  data.read(4);\n  // vulcano 2\n  data.read(4);\n\n  const timeNextVulcano = data.read32();\n  const cntVulcano = data.read32();\n\n  data.read(17 + 32, 4);\n  // assert(data.read(17 + 32, 4).every((e) => e === 0));\n  const timeSettlers = data.read(32, 4);\n  const timeGrowth = data.read(32, 4);\n\n  const timers = {\n    /**\n     * Range: 0 to 7\n     * Update: Every 10 ticks (100 game time)\n     * Influence: ???\n     */\n    cntCity,\n    /**\n     * Range: 0 to 7\n     * Update: Every 30 ticks (300 game time)\n     * Influence: ???\n     */\n    cntIsland,\n    /**\n     * Range: 0 to 7\n     * Updaste: Every tick (10 game time)\n     * Influence: ???\n     */\n    cntShipyard,\n    /**\n     * Range: 0 to 7\n     * Updaste: Every tick (10 game time)\n     * Influence: ???\n     */\n    cntMilitary,\n    /**\n     * Range: 0 to 7\n     * Update: Every tick (10 game time)\n     * Influence: Whenever the timer reaches 0, all production buildings which are currently not producing\n     *            but active check if enough input goods have arrived in the meantime.\n     */\n    cntProduction,\n\n    cntSettlers,\n    cntGrowth,\n    timeCity,\n    timeIsland,\n    timeShipyard,\n    timeMilitary,\n    timeProduction,\n    timeGoodToolsCnt,\n    timeGoodToolsMax,\n    timeGame,\n    noErzOutFlg,\n    tutorFlg,\n    aiLevel,\n    missionNumber,\n    gameId,\n    cityNameNumber,\n    timeNextDrought,\n    timePirateSec,\n    missionSubNumber,\n    shipMax,\n    timeNextVulcano,\n    cntVulcano,\n    timeSettlers,\n    timeGrowth,\n    enableTrader,\n    bigIronRunsOut,\n    enableDroughts,\n    enablePirate,\n    enableVulcano\n  };\n  console.log(timers);\n\n  return timers;\n}\n","/*\n * The savegame data structure was reverse-engineered by Benedikt Freisen\n * as part of the 'mdcii-engine' project and released under GPLv2+.\n * https://github.com/roybaer/mdcii-engine\n */\n\nimport { Point } from \"pixi.js\";\nimport { IslandSizeId } from \"../../parsers/GAM/island-loader\";\nimport Stream from \"../../parsers/stream\";\nimport assert from \"../../util/assert\";\n\nexport interface IslandTemplate {\n  num: number;\n  size: 0 | 1 | 2 | 3 | 4;\n  position: Point;\n  climate: \"NORTH\" | \"SOUTH\" | \"ANY\";\n  numBaseIsland: number;\n}\n\nexport default class WorldGenerationSettings {\n  public static fromSaveGame(data: Stream) {\n    const _1 = data.slice(100);\n\n    const numNativesNorth = _1[64];\n    const numNativesSouth = _1[68];\n\n    const numIslands = data.read32();\n\n    const _2 = data.slice(268);\n\n    const numBigIronOre = _2[46]; // Erzberg:    ERZBERG_GROSS, 6\n    const numSmallIronOre = _2[54]; // Erzberg:    ERZBERG_KLEIN, 8\n    const numGoldOre = _2[62];\n\n    const numWine = _2[110]; // Ware:       WEINTRAUBEN, 4\n    const numSugarCane = _2[95]; // Ware:       ZUCKERROHR, 3\n    const numSpice = _2[86]; // Ware:       GEWUERZBAUM, 2\n    const numCacao = _2[118]; // Ware:       KAKAOBAUM, 2\n    const numTobacco = _2[78]; // Ware:       TABAKBAUM, 3\n    const numCotton = _2[102]; // Ware:       BAUMWOLLE, 3\n\n    const numTreasures = _2[174]; // Schatz:     10\n\n    const islandTemplates: IslandTemplate[] = [];\n    for (let i = 0; i < numIslands; i++) {\n      const flags = data.read8();\n      const forceNorth = flags === 0;\n      const forceSouth = flags === 1;\n      const islandSize = data.read8(); // 0...4, where 0 is small and 4 is large.\n      if (islandSize < 0 || islandSize > 4) {\n        throw new Error(`Invalid island size category: ${islandSize}.`);\n      }\n      assert(data.read8() === 0x0000);\n      const num = data.read8();\n      const numBaseIsland = data.read16(); // 0xFFFF for random\n      assert(data.read16() === 0);\n      const position = new Point(data.read32(), data.read32());\n      islandTemplates.push({\n        num,\n        size: islandSize as IslandSizeId,\n        position: position,\n        climate: forceNorth ? \"NORTH\" : forceSouth ? \"SOUTH\" : \"ANY\",\n        numBaseIsland\n      });\n    }\n    for (const each of data.slice(data.length - data.position())) {\n      assert(each === 0);\n    }\n\n    // function dbg(arr: Uint8Array) {\n    //    let debug = \"\";\n    //    for (const each of arr) {\n    //        debug += `${each}\\n`;\n    //    }\n    //    console.log(debug);\n    // }\n    // dbg(_1);\n    // dbg(_2);\n\n    return new WorldGenerationSettings(\n      numNativesNorth,\n      numNativesSouth,\n      numBigIronOre,\n      numSmallIronOre,\n      numGoldOre,\n      numWine,\n      numSugarCane,\n      numSpice,\n      numCacao,\n      numTobacco,\n      numCotton,\n      numTreasures,\n      islandTemplates\n    );\n  }\n\n  public static empty() {\n    return new WorldGenerationSettings(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, []);\n  }\n\n  constructor(\n    public readonly numNativesNorth: number,\n    public readonly numNativesSouth: number,\n    public readonly numBigIronOre: number,\n    public readonly numSmallIronOre: number,\n    public readonly numGoldOre: number,\n    public readonly numWine: number,\n    public readonly numSugarCane: number,\n    public readonly numSpice: number,\n    public readonly numCacao: number,\n    public readonly numTobacco: number,\n    public readonly numCotton: number,\n    public readonly numTreasures: number,\n    public readonly islandTemplates: IslandTemplate[]\n  ) {}\n}\n","import Stream from \"../stream\";\n\nexport class Block {\n  public static empty(type: string) {\n    return new Block(type, 0, new Stream(new Uint8Array()));\n  }\n\n  public static fromStream(data: Stream) {\n    return new Block(data.readString(16), data.read32(), data);\n  }\n\n  public readonly data: Stream;\n\n  constructor(\n    public readonly type: string,\n    public readonly length: number,\n    data: Stream\n  ) {\n    this.data = new Stream(data.slice(length));\n  }\n}\n\nexport class IslandBlock extends Block {\n  public inselHausBlocks: Block[] = [];\n}\n","import {\n  islandFromIsland3File,\n  islandFromIsland4File,\n  islandFromIsland5File\n} from \"../../game/world/island\";\nimport World from \"../../game/world/world\";\nimport WorldGenerationSettings from \"../../game/world/world-generation-settings\";\nimport assert from \"../../util/assert\";\nimport { Block } from \"./block\";\nimport IslandLoader from \"./island-loader\";\n\nexport default class WorldGenerator {\n  constructor(private islandLoader: IslandLoader) {}\n\n  public async populateWorld(\n    world: World,\n    worldGenerationSettings: WorldGenerationSettings\n  ) {\n    let nextIslandId = Math.max(...world.islands.map(island => island.id)) + 1;\n\n    for (const islandTemplate of worldGenerationSettings.islandTemplates) {\n      const { data, isSouth, id: numBaseIsland } =\n        islandTemplate.numBaseIsland === 0xffff\n          ? await this.islandLoader.loadRandomIslandFile(\n              islandTemplate.size,\n              islandTemplate.climate\n            )\n          : {\n              isSouth: islandTemplate.climate === \"SOUTH\",\n              id: islandTemplate.numBaseIsland,\n              data: await this.islandLoader.loadIslandFileNum({\n                isSouth: islandTemplate.climate === \"SOUTH\",\n                numBaseIsland: islandTemplate.numBaseIsland,\n                size: islandTemplate.size\n              })\n            };\n\n      const blocks: Block[] = [];\n      while (!data.eof()) {\n        blocks.push(Block.fromStream(data));\n      }\n\n      const inselBlock = blocks.find(block =>\n        [\"INSEL5\", \"INSEL4\", \"INSEL3\"].includes(block.type)\n      );\n      assert(inselBlock !== undefined);\n      const inselHausBlock = blocks.find(block => block.type === \"INSELHAUS\");\n      assert(inselHausBlock !== undefined);\n\n      // TODO: Place random things:\n      // numNativesNorth,\n      // numNativesSouth,\n      // numBigIronOre,\n      // numSmallIronOre,\n      // numGoldOre,\n      // numWine,\n      // numSugarCane,\n      // numSpice,\n      // numCacao,\n      // numTobacco,\n      // numCotton,\n      // numTreasures,\n\n      let newIsland;\n      switch (inselBlock!.type) {\n        case \"INSEL5\":\n          newIsland = islandFromIsland5File(\n            nextIslandId++,\n            islandTemplate.position,\n            isSouth,\n            numBaseIsland,\n            inselBlock!.data\n          );\n          break;\n        case \"INSEL4\":\n          newIsland = islandFromIsland4File(\n            nextIslandId++,\n            islandTemplate.position,\n            isSouth,\n            numBaseIsland,\n            inselBlock!.data\n          );\n          break;\n        case \"INSEL3\":\n          newIsland = islandFromIsland3File(\n            nextIslandId++,\n            islandTemplate.position,\n            isSouth,\n            numBaseIsland,\n            inselBlock!.data\n          );\n          break;\n        default:\n          throw new Error(\"This code cannot be reached.\");\n      }\n\n      this.islandLoader.setIslandFields(newIsland, [inselHausBlock!]);\n\n      world.islands.push(newIsland);\n    }\n  }\n}\n","enum GAME {\n  // TODO Add more translations\n  \"menu.divider.orginal_missions\" = 85,\n  \"menu.divider.missions\" = 86,\n  \"menu.divider.new_missions\" = 87,\n  \"menu.divider.custom_missions\" = 88,\n  \"exit_game\" = 89,\n  \"exit_game_question\" = 90\n}\n\n// TODO: [LEISTE]\nenum LEISTE {}\n\nenum PLAYCOL {\n  \"player.color.red\",\n  \"player.color.blue\",\n  \"player.color.yellow\",\n  \"player.color.white\" = 3\n}\n\nenum VIDEOKIND {\n  \"videos.event\",\n  \"videos.battle\",\n  \"videos.diplomacy\"\n}\n\nenum SPEECHKIND {\n  \"speech.event\",\n  \"speech.island_status\",\n  \"speech.player\",\n  \"speech.trade\",\n  \"speech.battle\",\n  \"speech.order\",\n  \"speech.diplomacy\"\n}\n\n// Ignore [ERROR]\n\nenum PATH {\n  \"path.custom_missions\"\n}\n\nenum ENDLESSKIND {\n  \"endless.difficulty.easy\",\n  \"endless.difficulty.medium\",\n  \"endless.difficulty.difficult\",\n  \"endless.difficulty.hard\"\n}\n\nenum TUTORKIND {\n  \"tutorial.mission_0\",\n  \"tutorial.mission_1\",\n  \"tutorial.mission_2\",\n  \"tutorial.mission_3\",\n  \"tutorial.mission_4\"\n}\n\nenum KAMPAGNE {\n  \"campaign.0.mission_0\",\n  \"campaign.0.mission_1\",\n  \"campaign.0.mission_2\",\n  \"campaign.0.mission_3\",\n  \"campaign.0.mission_4\",\n\n  \"campaign.1.mission_0\",\n  \"campaign.1.mission_1\",\n  \"campaign.1.mission_2\",\n  \"campaign.1.mission_3\",\n  \"campaign.1.mission_4\",\n\n  \"campaign.2.mission_0\",\n  \"campaign.2.mission_1\",\n  \"campaign.2.mission_2\",\n  \"campaign.2.mission_3\",\n  \"campaign.2.mission_4\",\n\n  \"campaign.3.mission_0\",\n  \"campaign.3.mission_1\",\n  \"campaign.3.mission_2\",\n  \"campaign.3.mission_3\",\n  \"campaign.3.mission_4\",\n\n  \"campaign.4.mission_0\",\n  \"campaign.4.mission_1\",\n  \"campaign.4.mission_2\",\n  \"campaign.4.mission_3\",\n  \"campaign.4.mission_4\",\n\n  \"campaign.5.mission_0\",\n  \"campaign.5.mission_1\",\n  \"campaign.5.mission_2\",\n  \"campaign.5.mission_3\",\n  \"campaign.5.mission_4\"\n}\n\nenum FIGKIND {\n  \"figure.unused\",\n  \"figure.infantry\",\n  \"figure.cavalry\",\n  \"figure.musketeer\",\n  \"figure.artiellery\"\n}\n\nenum WARE {\n  \"good.empty\",\n  \"good.each\",\n  \"good.iron_ore\",\n  \"good.gold_ore\",\n  \"good.wool\",\n  \"good.sugarcane\",\n  \"good.tobacco\",\n  \"good.cattle\",\n  \"good.grain\",\n  \"good.flour\",\n  \"good.iron\",\n  \"good.swords\",\n  \"good.muskets\",\n  \"good.cannons\",\n  \"good.food\",\n  \"good.tobacco_products\",\n  \"good.spices\",\n  \"good.cocoa\",\n  \"good.liquor\",\n  \"good.cloth\",\n  \"good.clothes\",\n  \"good.jewlry\",\n  \"good.tools\",\n  \"good.wood\",\n  \"good.bricks\"\n}\n\n// Ignore WAREM\n\nenum ROHST {\n  \"rohst.grain\",\n  \"rohst.tobacco\",\n  \"rohst.spices\",\n  \"rohst.sugarcane\",\n  \"rohst.cotton\",\n  \"rohst.vines\",\n  \"rohst.cocoa\",\n  \"rohst.grazing_land\",\n  \"rohst.tree\",\n  \"rohst.stones\",\n  \"rohst.ores\",\n  \"rohst.wild_game\",\n  \"rohst.fish\"\n}\n\nenum ROHSTFELD {\n  \"rohst_field.grain\",\n  \"rohst_field.tobacco\",\n  \"rohst_field.spices\",\n  \"rohst_field.sugarcane\",\n  \"rohst_field.cotton\",\n  \"rohst_field.vines\",\n  \"rohst_field.cocoa\",\n  \"rohst_field.grazing_land\",\n  \"rohst_field.tree\",\n  \"rohst_field.stones\",\n  \"rohst_field.ores\",\n  \"rohst_field.wild_game\",\n  \"rohst_field.fish\"\n}\n\nenum MILITAR {\n  \"buildings.military.wooden.wall\",\n  \"buildings.military.wooden.gate\",\n  \"buildings.military.wooden.watchtower\",\n  \"buildings.military.stone.wall\",\n  \"buildings.military.stone.gate\",\n  \"buildings.military.stone.watchtower\",\n  \"buildings.military.stone.gate_big\",\n  \"buildings.military.castle.small\",\n  \"buildings.military.castle.medium\",\n  \"buildings.military.castle.large\"\n}\n\nenum WOHNHAUS {\n  \"buildings.house.house\"\n}\n\nenum STRASSE {\n  \"buildings.street.dirt.street\",\n  \"buildings.street.stone.street\",\n  \"buildings.street.dirt.bridge\",\n  \"buildings.street.stone.bridge\",\n  \"buildings.street.square.0\",\n  \"buildings.street.square.1\",\n  \"buildings.street.square.2\",\n  \"buildings.street.square.3\"\n}\n\nenum BERGWERK {\n  \"buildings.mine.quarry\",\n  \"buildings.mine.iron\",\n  \"buildings.mine.iron_deep\",\n  \"buildings.mine.gold\"\n}\n\nenum HANDWERK {\n  \"buildings.production.weaver\",\n  \"buildings.production.butcher\",\n  \"buildings.production.flour_mill\",\n  \"buildings.production.bakery\",\n  \"buildings.production.tobacco\",\n  \"buildings.production.distillery\",\n  \"buildings.production.tailor\",\n  \"buildings.production.weaving_mill\",\n  \"buildings.production.stonemason\",\n  \"buildings.production.water_mill\",\n  \"buildings.production.ore_smelter\",\n  \"buildings.production.tool_maker\",\n  \"buildings.production.gold_smith\",\n  \"buildings.production.armourer\",\n  \"buildings.production.musket_maker\",\n  \"buildings.production.canon_foundry\"\n}\n\nenum FARM {\n  \"buildings.farm.hunter\",\n  \"buildings.farm.forester\",\n  \"buildings.field.forest\",\n  \"buildings.farm.grain\",\n  \"buildings.field.grain\",\n  \"buildings.farm.sheep\",\n  \"buildings.farm.cattle\",\n  \"buildings.farm.tobacco\",\n  \"buildings.field.tobacco\",\n  \"buildings.farm.spice\",\n  \"buildings.field.spice\",\n  \"buildings.farm.wine\",\n  \"buildings.field.wine\",\n  \"buildings.farm.sugarcane\",\n  \"buildings.field.sugarcane\",\n  \"buildings.farm.cotton\",\n  \"buildings.field.cotton\",\n  \"buildings.farm.cocoa\",\n  \"buildings.field.cocoa\"\n}\n\nenum HAFEN {\n  \"buildings.docks.warehouse.0\",\n  \"buildings.docks.warehouse.1\",\n  \"buildings.docks.warehouse.2\",\n  \"buildings.docks.warehouse.3\",\n  \"buildings.docks.fisher\",\n  \"buildings.docks.dock\",\n  \"buildings.docks.shipyard.small\",\n  \"buildings.docks.shipyard.large\"\n}\n\nenum DIVERS {\n  \"buildings.public.house\",\n  \"buildings.public.marketplace\",\n  \"buildings.public.chapel\",\n  \"buildings.public.church\",\n  \"buildings.public.cathedral\",\n  \"buildings.public.tavern\",\n  \"buildings.public.doctor\",\n  \"buildings.public.school\",\n  \"buildings.public.college\",\n  \"buildings.public.bathhouse\",\n  \"buildings.public.theater\",\n  \"buildings.public.firefighters\",\n  \"buildings.public.palace\",\n  \"buildings.public.gallows\",\n  \"buildings.public.monument\",\n  \"buildings.public.triumphal_arch\"\n}\n\nenum ABRISS {\n  \"demolish\"\n}\n\nenum LANDSCHAFT {\n  \"natives.0.head_lodge\",\n  \"natives.0.hut.0\",\n  \"natives.0.hut.1\",\n  \"natives.0.hut.2\",\n  \"natives.0.hut.3\",\n  \"natives.1.head_lodge\",\n  \"natives.1.hut.0\",\n  \"natives.1.hut.1\",\n  \"natives.1.hut.2\",\n  \"natives.1.hut.3\",\n  \"natives.pyramid\",\n  \"pirates.warehouse\",\n  \"pirates.1\",\n  \"pirates.2\",\n  \"pirates.tower\",\n  \"forest.mixed\",\n  \"forest.palm\"\n}\n\n// Ignore [BUBBLES]\n\n// Ignore [TUTOR]\n\n// Ignore [MELDUNG]\n\n// Ignore [STAEDTE]\n\n// Ignore [SHIPS]\n\n// Ignore [DEMO]\n\nconst lookup = {\n  GAME,\n  LEISTE,\n  PATH,\n  ENDLESSKIND,\n  PLAYCOL,\n  VIDEOKIND,\n  SPEECHKIND,\n  TUTORKIND,\n  KAMPAGNE,\n  FIGKIND,\n  WARE,\n  ROHST,\n  ROHSTFELD,\n  MILITAR,\n  WOHNHAUS,\n  STRASSE,\n  BERGWERK,\n  HANDWERK,\n  FARM,\n  HAFEN,\n  DIVERS,\n  ABRISS,\n  LANDSCHAFT\n};\n\nexport default lookup;\n\ntype GetKeys<U> = U extends Record<infer K, any> ? K : never;\ntype UnionToIntersection<U extends object> = {\n  [K in GetKeys<U>]: U extends Record<K, infer T> ? T : never;\n};\nexport type TranslationKeys = keyof UnionToIntersection<\n  (typeof lookup)[keyof typeof lookup]\n>;\n\nexport type TranslationDomain = keyof typeof lookup;\n","/*\n * The savegame data structure was reverse-engineered by Benedikt Freisen\n * as part of the 'mdcii-engine' project and released under GPLv2+.\n * https://github.com/roybaer/mdcii-engine\n */\n\nimport { castleFromSaveGame } from \"../../game/world/castle\";\nimport { cityFromSaveGame } from \"../../game/world/city\";\nimport { Island, islandFromSaveGame } from \"../../game/world/island\";\nimport { kontorFromSaveGame } from \"../../game/world/kontor\";\nimport { Player, playerFromSaveGame } from \"../../game/world/player\";\nimport { producerFromSaveGame } from \"../../game/world/producer\";\nimport { shipFromSaveGame } from \"../../game/world/ship\";\nimport { soldierFromSaveGame } from \"../../game/world/soldier\";\nimport { taskFromSaveGame } from \"../../game/world/task\";\nimport { timersFromSaveGame } from \"../../game/world/timers\";\nimport { traderFromSaveGame } from \"../../game/world/trader\";\nimport World from \"../../game/world/world\";\nimport WorldGenerationSettings from \"../../game/world/world-generation-settings\";\nimport assert from \"../../util/assert\";\nimport Stream from \"../stream\";\nimport { Block, IslandBlock } from \"./block\";\nimport IslandLoader from \"./island-loader\";\nimport WorldGenerator from \"./world-generator\";\n\nexport default class GAMParser {\n  private worldGenerator: WorldGenerator | null;\n\n  constructor(private islandLoader: IslandLoader | null) {\n    this.worldGenerator = islandLoader\n      ? new WorldGenerator(islandLoader)\n      : null;\n  }\n\n  public parse(data: Stream) {\n    const blocks: Map<string, Block[]> = new Map();\n    while (!data.eof()) {\n      const block = Block.fromStream(data);\n      if (block.type !== \"INSELHAUS\") {\n        if (!blocks.has(block.type)) {\n          blocks.set(block.type, []);\n        }\n        blocks.get(block.type)!.push(block);\n      } else {\n        const lastIslandBlock = blocks.get(\"INSEL5\")![\n          blocks.get(\"INSEL5\")!.length - 1\n        ] as IslandBlock;\n        if (lastIslandBlock.inselHausBlocks === undefined) {\n          lastIslandBlock.inselHausBlocks = [];\n        }\n        lastIslandBlock.inselHausBlocks.push(block);\n      }\n    }\n    return blocks;\n  }\n\n  public async getWorld(data: Stream) {\n    const blocks = this.parse(data);\n    const { world, worldGenerationSettings } = await this.doParse(blocks);\n\n    await this.worldGenerator!.populateWorld(world, worldGenerationSettings);\n\n    return world;\n  }\n\n  public async doParse(blocks: Map<string, Block[]>) {\n    // console.log([...blocks.keys()].map(key => [key, blocks.get(key).length]));\n    console.log(\n      [...blocks.keys()]\n        .filter(\n          key => blocks.get(key)!.find(block => block.length > 0) !== undefined\n        )\n        .map(key => [key, blocks.get(key)])\n    );\n\n    let gameName = \"\";\n    if (blocks.has(\"NAME\")) {\n      // Missions don't have a name.\n      const nameBlock = blocks.get(\"NAME\")![0];\n      gameName = nameBlock.data.readString(nameBlock.length);\n    }\n\n    const playerBlock = blocks.get(\"PLAYER4\")![0];\n    const players = this.parsePlayers(playerBlock);\n\n    const islandBlocks = blocks.has(\"INSEL5\")\n      ? (blocks.get(\"INSEL5\") as IslandBlock[])\n      : [];\n    const islands = await this.parseIslands(islandBlocks);\n\n    const tasks = this.handleBlock(blocks, \"AUFTRAG4\", taskFromSaveGame);\n    const ships = this.handleBlock(blocks, \"SHIP4\", shipFromSaveGame);\n    const soldiers = this.handleBlock(blocks, \"SOLDAT3\", soldierFromSaveGame);\n    const kontors = this.handleBlock(blocks, \"KONTOR2\", kontorFromSaveGame);\n    const castles = this.handleBlock(blocks, \"MILITAR\", castleFromSaveGame);\n    const cities = this.handleBlock(blocks, \"STADT4\", cityFromSaveGame);\n    const producers = this.handleBlock(\n      blocks,\n      \"PRODLIST2\",\n      producerFromSaveGame\n    );\n\n    // TODO: HIRSCH2, WERFT, SIEDLER, ROHWACHS2, MARKT2, TURM, WIFF\n    let trader = null;\n    if (blocks.has(\"HANDLER\") && blocks.get(\"HANDLER\")![0].length > 0) {\n      trader = traderFromSaveGame(blocks.get(\"HANDLER\")![0].data);\n    }\n\n    assert(blocks.has(\"TIMERS\"));\n    assert(blocks.get(\"TIMERS\")!.length === 1);\n    const timers = timersFromSaveGame(blocks.get(\"TIMERS\")![0].data);\n\n    let worldGenerationSettings = WorldGenerationSettings.empty();\n    if (blocks.has(\"SZENE\")) {\n      const data = blocks.get(\"SZENE\")![0].data;\n      worldGenerationSettings = WorldGenerationSettings.fromSaveGame(data);\n    }\n\n    const world = new World(\n      islands,\n      players,\n      tasks,\n      gameName,\n      soldiers,\n      ships,\n      kontors,\n      castles,\n      cities,\n      trader,\n      timers,\n      producers\n    );\n\n    return { world, worldGenerationSettings };\n  }\n\n  private handleBlock<T>(\n    blocks: Map<string, Block[]>,\n    name: string,\n    fromSaveGame: (data: Stream) => T\n  ): T[] {\n    if (!blocks.has(name)) {\n      return [];\n    }\n    const entities: T[] = [];\n    for (const block of blocks.get(name)!) {\n      while (!block.data.eof()) {\n        entities.push(fromSaveGame(block.data));\n      }\n    }\n    return entities;\n  }\n\n  private async parseIslands(islandBlocks: IslandBlock[]) {\n    const islands: Island[] = [];\n    if (!this.islandLoader) {\n      return islands;\n    }\n\n    for (const islandBlock of islandBlocks) {\n      const island = islandFromSaveGame(islandBlock.data);\n      const islandBuildingBlocks =\n        islandBlock.inselHausBlocks !== undefined\n          ? islandBlock.inselHausBlocks\n          : [];\n\n      let islandTopBlock = Block.empty(\"INSELHAUS\");\n      let islandBottomBlock;\n      if (!island.differsFromBaseIsland && islandBuildingBlocks.length <= 1) {\n        if (islandBuildingBlocks.length === 1) {\n          islandTopBlock = islandBuildingBlocks[0];\n        }\n\n        const islandFile = await this.islandLoader.loadIslandFile(island);\n\n        // The basis block contains the same information already present in\n        // the island block of the savegame. We can safely skip over it.\n        const islandBasisBlock = Block.fromStream(islandFile);\n        // TODO: New Horizons 0 has a basis block of INSEL3\n        // assert(islandBasisBlock.type === \"INSEL5\", `Expected different island basis block ${islandBasisBlock.type}`);\n\n        islandBottomBlock = Block.fromStream(islandFile);\n        assert(islandBottomBlock.type === \"INSELHAUS\");\n        // TODO: There are some more HIRSCH blocks we ignore.\n      } else {\n        assert(\n          islandBuildingBlocks.length >= 1 && islandBuildingBlocks.length <= 2\n        );\n        islandBottomBlock = islandBuildingBlocks[0];\n        if (islandBuildingBlocks.length === 2) {\n          islandTopBlock = islandBuildingBlocks[1];\n        }\n      }\n      this.islandLoader.setIslandFields(island, [\n        islandBottomBlock,\n        islandTopBlock\n      ]);\n\n      islands.push(island);\n    }\n    return islands;\n  }\n\n  private parsePlayers(block: Block) {\n    const players: Player[] = [];\n    while (!block.data.eof()) {\n      players.push(playerFromSaveGame(block.data));\n    }\n    return players;\n  }\n}\n","/*\n * The savegame data structure was reverse-engineered by Benedikt Freisen\n * as part of the 'mdcii-engine' project and released under GPLv2+.\n * https://github.com/roybaer/mdcii-engine\n */\n\nimport Stream from \"../../parsers/stream\";\n\nexport type Trader = ReturnType<typeof traderFromSaveGame>;\n\nexport function traderFromSaveGame(data: Stream) {\n  const _1 = data.read32();\n  const _2 = data.read(5 * 4);\n  const goods = parseGoods(data);\n  const _3 = data.read(292);\n\n  console.log(\"trader\", _1, _2, goods, _3);\n\n  return {\n    goods\n  };\n}\n\nfunction parseGoods(data: Stream) {\n  const goods = [];\n  for (let i = 0; i < 24; i++) {\n    goods.push({\n      goodId: data.read32(),\n      _1: data.read32(),\n      _2: data.read32()\n    });\n  }\n  return goods;\n}\n","import FileSystem from \"../filesystem\";\nimport lookup, { TranslationKeys } from \"./translations\";\n\nconst translations: Map<TranslationKeys, string> = new Map();\n\nexport default function t(key: TranslationKeys): string {\n  return translations.get(key) || \"?\";\n}\n\nexport async function loadTranslations(fs: FileSystem) {\n  const jsonData = JSON.parse(\n    await fs.openAndGetContentAsText(\"/translations.json\")\n  );\n  for (const domain of Object.keys(jsonData)) {\n    const keyToIdxMapping = (lookup as any)[domain];\n\n    for (const translationIdx in keyToIdxMapping) {\n      if (parseInt(translationIdx, 10) >= 0) {\n        const translationKey = keyToIdxMapping[translationIdx];\n        translations.set(translationKey, jsonData[domain][translationIdx]);\n      }\n    }\n  }\n}\n","import { BitmapText, Container, Sprite } from \"pixi.js\";\nimport FileSystem from \"../../filesystem\";\nimport GAMParser from \"../../parsers/GAM/gam-parser\";\nimport t from \"../../translation/translator\";\nimport assert from \"../../util/assert\";\nimport MenuStructure, { ScreenConfig } from \"../menu-structure\";\n\nexport default class Missions implements ScreenConfig {\n  public buttons = [\n    this.renderNewGame.bind(this),\n    this.renderLoadGame.bind(this),\n    async () => {\n      await this.menuStructure.renderScreen(\"menu_loading\");\n      this.menuStructure.emit(\"load-game\", \"/saves/lastgame.gam\");\n    },\n    async () => this.menuStructure.renderScreen(\"menu_main\"),\n    async (stage: Container) => {\n      this.currentPage = Math.max(0, this.currentPage - 1);\n      await this.renderNewGame(stage);\n    },\n    async (stage: Container) => {\n      this.currentPage = Math.min(\n        Math.ceil(this.newGameLines.length / this.ROWS) - 1,\n        this.currentPage + 1\n      );\n      await this.renderNewGame(stage);\n    }\n  ];\n\n  private readonly ROWS = 14;\n\n  private readonly SCROLL_UP = \"menu-31011\";\n  private readonly SCROLL_DOWN = \"menu-31012\";\n\n  private newGameLines: Array<{\n    name: string;\n    difficulty?: number;\n    file?: WebKitFileEntry;\n  }> = [];\n\n  private currentPage = 0;\n  private gamParser: GAMParser;\n\n  constructor(\n    private readonly fs: FileSystem,\n    private readonly menuStructure: MenuStructure\n  ) {\n    this.gamParser = new GAMParser(null);\n  }\n\n  public async onLoad(stage: Container) {\n    await this.getNewGameLines();\n\n    await this.renderNewGame(stage);\n    await this.menuStructure._playMainMenuMusic();\n  }\n\n  public async renderNewGame(stage: Container) {\n    const currentTopItem = this.currentPage * this.ROWS;\n\n    for (let i = 0; i < this.ROWS; i++) {\n      const bitmapText = stage.getChildByName(\n        `menu-${31021 + i}`\n      ) as BitmapText;\n\n      bitmapText.off(\"click\");\n      bitmapText.visible = false;\n      bitmapText.interactive = false;\n      bitmapText.buttonMode = false;\n\n      if (i + currentTopItem < this.newGameLines.length) {\n        const line = this.newGameLines[i + currentTopItem];\n        bitmapText.text = line.name;\n        bitmapText.visible = true;\n        if (line.file) {\n          bitmapText.interactive = true;\n          bitmapText.buttonMode = true;\n          bitmapText.once(\"click\", async () => {\n            await this.menuStructure.renderScreen(\"menu_loading\");\n            this.menuStructure.emit(\"load-game\", line.file!.fullPath);\n          });\n        }\n      }\n    }\n    for (let i = 0; i < this.ROWS; i++) {\n      const sprite = stage.getChildByName(`menu-${31041 + i}`) as Sprite;\n      sprite.visible =\n        i + currentTopItem < this.newGameLines.length &&\n        !!this.newGameLines[i + currentTopItem].file;\n    }\n    for (let i = 0; i < this.ROWS; i++) {\n      const sprite = stage.getChildByName(`menu-${31061 + i}`) as Sprite;\n      sprite.visible = false;\n    }\n\n    stage.getChildByName(this.SCROLL_UP).visible = true;\n    stage.getChildByName(this.SCROLL_DOWN).visible = true;\n  }\n\n  public async renderLoadGame(stage: Container) {\n    const saves = (await this.fs.ls(\"/saves\", \".gam\")).filter(\n      save => save.name !== \"lastgame.gam\"\n    );\n\n    const maxSaveGames = 12;\n    for (let i = 0; i < this.ROWS; i++) {\n      const bitmapText = stage.getChildByName(\n        `menu-${31021 + i}`\n      ) as BitmapText;\n      bitmapText.visible = i < maxSaveGames;\n      if (i < saves.length) {\n        // TODO: Read name from Game.dat\n        bitmapText.text = `Game${i.toString().padStart(2, \"0\")}`;\n        bitmapText.interactive = true;\n        bitmapText.buttonMode = true;\n        bitmapText.once(\"click\", async () => {\n          await this.menuStructure.renderScreen(\"menu_loading\");\n          this.menuStructure.emit(\"load-game\", saves[i].fullPath);\n        });\n      } else {\n        bitmapText.text = `Empty${i.toString().padStart(2, \"0\")}`;\n      }\n    }\n    for (let i = 0; i < this.ROWS; i++) {\n      const sprite = stage.getChildByName(`menu-${31041 + i}`) as Sprite;\n      sprite.visible = false;\n    }\n    for (let i = 0; i < this.ROWS; i++) {\n      // TODO: Read players (from Game.dat ?)\n      const sprite = stage.getChildByName(`menu-${31061 + i}`) as Sprite;\n      sprite.visible = i < maxSaveGames;\n    }\n\n    stage.getChildByName(this.SCROLL_UP).visible = false;\n    stage.getChildByName(this.SCROLL_DOWN).visible = false;\n  }\n\n  private async getNewGameLines() {\n    const missions = await this.loadMissions();\n\n    this.newGameLines.push({ name: t(\"menu.divider.orginal_missions\") });\n\n    missions\n      .filter(mission => mission.missionNum !== -1)\n      .forEach(mission => {\n        this.newGameLines.push({\n          name: mission.name,\n          file: mission.file as WebKitFileEntry\n        });\n      });\n\n    this.newGameLines.push({ name: t(\"menu.divider.missions\") });\n\n    this.newGameLines.push({ name: t(\"menu.divider.new_missions\") });\n\n    missions\n      .filter(mission => mission.missionNum === -1)\n      .forEach(mission => {\n        this.newGameLines.push({\n          name: mission.name,\n          file: mission.file as WebKitFileEntry\n        });\n      });\n\n    this.newGameLines.push({ name: t(\"menu.divider.custom_missions\") });\n    const customMissions = await this.fs.ls(\"/missions-custom\", \".szs\");\n    customMissions.forEach(mission => {\n      this.newGameLines.push({\n        name: mission.name.replace(\".szs\", \"\"),\n        file: mission as WebKitFileEntry\n      });\n    });\n  }\n\n  private async loadMissions() {\n    const missions = await Promise.all(\n      (await this.fs.ls(\"/missions-original\", \".szs\")).map(async mission => {\n        const data = await this.fs.openAndGetContentAsStream(mission);\n        const blocks = this.gamParser.parse(data);\n        let ranking = -1; // NOT the number of stars\n        if (blocks.has(\"SZENE_RANKING\")) {\n          assert(blocks.get(\"SZENE_RANKING\")!.length === 1);\n          ranking = blocks.get(\"SZENE_RANKING\")![0].data.read32();\n        }\n        let campaignNum = -1;\n        if (blocks.has(\"SZENE_KAMPAGNE\")) {\n          assert(blocks.get(\"SZENE_KAMPAGNE\")!.length === 1);\n          campaignNum = blocks.get(\"SZENE_KAMPAGNE\")![0].data.read32();\n        }\n        // The missionNum denotes which\n        let missionNum = -1;\n        if (blocks.has(\"SZENE_MISSNR\")) {\n          assert(blocks.get(\"SZENE_MISSNR\")!.length === 1);\n          missionNum = blocks.get(\"SZENE_MISSNR\")![0].data.read32();\n        }\n\n        return {\n          blocks,\n          ranking,\n          campaignNum,\n          missionNum,\n          name: mission.name,\n          file: mission\n        };\n      })\n    );\n    missions.sort((a, b) => {\n      if (a.missionNum !== -1 && b.missionNum === -1) {\n        return -1;\n      } else if (a.missionNum === -1 && b.missionNum !== -1) {\n        return 1;\n      } else if (a.missionNum !== -1 && b.missionNum !== -1) {\n        if (a.missionNum < b.missionNum) {\n          return -1;\n        } else if (a.missionNum > b.missionNum) {\n          return 1;\n        } else {\n          // TODO: Sort missions within mission\n          return 0;\n        }\n      } else {\n        // TODO: Sort otherwise\n        return 0;\n      }\n    });\n\n    console.table(missions);\n\n    return missions;\n  }\n}\n","import { BaseTexture, Container, Sprite, Texture } from \"pixi.js\";\nimport { utils } from \"pixi.js\";\nimport FileSystem from \"../filesystem\";\nimport { textureFromUint8ArrayMP4 } from \"../util/pixi\";\nimport GADRenderer from \"./gad-renderer\";\nimport Missions from \"./menu/missions\";\nimport MusicPlayer from \"./music-player\";\n\ntype Callback = (stage: Container) => void;\n\nexport interface ScreenConfig {\n  onLoad: Callback;\n  buttons: Callback[];\n}\n\nexport default class MenuStructure extends utils.EventEmitter {\n  private readonly structure: { [k: string]: ScreenConfig } = {\n    menu_main: {\n      onLoad: () => this._playMainMenuMusic(),\n      buttons: [\n        async () => this.renderScreen(\"menu_missions\"),\n        async () => console.log(\"Multiplayer\"),\n        async () => {\n          // Credits\n          this.musicPlayer.stop();\n          const videoSprite = await this.loadVideoSprite(10);\n          videoSprite.width = 453 - 14;\n          videoSprite.height = 367 - 14;\n          videoSprite.position.set(500 + 7, 359 + 7);\n          this.gadRenderer.renderVideo(\n            videoSprite,\n            () => this._playMainMenuMusic\n          );\n        },\n        async () => {\n          // Intro\n          const videoSprite = await this.loadVideoSprite(58);\n          this.musicPlayer.stop();\n          this.gadRenderer.renderVideoFullscreen(videoSprite, () =>\n            this.renderScreen(\"menu_main\")\n          );\n        },\n        async () => console.log(\"Exit\")\n      ]\n    },\n    menu_missions: new Missions(this.fs, this),\n    menu_loading: {\n      onLoad: () => {\n        // Nothing to do\n      },\n      buttons: []\n    },\n    menu_mission_details: {\n      onLoad: () => {\n        // Nothing to do\n      },\n      buttons: [\n        async () => console.log(\"Start Mission\"),\n        async () => this.renderScreen(\"menu_missions\"),\n        async () => console.log(\"Highscores up\"),\n        async () => console.log(\"Highscores down\"),\n        async () => console.log(\"Sub-Mission 0\"),\n        async () => console.log(\"Sub-Mission 1\"),\n        async () => console.log(\"Sub-Mission 2\"),\n        async () => console.log(\"Sub-Mission 3\"),\n        async () => console.log(\"Sub-Mission 4\"),\n        async () => console.log(\"Mission Description up\"),\n        async () => console.log(\"Mission Description down\"),\n        async () => console.log(\"Mission Description Slider\")\n      ]\n    }\n  };\n\n  constructor(\n    private readonly fs: FileSystem,\n    private readonly gadRenderer: GADRenderer,\n    private readonly musicPlayer: MusicPlayer\n  ) {\n    super();\n  }\n\n  public async renderScreen(screen: string) {\n    const data = JSON.parse(\n      await this.fs.openAndGetContentAsText(`/screens/${screen}.json`)\n    );\n    console.log(data);\n    const config = this.structure[screen] || {\n      onLoad: () => {\n        /* Nothing to do */\n      },\n      buttons: []\n    };\n    await this.gadRenderer.render(data, config);\n  }\n\n  public async _playMainMenuMusic() {\n    await this.musicPlayer.play(\"1st Beginning\", true);\n  }\n\n  private async loadVideoSprite(videoNumber: number) {\n    const videoData = await this.fs.openAndGetContentAsUint8Array(\n      `/videos/${videoNumber}.mp4`\n    );\n    return Sprite.from(await textureFromUint8ArrayMP4(videoData));\n  }\n}\n","import pixiSound from \"pixi-sound\";\nimport FileSystem from \"../filesystem\";\n\nconst Sound = pixiSound.Sound;\n\nexport default class MusicPlayer {\n  private playing = false;\n  private readonly songs: Array<{ name: string; sound: pixiSound.Sound }> = [];\n  private currentSongIdx: number;\n\n  constructor(private readonly fs: FileSystem) {}\n\n  public async load() {\n    const files = await this.fs.ls(\"/music\");\n    for (const file of files) {\n      console.log(`Loading music ${file.name}`);\n      const data = (await this.fs.openAndGetContentAsUint8Array(file))\n        .buffer as ArrayBuffer;\n      this.songs.push({ name: file.name, sound: await this.loadSound(data) });\n      console.log(`Finished loading music ${file.name}`);\n    }\n  }\n\n  public async play(name: string, loop: boolean = false) {\n    const song = this.songs.find(each => each.name === name + \".wav\");\n    if (song === undefined) {\n      console.warn(`Song ${name} not found.`);\n      return;\n    }\n    if (!song.sound.isPlaying) {\n      await song.sound.play({ loop: loop });\n    }\n  }\n\n  public async playAll() {\n    if (this.songs.length === 0) {\n      console.warn(\"No music to play found :(\");\n      return;\n    }\n    if (this.playing) {\n      console.warn(\"Music is already playing!\");\n      return;\n    }\n    this.stop();\n\n    this.playing = true;\n    this.currentSongIdx = -1;\n    await this.playNext();\n  }\n\n  public stop() {\n    this.songs.forEach(song => song.sound.stop());\n  }\n\n  private async playNext() {\n    this.currentSongIdx++;\n    if (this.currentSongIdx === this.songs.length) {\n      this.currentSongIdx = 0;\n    }\n    await this.songs[this.currentSongIdx].sound.play(this.playNext.bind(this));\n  }\n\n  private loadSound(data: ArrayBuffer, preload: boolean = false) {\n    return new Promise<pixiSound.Sound>((resolve, reject) => {\n      const sound = Sound.from({\n        source: data,\n        preload: preload,\n        singleInstance: true,\n        loaded: (err: Error, preloadedSound: pixiSound.Sound | undefined) => {\n          if (preload) {\n            if (err) {\n              reject(err);\n            } else {\n              resolve(preloadedSound);\n            }\n          }\n        }\n      });\n      if (!preload) {\n        resolve(sound);\n      }\n    });\n  }\n}\n","/*\n * The savegame data structure was reverse-engineered by Benedikt Freisen\n * as part of the 'mdcii-engine' project and released under GPLv2+.\n * https://github.com/roybaer/mdcii-engine\n */\n\nimport Stream from \"../../parsers/stream\";\nimport assert from \"../../util/assert\";\nimport { Rotation4 } from \"./world\";\n\nexport default class Field {\n  public static saveGameDataLength = 8;\n\n  public static fromSaveGame(data: Stream) {\n    const buildingId = data.read16() + 20000;\n    const x = data.read8();\n    const y = data.read8();\n    const bits = data.read32();\n\n    const rotation = (bits >> 0) & (2 ** 2 - 1);\n    const animation = (bits >> 2) & (2 ** 4 - 1);\n    const islandId = (bits >> 6) & (2 ** 8 - 1);\n    const islandCityNum = (bits >> 14) & (2 ** 3 - 1);\n    const random = (bits >> 17) & (2 ** 5 - 1);\n    const playerId = (bits >> 22) & (2 ** 4 - 1);\n    const empty = (bits >> 26) & (2 ** 6 - 1);\n    if (empty !== 0) {\n      // empty is sometimes 51.\n      // console.warn(`Expected 0, got ${empty}.`);\n    }\n\n    return new Field(\n      buildingId,\n      x,\n      y,\n      islandId,\n      islandCityNum,\n      rotation as Rotation4,\n      animation,\n      random,\n      playerId\n    );\n  }\n\n  constructor(\n    public fieldId: number,\n    public x: number,\n    public y: number,\n    public islandId: number,\n    public islandCityNum: number,\n    public rotation: Rotation4,\n    public ani: number,\n    public random: number,\n    public playerId: number\n  ) {}\n}\n","import FileSystem from \"../../filesystem\";\nimport FieldType from \"../../game/field-type\";\nimport Field from \"../../game/world/field\";\nimport { Island } from \"../../game/world/island\";\nimport assert from \"../../util/assert\";\nimport { Block } from \"./block\";\n\nexport type IslandSizeId = 0 | 1 | 2 | 3 | 4;\n\nexport type IslandSizeName = \"lit\" | \"mit\" | \"med\" | \"big\" | \"lar\";\n\ninterface IslandSize {\n  id: IslandSizeId;\n  name: IslandSizeName;\n  maxSize: number;\n}\n\nexport default class IslandLoader {\n  private readonly islandSizes: IslandSize[] = [\n    {\n      id: 0,\n      name: \"lit\",\n      maxSize: 35\n    },\n    {\n      id: 1,\n      name: \"mit\",\n      maxSize: 45\n    },\n    {\n      id: 2,\n      name: \"med\",\n      maxSize: 55\n    },\n    {\n      id: 3,\n      name: \"big\",\n      maxSize: 85\n    },\n    {\n      id: 4,\n      name: \"lar\",\n      maxSize: 100\n    }\n  ];\n\n  constructor(\n    private fs: FileSystem,\n    private fieldData: ReadonlyMap<number, FieldType>\n  ) {}\n\n  public async loadIslandFile(island: Island) {\n    const climate = island.isSouth ? \"south\" : \"north\";\n    const islandNumber = island.numBaseIsland.toString().padStart(2, \"0\");\n    for (const islandSize of this.islandSizes) {\n      if (island.size.x <= islandSize.maxSize) {\n        return this.fs.openAndGetContentAsStream(\n          `/islands/${climate}/${islandSize.name}${islandNumber}.scp`\n        );\n      }\n    }\n\n    throw new Error(\"Could not load island\");\n  }\n\n  public async loadIslandFileNum(island: {\n    isSouth: boolean;\n    numBaseIsland: number;\n    size: IslandSizeId;\n  }) {\n    const climate = island.isSouth ? \"south\" : \"north\";\n    const islandNumber = island.numBaseIsland.toString().padStart(2, \"0\");\n    const islandSize = this.islandSizes.find(each => each.id === island.size)!;\n    return this.fs.openAndGetContentAsStream(\n      `/islands/${climate}/${islandSize.name}${islandNumber}.scp`\n    );\n\n    throw new Error(\"Could not load island\");\n  }\n\n  public async loadIslandFileByName(name: string) {\n    return this.fs.openAndGetContentAsStream(`/islands/${name}.scp`);\n  }\n\n  public async loadRandomIslandFile(\n    sizeId: 0 | 1 | 2 | 3 | 4,\n    climate: \"NORTH\" | \"SOUTH\" | \"ANY\"\n  ) {\n    const islandSize = this.islandSizes.find(size => size.id === sizeId);\n    if (islandSize === undefined) {\n      throw new Error(\"This should never happen.\");\n    }\n\n    const islandFiles = [];\n    if ([\"ANY\", \"NORTH\"].includes(climate)) {\n      islandFiles.push(\n        ...(await this.loadIslandsWithSizeAndClimate(islandSize.name, \"north\"))\n      );\n    }\n    if ([\"ANY\", \"SOUTH\"].includes(climate)) {\n      islandFiles.push(\n        ...(await this.loadIslandsWithSizeAndClimate(islandSize.name, \"south\"))\n      );\n    }\n\n    const randomIslandFile =\n      islandFiles[Math.floor(Math.random() * islandFiles.length)];\n\n    return {\n      data: await this.fs.openAndGetContentAsStream(\n        randomIslandFile.file.fullPath\n      ),\n      isSouth: randomIslandFile.climate === \"south\",\n      id: randomIslandFile.id\n    };\n  }\n\n  public setIslandFields(island: Island, blocks: Block[]) {\n    island.fields = [];\n    for (let x = 0; x < island.size.x; x++) {\n      island.fields.push(new Array(island.size.y).fill(null));\n    }\n    for (const block of blocks) {\n      const parsedFields = this.parseIslandFields(island, block);\n      for (let x = 0; x < island.size.x; x++) {\n        for (let y = 0; y < island.size.y; y++) {\n          const parsedField = parsedFields[x][y];\n          if (parsedField === null) {\n            continue;\n          }\n          island.fields[x][y] = parsedField;\n        }\n      }\n    }\n  }\n\n  private parseIslandFields(\n    island: Island,\n    block: Block\n  ): Array<Array<Field | null>> {\n    const data = block.data;\n    const dataLength = block.length;\n\n    const fields: Field[][] = [];\n    for (let x = 0; x < island.size.x; x++) {\n      fields.push(new Array(island.size.y).fill(null));\n    }\n\n    for (let i = 0; i < dataLength / Field.saveGameDataLength; i++) {\n      const field = Field.fromSaveGame(data);\n      assert(field.x < island.size.x);\n      assert(field.y < island.size.y);\n      fields[field.x][field.y] = field;\n    }\n\n    return fields;\n  }\n\n  private async loadIslandsWithSizeAndClimate(\n    sizeName: IslandSizeName,\n    climate: \"north\" | \"south\"\n  ) {\n    return (await this.fs.ls(`/islands/${climate}`))\n      .filter(islandFile => islandFile.name.startsWith(sizeName))\n      .filter(islandFile => /\\d\\d\\.scp$/.exec(islandFile.name) !== null)\n      .map(file => {\n        return {\n          file: file,\n          climate: climate,\n          id: parseInt(file.name.substr(3, 2), 10)\n        };\n      });\n  }\n}\n","import AsyncLock from \"async-lock\";\nimport { Spritesheet, Texture } from \"pixi.js\";\nimport FileSystem from \"./filesystem\";\nimport { textureFromUint8ArrayPNG } from \"./util/pixi\";\n\nexport default class SpriteLoader {\n  private textures: Map<string, Map<number, Texture>> = new Map();\n  private lock: AsyncLock = new AsyncLock();\n\n  constructor(private readonly fs: FileSystem) {}\n\n  public getTextures = async (directory: string) => {\n    directory = `/gfx/${directory}`;\n\n    // Make sure that textures aren't loaded multiple times at once.\n    await this.lock.acquire(directory, async () => {\n      if (!this.textures.has(directory)) {\n        await this.loadTextures(directory);\n      }\n    });\n    return this.textures.get(directory)!;\n  };\n\n  private loadTextures = async (directory: string) => {\n    const textureMap = new Map();\n\n    const files = await this.fs.ls(directory);\n    for (const file of files) {\n      const fileExtension = file.name.substr(file.name.lastIndexOf(\".\") + 1);\n      if (fileExtension === \"png\") {\n        const dataFileName =\n          file.fullPath.substring(0, file.fullPath.lastIndexOf(\".\")) + \".json\";\n        const spriteSheetData = JSON.parse(\n          await this.fs.openAndGetContentAsText(dataFileName)\n        );\n\n        const spriteSheetImageData = await this.fs.openAndGetContentAsUint8Array(\n          file\n        );\n        const tex = textureFromUint8ArrayPNG(spriteSheetImageData);\n        const spritesheet = new Spritesheet(tex.baseTexture, spriteSheetData);\n\n        const textures = await new Promise<{ [key: string]: Texture }>(\n          (resolve, reject) => {\n            spritesheet.parse((sheet: any, hmm: any) => {\n              // This appears to be a bug.\n              resolve(sheet as { [key: string]: Texture });\n            });\n          }\n        );\n\n        for (const gfxId of Object.keys(textures)) {\n          const texture = textures[gfxId];\n          textureMap.set(parseInt(gfxId, 10), texture);\n        }\n      }\n    }\n    this.textures.set(directory, textureMap);\n  };\n}\n","// prettier-ignore\nconst idxToColors = new Uint8Array([\n  0x00, 0x00, 0x00,\n  0x80, 0x00, 0x00,\n  0x00, 0x80, 0x00,\n  0x80, 0x80, 0x00,\n  0x00, 0x00, 0x80,\n  0x6d, 0x1f, 0x6c,\n  0x00, 0x80, 0x80,\n  0xc0, 0xc0, 0xc0,\n  0xff, 0x00, 0xff,\n  0xff, 0x00, 0xff,\n  0x00, 0x00, 0x00,\n  0x00, 0x04, 0x04,\n  0x00, 0x08, 0x08,\n  0x00, 0x10, 0x00,\n  0x0b, 0x06, 0x03,\n  0x15, 0x08, 0x00,\n  0x25, 0x04, 0x00,\n  0x00, 0x14, 0x04,\n  0x06, 0x16, 0x06,\n  0x00, 0x21, 0x00,\n  0x03, 0x26, 0x03,\n  0x0e, 0x1c, 0x05,\n  0x08, 0x31, 0x04,\n  0x20, 0x18, 0x00,\n  0x1b, 0x2c, 0x00,\n  0x0a, 0x0c, 0x12,\n  0x08, 0x1c, 0x14,\n  0x18, 0x16, 0x10,\n  0x23, 0x17, 0x0c,\n  0x01, 0x29, 0x15,\n  0x0c, 0x2c, 0x13,\n  0x18, 0x2b, 0x11,\n  0x23, 0x29, 0x0f,\n  0x0a, 0x16, 0x25,\n  0x0a, 0x2c, 0x25,\n  0x24, 0x1f, 0x1f,\n  0x22, 0x31, 0x1d,\n  0x12, 0x24, 0x2c,\n  0x26, 0x2e, 0x29,\n  0x13, 0x22, 0x40,\n  0x04, 0x3d, 0x06,\n  0x10, 0x3b, 0x06,\n  0x15, 0x3e, 0x08,\n  0x25, 0x3d, 0x04,\n  0x0e, 0x3c, 0x28,\n  0x21, 0x3b, 0x23,\n  0x29, 0x3d, 0x20,\n  0x0e, 0x37, 0x40,\n  0x18, 0x3d, 0x3d,\n  0x21, 0x31, 0x3d,\n  0x25, 0x3d, 0x39,\n  0x11, 0x3a, 0x48,\n  0x29, 0x3d, 0x42,\n  0x11, 0x3c, 0x4e,\n  0x11, 0x3a, 0x5e,\n  0x0d, 0x4d, 0x00,\n  0x25, 0x4e, 0x00,\n  0x12, 0x4d, 0x08,\n  0x17, 0x4d, 0x25,\n  0x1c, 0x4d, 0x48,\n  0x19, 0x4d, 0x58,\n  0x16, 0x49, 0x6e,\n  0x11, 0x5f, 0x03,\n  0x25, 0x62, 0x00,\n  0x16, 0x5d, 0x3d,\n  0x16, 0x70, 0x2d,\n  0x15, 0x96, 0x24,\n  0x19, 0x7c, 0x6b,\n  0x1c, 0x94, 0x71,\n  0x00, 0x52, 0x8c,\n  0x08, 0x4a, 0x90,\n  0xf8, 0xc2, 0x30,\n  0x08, 0x52, 0x94,\n  0x08, 0x56, 0x94,\n  0x0c, 0x4e, 0x8c,\n  0x17, 0x52, 0x88,\n  0x00, 0x63, 0x8c,\n  0x18, 0x5e, 0x8c,\n  0x08, 0x5a, 0x9c,\n  0x0c, 0x5a, 0xa0,\n  0x12, 0x63, 0x94,\n  0x12, 0x65, 0x94,\n  0x0a, 0x75, 0x96,\n  0x08, 0x5a, 0xad,\n  0x08, 0x63, 0xa9,\n  0x0c, 0x67, 0xa5,\n  0x15, 0x68, 0xa5,\n  0x06, 0x79, 0xad,\n  0x13, 0x73, 0xab,\n  0x21, 0x73, 0xa5,\n  0x0a, 0x76, 0xb5,\n  0x18, 0x77, 0xb1,\n  0x21, 0x73, 0xad,\n  0x21, 0x7b, 0xb1,\n  0x18, 0x75, 0xbb,\n  0x08, 0x88, 0xbd,\n  0x0b, 0x88, 0xc4,\n  0x11, 0x88, 0xdc,\n  0x21, 0x9c, 0x84,\n  0x00, 0x9c, 0x94,\n  0x18, 0x9c, 0xb1,\n  0x00, 0x9c, 0xd6,\n  0x0c, 0x94, 0xce,\n  0xc4, 0x78, 0x5e,\n  0x0b, 0xad, 0xd8,\n  0x08, 0x94, 0xe7,\n  0x08, 0x94, 0xef,\n  0x0c, 0xa0, 0xe6,\n  0x1c, 0x98, 0xe2,\n  0x15, 0xb2, 0xe1,\n  0x10, 0xb1, 0xef,\n  0x18, 0xbd, 0xe7,\n  0x21, 0xbd, 0xde,\n  0x00, 0x94, 0xf7,\n  0x50, 0x96, 0xe2,\n  0x00, 0x9c, 0xff,\n  0xe0, 0x8a, 0x6c,\n  0xf2, 0x99, 0x7a,\n  0xe9, 0x71, 0x02,\n  0xff, 0x7d, 0x02,\n  0x08, 0xa5, 0xf7,\n  0xfb, 0xd8, 0x34,\n  0xf4, 0xaf, 0x2d,\n  0x10, 0x9c, 0xf7,\n  0x18, 0x94, 0xef,\n  0x14, 0x98, 0xfb,\n  0xff, 0xfc, 0x9d,\n  0x21, 0xa5, 0xf7,\n  0x36, 0x11, 0x04,\n  0x4a, 0x11, 0x04,\n  0x35, 0x2d, 0x0c,\n  0x46, 0x2c, 0x0b,\n  0x3c, 0x4a, 0x0b,\n  0x29, 0x63, 0x00,\n  0x3b, 0x5a, 0x13,\n  0x2d, 0x67, 0x00,\n  0x2e, 0x70, 0x00,\n  0x2d, 0x63, 0x08,\n  0x2c, 0x6a, 0x11,\n  0x37, 0x6d, 0x02,\n  0x37, 0x6a, 0x11,\n  0x42, 0x6a, 0x03,\n  0x44, 0x6c, 0x10,\n  0x3b, 0x2f, 0x26,\n  0x3e, 0x44, 0x29,\n  0x3b, 0x3d, 0x40,\n  0x3d, 0x4a, 0x3f,\n  0x3c, 0x61, 0x2d,\n  0x41, 0x5b, 0x44,\n  0x3f, 0x4d, 0x4b,\n  0x3c, 0x63, 0x4b,\n  0x31, 0x4c, 0x5a,\n  0x3f, 0x4b, 0x55,\n  0x2e, 0x62, 0x5a,\n  0x41, 0x65, 0x56,\n  0x3a, 0x5f, 0x68,\n  0x37, 0x62, 0x75,\n  0x37, 0x66, 0x8c,\n  0x5e, 0x16, 0x05,\n  0x59, 0x2a, 0x14,\n  0x5a, 0x40, 0x1a,\n  0x59, 0x60, 0x0b,\n  0x5a, 0x5e, 0x2d,\n  0x58, 0x50, 0x46,\n  0x57, 0x66, 0x44,\n  0x59, 0x4f, 0x50,\n  0x55, 0x67, 0x50,\n  0x5d, 0x6b, 0x4d,\n  0x5a, 0x58, 0x59,\n  0x56, 0x6f, 0x5a,\n  0x57, 0x63, 0x62,\n  0x58, 0x66, 0x75,\n  0x73, 0x21, 0x0a,\n  0x71, 0x41, 0x14,\n  0x6f, 0x5f, 0x11,\n  0x6f, 0x52, 0x39,\n  0x6c, 0x6f, 0x41,\n  0x6f, 0x6b, 0x5a,\n  0x6b, 0x68, 0x6b,\n  0x8f, 0x1d, 0x04,\n  0x89, 0x56, 0x0d,\n  0x8c, 0x58, 0x1f,\n  0x89, 0x63, 0x40,\n  0xac, 0x27, 0x05,\n  0xa6, 0x5d, 0x25,\n  0xc5, 0x31, 0x08,\n  0xcd, 0x54, 0x1e,\n  0x29, 0x7e, 0x02,\n  0x31, 0x7b, 0x00,\n  0x35, 0x7f, 0x00,\n  0x42, 0x7b, 0x00,\n  0x34, 0x7b, 0x0b,\n  0x36, 0x7b, 0x14,\n  0x36, 0x7a, 0x49,\n  0x31, 0x84, 0x04,\n  0x42, 0x84, 0x00,\n  0x31, 0x84, 0x14,\n  0x40, 0x84, 0x16,\n  0x35, 0x8c, 0x00,\n  0x35, 0x86, 0x37,\n  0x31, 0x8d, 0x32,\n  0x31, 0xa7, 0x1d,\n  0x53, 0x82, 0x09,\n  0x5b, 0x7e, 0x3e,\n  0x57, 0x79, 0x6b,\n  0x6c, 0x7b, 0x67,\n  0x52, 0xab, 0x06,\n  0x55, 0x91, 0x2f,\n  0x59, 0xb6, 0x29,\n  0x77, 0x7e, 0x3c,\n  0x77, 0x77, 0x69,\n  0x74, 0xb4, 0x30,\n  0xaa, 0x80, 0x2a,\n  0x91, 0x7d, 0x67,\n  0x85, 0xbb, 0x3a,\n  0xca, 0xac, 0x34,\n  0x2b, 0x85, 0x74,\n  0x53, 0x7f, 0x73,\n  0x7f, 0x7c, 0x73,\n  0x7d, 0x8e, 0x73,\n  0x4a, 0x7e, 0x7e,\n  0x49, 0x80, 0xa4,\n  0x76, 0x84, 0x7b,\n  0x76, 0x87, 0x8f,\n  0x2b, 0xa0, 0x7c,\n  0x5f, 0x9c, 0x84,\n  0x2d, 0xb5, 0x88,\n  0x3f, 0xc1, 0x8a,\n  0x5c, 0xa9, 0xbd,\n  0x3f, 0xde, 0xa7,\n  0x56, 0xed, 0xc8,\n  0x90, 0x89, 0x7b,\n  0x8d, 0x99, 0x85,\n  0x98, 0x95, 0x7f,\n  0xaf, 0x9a, 0x7c,\n  0x98, 0xa5, 0x8c,\n  0x98, 0xb2, 0x8d,\n  0xa9, 0xb0, 0x8c,\n  0xcc, 0xc2, 0x85,\n  0x9a, 0xb0, 0xad,\n  0xb9, 0xb6, 0xa0,\n  0xb3, 0xc8, 0xa7,\n  0xac, 0xd1, 0xcf,\n  0xdd, 0xda, 0xb5,\n  0xe1, 0xef, 0xe2,\n  0xfe, 0xfa, 0xe6,\n  0x00, 0x94, 0xff,\n  0xa0, 0xa0, 0xa4,\n  0x80, 0x80, 0x80,\n  0xff, 0x00, 0x00,\n  0x00, 0xff, 0x00,\n  0xff, 0xff, 0x00,\n  0x00, 0x00, 0xff,\n  0xff, 0x00, 0xff,\n  0x00, 0xff, 0xff,\n  0xff, 0xff, 0xff,\n]);\n\nexport default idxToColors;\n\nconst colorsToIdxInner: Record<string, number> = {};\n\nfor (let i = 0; i < idxToColors.length / 3; i++) {\n  const color =\n    (idxToColors[i * 3 + 0] << 24) +\n    (idxToColors[i * 3 + 1] << 16) +\n    (idxToColors[i * 3 + 2] << 8) +\n    0xff;\n  colorsToIdxInner[color.toString()] = i;\n}\n\nexport const colorsToIdx = colorsToIdxInner;\n","/**\n * This code is based on the bin-packing library by Jake Gordon licensed under MIT license.\n *\n * https://github.com/jakesgordon/bin-packing/blob/master/js/packer.js\n */\n\n/******************************************************************************\n This is a very simple binary tree based bin packing algorithm that is initialized\n with a fixed width and height and will fit each block into the first node where\n it fits and then split that node into 2 parts (down and right) to track the\n remaining whitespace.\n Best results occur when the input blocks are sorted by height, or even better\n when sorted by max(width,height).\n Inputs:\n ------\n w:       width of target rectangle\n h:      height of target rectangle\n blocks: array of any objects that have .w and .h attributes\n Outputs:\n -------\n marks each block that fits with a .fit attribute pointing to a\n node with .x and .y coordinates\n Example:\n -------\n var blocks = [\n { w: 100, h: 100 },\n { w: 100, h: 100 },\n { w:  80, h:  80 },\n { w:  80, h:  80 },\n etc\n etc\n ];\n var packer = new Packer(500, 500);\n packer.fit(blocks);\n for(var n = 0 ; n < blocks.length ; n++) {\n    var block = blocks[n];\n    if (block.fit) {\n      Draw(block.fit.x, block.fit.y, block.w, block.h);\n    }\n  }\n ******************************************************************************/\n\ninterface Rect {\n  w: number;\n  h: number;\n  fit?: Node;\n}\n\ninterface Node {\n  x: number;\n  y: number;\n  w: number;\n  h: number;\n  used?: boolean;\n  down?: Node;\n  right?: Node;\n}\n\nexport default class BinPacker {\n  private readonly root: Node;\n\n  constructor(w: number, h: number) {\n    this.root = { x: 0, y: 0, w: w, h: h };\n  }\n\n  public addBlock(block: Rect) {\n    const node = this.findNode(this.root, block.w, block.h);\n    if (node) {\n      return this.splitNode(node, block.w, block.h);\n    } else {\n      return false;\n    }\n  }\n\n  private findNode(root: Node, w: number, h: number): Node | null {\n    if (root.used) {\n      return (\n        this.findNode(root.right!, w, h) || this.findNode(root.down!, w, h)\n      );\n    } else if (w <= root.w && h <= root.h) {\n      return root;\n    } else {\n      return null;\n    }\n  }\n\n  private splitNode(node: Node, w: number, h: number) {\n    node.used = true;\n    node.down = { x: node.x, y: node.y + h, w: node.w, h: node.h - h };\n    node.right = { x: node.x + w, y: node.y, w: node.w - w, h: h };\n    return node;\n  }\n}\n","// eslint-disable-next-line @typescript-eslint/no-var-requires\nconst UPNG = require(\"upng-js/UPNG.js\");\n\nexport default class BSHImage {\n  public width: number;\n  public height: number;\n  public pixels: Uint8Array;\n\n  constructor(width: number, height: number, pixels: Uint8Array) {\n    this.width = width;\n    this.height = height;\n    this.pixels = pixels;\n  }\n\n  public toPNG(): ArrayBuffer {\n    return UPNG.encode([this.pixels.buffer], this.width, this.height);\n  }\n}\n","import * as log from \"loglevel\";\nimport { SmartBuffer, SmartBufferOptions } from \"smart-buffer\";\nimport FileSystem from \"../../filesystem\";\nimport assert from \"../../util/assert\";\nimport Stream from \"../stream\";\nimport BinPacker from \"./bin-packer\";\nimport colorPalette, { colorsToIdx } from \"./bsh-color-palette\";\nimport BSHImage from \"./bsh-image\";\n\n// eslint-disable-next-line @typescript-eslint/no-var-requires\nconst UPNG = require(\"upng-js/UPNG.js\");\n\ninterface AtlasData {\n  meta: {};\n  frames: {\n    [key: string]: {\n      frame: {\n        x: number;\n        y: number;\n        w: number;\n        h: number;\n      };\n      rotated: boolean;\n      trimmed: boolean;\n      spriteSourceSize: {\n        x: number;\n        y: number;\n        w: number;\n        h: number;\n      };\n      sourceSize: {\n        w: number;\n        h: number;\n      };\n    };\n  };\n}\n\nexport interface SpriteSheetConfig {\n  png: ArrayBuffer;\n  config: AtlasData;\n}\n\nexport default class BSHParser {\n  private readonly SPRITESHEET_SIZE = 2048;\n\n  private readonly HEADER_SIZE = 20;\n\n  private log: log.Logger;\n\n  constructor() {\n    this.log = log.getLogger(\"bsh-parser\");\n  }\n\n  public async decodeBSH(data: Stream) {\n    return this.decode(data, \"BSH\");\n  }\n\n  public async decodeZEI(data: Stream) {\n    return this.decode(data, \"ZEI\");\n  }\n\n  public createSpriteSheets(images: BSHImage[]): SpriteSheetConfig[] {\n    const sheets: SpriteSheetConfig[] = [];\n\n    let binPacker = new BinPacker(this.SPRITESHEET_SIZE, this.SPRITESHEET_SIZE);\n    let pixels = new Uint8Array(\n      this.SPRITESHEET_SIZE * this.SPRITESHEET_SIZE * 4\n    );\n    let atlasData: AtlasData = { meta: {}, frames: {} };\n\n    for (let i = 0; i < images.length; i++) {\n      const image = images[i];\n      let result = binPacker.addBlock({ w: image.width, h: image.height });\n      if (result === false) {\n        sheets.push({\n          png: UPNG.encode(\n            [pixels.buffer],\n            this.SPRITESHEET_SIZE,\n            this.SPRITESHEET_SIZE\n          ),\n          config: atlasData\n        });\n        binPacker = new BinPacker(this.SPRITESHEET_SIZE, this.SPRITESHEET_SIZE);\n        pixels = new Uint8Array(\n          this.SPRITESHEET_SIZE * this.SPRITESHEET_SIZE * 4\n        );\n        atlasData = { meta: {}, frames: {} };\n\n        result = binPacker.addBlock({ w: image.width, h: image.height });\n      }\n      if (!result) {\n        throw new Error(\"Could not add image to empty spritesheet!\");\n      }\n\n      const startX = result.x;\n      const startY = result.y;\n\n      let j = 0;\n      for (let y = 0; y < image.height; y++) {\n        for (let x = 0; x < image.width; x++) {\n          const idx =\n            (startX +\n              x +\n              this.SPRITESHEET_SIZE * y +\n              this.SPRITESHEET_SIZE * startY) *\n            4;\n          pixels[idx + 0] = image.pixels[j * 4 + 0];\n          pixels[idx + 1] = image.pixels[j * 4 + 1];\n          pixels[idx + 2] = image.pixels[j * 4 + 2];\n          pixels[idx + 3] = image.pixels[j * 4 + 3];\n          j++;\n        }\n      }\n\n      atlasData.frames[i.toString(10)] = {\n        frame: {\n          x: startX,\n          y: startY,\n          w: image.width,\n          h: image.height\n        },\n        rotated: false,\n        trimmed: false,\n        spriteSourceSize: {\n          x: 0,\n          y: 0,\n          w: image.width,\n          h: image.height\n        },\n        sourceSize: {\n          w: image.width,\n          h: image.height\n        }\n      };\n    }\n\n    sheets.push({\n      png: UPNG.encode(\n        [pixels.buffer],\n        this.SPRITESHEET_SIZE,\n        this.SPRITESHEET_SIZE\n      ),\n      config: atlasData\n    });\n\n    return sheets;\n  }\n\n  public async saveSpriteSheets(\n    fs: FileSystem,\n    sheets: SpriteSheetConfig[],\n    outName: string\n  ) {\n    await fs.mkdir(outName);\n    for (let i = 0; i < sheets.length; i++) {\n      await this.saveSpriteSheet(fs, sheets[i], i, outName);\n    }\n  }\n\n  public encodeBSH(images: BSHImage[]): Buffer {\n    const data = new SmartBuffer();\n    data.writeString(\"BSH\".padEnd(16, \"\\0\"), \"ascii\");\n    data.writeUInt32LE(42);\n\n    images.forEach(() => data.writeUInt32LE(42));\n\n    images.forEach((image, i) => {\n      const imageBuffer = this.encodeImage(image).toBuffer();\n      data.writeUInt32LE(data.writeOffset - this.HEADER_SIZE, 20 + i * 4);\n      data.writeBuffer(imageBuffer);\n    });\n\n    data.writeUInt32LE(data.length - this.HEADER_SIZE, 16);\n\n    return data.toBuffer();\n  }\n\n  /**\n   * The parsing algorithm is based on code from the 'mdcii-engine'\n   * project by Benedikt Freisen released under GPLv2+.\n   * https://github.com/roybaer/mdcii-engine\n   */\n  private async decode(data: Stream, extension: string) {\n    const fileType = data.readString(16);\n    assert(fileType === extension);\n\n    const fileLength = data.read32();\n    assert(this.HEADER_SIZE + fileLength === data.length);\n\n    const imageOffsets: number[] = [];\n    imageOffsets.push(data.read32());\n    const numImages = imageOffsets[0] / 4;\n\n    for (let i = 1; i < numImages; i++) {\n      imageOffsets.push(data.read32());\n    }\n    const images: BSHImage[] = [];\n\n    for (let i = 0; i < numImages; i++) {\n      data.seek(imageOffsets[i] + this.HEADER_SIZE);\n      const bshImage = this.decodeImage(data);\n      if (bshImage !== null) {\n        images.push(bshImage);\n      }\n    }\n\n    return images;\n  }\n\n  private decodeImage(data: Stream): BSHImage | null {\n    const width = data.read32();\n    const height = data.read32();\n    const type = data.read32();\n    const length = data.read32();\n\n    assert(width > 0);\n    assert(height > 0);\n\n    const BYTES_PER_PIXEL = 4;\n    const pixels = new Uint8Array(width * height * BYTES_PER_PIXEL);\n\n    // The image's current row we write to.\n    let rowIdx = 0;\n\n    let targetIdx = 0;\n\n    while (true) {\n      const ch = data.read8();\n      if (ch === 0xff) {\n        break;\n      }\n      if (ch === 0xfe) {\n        // Go to next row. All remaining pixels in this row are empty\n        rowIdx++;\n        targetIdx = rowIdx * width * BYTES_PER_PIXEL;\n      } else {\n        // New row. First check how many pixels are empty and increase targetIdx by that amount\n        const emptyPixels = ch;\n        targetIdx += emptyPixels * BYTES_PER_PIXEL;\n\n        // How many pixels are colored\n        const coloredPixels = data.read8();\n        for (let i = 0; i < coloredPixels; i++) {\n          const idx = data.read8() * 3;\n\n          pixels[targetIdx++] = colorPalette[idx];\n          pixels[targetIdx++] = colorPalette[idx + 1];\n          pixels[targetIdx++] = colorPalette[idx + 2];\n          pixels[targetIdx++] = 0xff;\n        }\n      }\n    }\n    return new BSHImage(width, height, pixels);\n  }\n\n  private encodeImage(image: BSHImage) {\n    const data = new SmartBuffer();\n    data\n      .writeUInt32LE(image.width)\n      .writeUInt32LE(image.height)\n      .writeUInt32LE(1)\n      .writeUInt32LE(42); // This is overwritten later on\n\n    let FEs = 0;\n    for (let y = 0; y < image.height; y++) {\n      let skipPixelsEmpty = 0;\n      let coloredPixels: number[] = [];\n      let state: \"empty\" | \"colored\" = \"empty\";\n      for (let x = 0; x < image.width; x++) {\n        const color =\n          (image.pixels[(y * image.width + x) * 4 + 0] << 24) +\n          (image.pixels[(y * image.width + x) * 4 + 1] << 16) +\n          (image.pixels[(y * image.width + x) * 4 + 2] << 8) +\n          (image.pixels[(y * image.width + x) * 4 + 3] << 0);\n\n        if (color === 0x00000000) {\n          // Transparent pixel\n          if (state === \"empty\") {\n            skipPixelsEmpty++;\n          } else if (state === \"colored\") {\n            while (FEs > 0) {\n              data.writeUInt8(0xfe);\n              FEs--;\n            }\n\n            while (skipPixelsEmpty > 0xfd) {\n              data.writeUInt8(0xfd);\n              data.writeUInt8(0);\n              skipPixelsEmpty -= 0xfd;\n            }\n            data.writeUInt8(skipPixelsEmpty);\n\n            for (let i = 0; i < coloredPixels.length; i += 0xff) {\n              const coloredPixelsSlice = coloredPixels.slice(i, i + 0xff);\n              if (i > 0) {\n                data.writeUInt8(0x00);\n              }\n              data.writeUInt8(coloredPixelsSlice.length);\n              coloredPixelsSlice.forEach(pixel => {\n                const colorIdx = colorsToIdx[pixel];\n                data.writeUInt8(colorIdx);\n              });\n            }\n            skipPixelsEmpty = 1;\n            coloredPixels = [];\n          }\n          state = \"empty\";\n        } else {\n          // Non-transparent pixel\n          state = \"colored\";\n          coloredPixels.push(color);\n        }\n      }\n\n      if (state === \"colored\") {\n        while (FEs > 0) {\n          data.writeUInt8(0xfe);\n          FEs--;\n        }\n\n        while (skipPixelsEmpty > 0xfd) {\n          data.writeUInt8(0xfd);\n          data.writeUInt8(0);\n          skipPixelsEmpty -= 0xfd;\n        }\n        data.writeUInt8(skipPixelsEmpty);\n        for (let i = 0; i < coloredPixels.length; i += 0xff) {\n          const coloredPixelsSlice = coloredPixels.slice(i, i + 0xff);\n          if (i > 0) {\n            data.writeUInt8(0x00);\n          }\n          data.writeUInt8(coloredPixelsSlice.length);\n          coloredPixelsSlice.forEach(pixel => {\n            data.writeUInt8(colorsToIdx[pixel.toString()]);\n          });\n        }\n      }\n      FEs++;\n    }\n    data.writeUInt8(0xff);\n\n    const padding = (4 - (data.length % 4)) % 4; // How many bytes left to make it dividable by 4?\n    for (let i = 0; i < padding; i++) {\n      data.writeUInt8(0x00);\n    }\n    data.writeUInt32LE(data.length, 12);\n\n    return data;\n  }\n\n  private async saveSpriteSheet(\n    fs: FileSystem,\n    sheet: SpriteSheetConfig,\n    spritesheetIndex: number,\n    outName: string\n  ) {\n    await fs.write(\n      `${outName}/sprite-sheet-${spritesheetIndex}.png`,\n      sheet.png\n    );\n    await fs.write(\n      `${outName}/sprite-sheet-${spritesheetIndex}.json`,\n      JSON.stringify(sheet.config)\n    );\n  }\n}\n","import * as log from \"loglevel\";\nimport assert from \"../../util/assert\";\n\nexport default class DATParser {\n  private log: log.Logger;\n\n  private variables: Map<string, any>;\n  private objects: any;\n  private template: object | null;\n  private gfxMap: Map<string, string>;\n\n  private lastGfxName: string | null;\n  private currentObject: string | null;\n  private currentNestedObject: string | null;\n  private currentItem: string | null;\n  private currentNestedItem: number | null;\n\n  constructor() {\n    this.log = log.getLogger(\"dat-parser\");\n  }\n\n  public parse(\n    content: string,\n    initialVariables: Map<string, any> = new Map()\n  ) {\n    this.variables = initialVariables;\n    this.objects = {};\n    this.template = null;\n    this.gfxMap = new Map();\n    this.lastGfxName = null;\n    this.currentObject = null;\n    this.currentNestedObject = null;\n    this.currentItem = null;\n    this.currentNestedItem = 0;\n\n    for (let line of content.split(\"\\n\")) {\n      line = line.split(\";\")[0].trim();\n      if (line.length === 0) {\n        continue;\n      }\n\n      if (\n        line.startsWith(\"Nahrung:\") ||\n        line.startsWith(\"Soldat:\") ||\n        line.startsWith(\"Turm:\")\n      ) {\n        // TODO: Skipped for now.\n        continue;\n      }\n\n      if (line === 'Include: \"TOOLS.INC\"') {\n        assert(initialVariables.size > 0);\n        continue;\n      }\n\n      let result;\n\n      if ((result = /^(@?)(\\w+)\\s*=\\s*((?:\\d+|\\+|\\w+)+)$/.exec(line))) {\n        this.handleConstantAssignment(result);\n        continue;\n      }\n\n      if ((result = /^ObjFill:\\s*([\\w,]+)$/.exec(line))) {\n        this.handleObjFill(result);\n        continue;\n      }\n\n      if ((result = /^Objekt:\\s*(\\w+)$/.exec(line))) {\n        this.handleNestedObjectBegin(result);\n        continue;\n      }\n\n      if (line === \"EndObj\") {\n        this.handleNestedObjectEnd();\n        continue;\n      }\n\n      if ((result = /^(@?)(\\w+):\\s*(.*?)\\s*$/.exec(line))) {\n        this.handleProperty(result);\n        continue;\n      }\n\n      throw new Error(\"Could not parse: \" + line);\n    }\n\n    return {\n      variables: this.mapToObject(this.variables),\n      objects: this.objects,\n      gfx_category_map: this.mapToObject(this.gfxMap)\n    };\n  }\n\n  private handleObjFill(result: RegExpMatchArray) {\n    assert(this.currentObject != null);\n    assert(this.currentItem != null);\n\n    const fill = result[1];\n    const item = this.objects[this.currentObject!].items[this.currentItem!];\n    if (fill.startsWith(\"0,MAX\")) {\n      assert(this.template === null);\n      this.template = item;\n    } else {\n      assert(Object.prototype.hasOwnProperty.call(item, \"nested_objects\"));\n\n      const baseItemNum = this.getValue(null, fill, false);\n      const baseItem = this.objects[this.currentObject!].items[baseItemNum];\n      this.objects[this.currentObject!].items[\n        this.currentItem!\n      ] = this.deepCopy(baseItem);\n\n      if (this.lastGfxName != null) {\n        item.GfxCategory = this.lastGfxName;\n      }\n    }\n  }\n\n  private handleConstantAssignment(result: RegExpMatchArray) {\n    const isMath = result[1].length > 0;\n    const constant = result[2];\n    const value = result[3];\n\n    if (constant.startsWith(\"GFX\")) {\n      if (value === \"0\") {\n        this.gfxMap.set(constant, constant);\n      } else if (value.startsWith(\"GFX\")) {\n        const currentGfx = value.split(\"+\")[0];\n        if (this.gfxMap.has(currentGfx)) {\n          this.gfxMap.set(constant, this.gfxMap.get(currentGfx)!);\n        }\n      }\n    }\n\n    this.variables.set(constant, this.getValue(constant, value, isMath));\n  }\n\n  private handleNestedObjectBegin(result: RegExpMatchArray) {\n    const objectName = result[1];\n    if (this.currentObject === null) {\n      this.currentObject = objectName;\n      this.objects[objectName] = {\n        items: {}\n      };\n    } else if (this.currentNestedObject === null) {\n      assert(this.currentItem !== null);\n      this.currentNestedObject = objectName;\n      this.currentNestedItem = 0;\n      const item = this.objects[this.currentObject].items[this.currentItem!];\n      if (\n        item.nested_objects[this.currentNestedObject] === undefined ||\n        item.nested_objects[this.currentNestedObject][\n          this.currentNestedItem\n        ] === undefined\n      ) {\n        item.nested_objects[this.currentNestedObject] = {\n          [this.currentNestedItem]: {}\n        };\n      }\n    } else {\n      throw new Error(\n        \"It appears like there is more than one nesting level. \" +\n          \"This is not supported by this parser.\"\n      );\n    }\n  }\n\n  private handleNestedObjectEnd() {\n    if (this.currentNestedObject !== null) {\n      this.currentNestedObject = null;\n      this.currentNestedItem = null;\n    } else if (this.currentObject !== null) {\n      this.currentObject = null;\n      this.currentItem = null;\n    } else {\n      throw new Error(\"Received EndObj without current object!\");\n    }\n  }\n\n  private handleProperty(result: RegExpMatchArray) {\n    const isMath = result[1].length > 0;\n    const key = result[2];\n    const valueAsString = result[3];\n\n    const value = this.deepCopy(this.getValue(key, valueAsString, isMath));\n    this.variables.set(key, value);\n\n    if (key === \"Nummer\") {\n      if (this.currentNestedObject === null) {\n        this.currentItem = value;\n\n        this.objects[this.currentObject!].items[this.currentItem!] = {\n          nested_objects: {}\n        };\n        if (this.template !== null) {\n          const tmp = this.deepCopy(this.template);\n          this.objects[this.currentObject!].items[\n            this.currentItem!\n          ] = this.deepMerge(\n            tmp,\n            this.objects[this.currentObject!].items[this.currentItem!]\n          );\n        }\n      } else {\n        this.currentNestedItem = value;\n        this.objects[this.currentObject!].items[\n          this.currentItem!\n        ].nested_objects[this.currentNestedObject][\n          this.currentNestedItem!\n        ] = {};\n      }\n\n      return;\n    }\n    const item = this.objects[this.currentObject!].items[this.currentItem!];\n\n    if (key === \"Gfx\" && valueAsString.startsWith(\"GFX\")) {\n      this.lastGfxName = valueAsString.split(\"+\")[0];\n    }\n\n    if (this.currentNestedObject == null) {\n      item[key] = value;\n      if (this.lastGfxName != null) {\n        item.GfxCategory = this.lastGfxName;\n        item.GfxCategoryMapped = this.gfxMap.get(this.lastGfxName);\n      }\n    } else {\n      const nestedItem =\n        item.nested_objects[this.currentNestedObject][this.currentNestedItem!];\n      if (\n        Object.keys(nestedItem).includes(key) &&\n        this.isObject(nestedItem[key])\n      ) {\n        nestedItem[key] = this.deepMerge(nestedItem[key], value);\n      } else {\n        nestedItem[key] = value;\n      }\n    }\n  }\n\n  private getValue(\n    key: string | null,\n    value: string,\n    isMath: boolean,\n    arrayElement: number = -1\n  ): any {\n    let result;\n    if (isMath) {\n      if ((result = /^([+-])(\\d+)$/.exec(value))) {\n        let oldVal = this.variables.has(key!)\n          ? this.deepCopy(this.variables.get(key!))\n          : null;\n        if (oldVal.toString() === \"RUINE_KONTOR_1\") {\n          // TODO\n          oldVal = 424242;\n        }\n\n        if (arrayElement > -1) {\n          if (key === \"Size\") {\n            oldVal = oldVal[arrayElement === 0 ? \"x\" : \"y\"];\n          } else {\n            oldVal = oldVal[arrayElement];\n          }\n        }\n\n        if (result[1] === \"+\") {\n          return oldVal + parseInt(result[2], 10);\n        }\n        if (result[1] === \"-\") {\n          return oldVal - parseInt(result[2], 10);\n        }\n\n        throw new Error(\"This code should not be reached.\");\n      }\n    }\n\n    if (/^[-+]?\\d+$/.exec(value)) {\n      return parseInt(value, 10);\n    }\n    if (/^[-+]?\\d+\\.\\d+$/.exec(value)) {\n      return parseFloat(value);\n    }\n    if ((result = /^([A-Za-z0-9_]+)(?:\\[(\\d+)])?$/.exec(value))) {\n      const name = result[1];\n      const arrayIdx = result[2];\n      // TODO: When is value not in variables\n      const res = this.variables.has(name)\n        ? this.deepCopy(this.variables.get(name))\n        : name;\n      if (arrayIdx !== undefined) {\n        return res[arrayIdx];\n      }\n      return res;\n    }\n    if (value.includes(\",\")) {\n      const values = value\n        .split(\",\")\n        .map((v, index) => this.getValue(key, v.trim(), isMath, index));\n\n      if (key === \"Size\") {\n        return {\n          x: values[0],\n          y: values[1]\n        };\n      } else if (key === \"Ware\") {\n        const obj: any = {};\n        obj[values[0]] = values[1];\n        return obj;\n      } else {\n        return values;\n      }\n    }\n    if (\n      (result = /^([A-z]+(?:\\[\\d+])?|\\d+)([+-])([A-z]+(?:\\[\\d+])?|\\d+)$/.exec(\n        value\n      ))\n    ) {\n      const op = result[2];\n      const val1 = this.getValue(key, result[1], false);\n      const val2 = this.getValue(key, result[3], false);\n      return op === \"+\" ? val1 + val2 : val1 - val2;\n    }\n\n    throw new Error(\"This code should not be reached.\");\n  }\n\n  private deepCopy(data: any): any {\n    return JSON.parse(JSON.stringify(data));\n  }\n\n  private isObject(item: any) {\n    return item && typeof item === \"object\" && !Array.isArray(item);\n  }\n\n  /**\n   * Deep-Merge two objects.\n   *\n   * Based on code written by CplLL, which was based on code by Salakar.\n   *\n   * https://stackoverflow.com/a/37164538\n   */\n  private deepMerge(target: any, patch: any) {\n    const output = { ...target };\n    if (this.isObject(target) && this.isObject(patch)) {\n      Object.keys(patch).forEach(key => {\n        if (this.isObject(patch[key])) {\n          if (!(key in target)) {\n            Object.assign(output, { [key]: patch[key] });\n          } else {\n            output[key] = this.deepMerge(target[key], patch[key]);\n          }\n        } else {\n          Object.assign(output, { [key]: patch[key] });\n        }\n      });\n    }\n    return output;\n  }\n\n  private mapToObject<K, V>(map: Map<K, V>): object {\n    const obj: any = {};\n    map.forEach((value: V, key: K) => (obj[key] = value));\n    return obj;\n  }\n}\n","import { loadFFmpeg } from \"../../util/ffmpeg\";\n\ninterface FileInfo {\n  data: Uint8Array;\n  name: string;\n}\n\nexport default class SMKParser {\n  private ffmpeg: any;\n  private memory = 100_000_000;\n\n  public async parse(data: Uint8Array): Promise<Uint8Array> {\n    this.ffmpeg = await loadFFmpeg();\n\n    const inputFiles = [{ data, name: \"input.smk\" }];\n    try {\n      const args = this.prepareArguments(true);\n      return await this.convert(args, inputFiles);\n    } catch (e) {\n      if (e.message === \"only-one-audio-stream\") {\n        const args = this.prepareArguments(false);\n        return await this.convert(args, inputFiles);\n      } else {\n        throw e;\n      }\n    }\n  }\n\n  private prepareArguments(mergeAudio: boolean) {\n    const args = [\"-i\", \"input.smk\"];\n    if (mergeAudio) {\n      args.push(\n        ...[\n          \"-filter_complex\",\n          \"[0:a]amerge[c]\", // merge all audio streams into [c]\n          \"-map\",\n          \"[c]\", // use merged audio stream\n          \"-map\",\n          \"0:v:0\" // pass through first video stream\n        ]\n      );\n    }\n    args.push(\n      ...[\n        \"-ac\",\n        \"2\", // use stereo audio\n\n        // H.264 options\n        // https://trac.ffmpeg.org/wiki/Encode/H.264\n        \"-c:v\",\n        \"libx264\",\n        \"-pix_fmt\",\n        \"yuv420p\", // older pix_fmt required for Firefox\n        \"-preset\",\n        \"ultrafast\", // faster encoding, but bigger filesize\n        \"-movflags\",\n        \"+faststart\", // faster loading\n        \"output.mp4\"\n        // \"output.ogg\", // I wish I could use the free ogg format instead of mp4.\n      ]\n    );\n\n    return args;\n  }\n\n  private async convert(args: string[], inputFiles: FileInfo[]) {\n    console.log(`Converting video with arguments ${args.join(\" \")}`);\n\n    return new Promise<Uint8Array>((resolve, reject) => {\n      let output = \"\";\n      const handleOutput = (str: string) => {\n        output += str + \"\\n\";\n        console.log(str);\n      };\n      this.ffmpeg({\n        // apt update && apt -y install binutils pkg-config && cd /src/build && ./build_lgpl.sh\n        arguments: args,\n        files: inputFiles,\n        print: handleOutput,\n        printErr: handleOutput,\n        stdin: () => {\n          // Do nothing. This prevents the browser from \"prompt\"ing the user for input.\n        },\n        TOTAL_MEMORY: this.memory,\n        noExitRuntime: false,\n        returnCallback: (files: FileInfo[]) => {\n          if (\n            output.includes(\n              \"Cannot find a matching stream for unlabeled input pad 1\"\n            )\n          ) {\n            reject(new Error(\"only-one-audio-stream\"));\n          } else if (files.length !== 1) {\n            reject(new Error(\"unknown-error\"));\n          } else {\n            resolve(new Uint8Array(files[0].data));\n          }\n        }\n      });\n    });\n  }\n}\n","import WaveFile from \"wavefile\";\n\ninterface ADPCMChannelStatus {\n  predictor: number;\n  step_index: number;\n}\n\nexport interface RawSamples {\n  left: Int16Array;\n  right: Int16Array;\n  sampleRate: number;\n}\n\n/**\n * This code is based on FFmpeg:\n * https://github.com/FFmpeg/FFmpeg/blob/a8ce6fb425e07e60eb06d3f44992fdb91f23aafb/libavcodec/adpcm.c#L180-L204\n *\n * FFmpeg is licensed under the terms of the GNU Lesser General Public License 2.1 and later.\n */\nexport default class WAVParser {\n  // prettier-ignore\n  private readonly adpcmIndexTable = [\n    -1, -1, -1, -1, 2, 4, 6, 8,\n    -1, -1, -1, -1, 2, 4, 6, 8,\n  ];\n\n  // prettier-ignore\n  private readonly adpcmStepTable = [\n    7,     8,     9,    10,    11,    12,    13,    14,    16,    17,\n    19,    21,    23,    25,    28,    31,    34,    37,    41,    45,\n    50,    55,    60,    66,    73,    80,    88,    97,   107,   118,\n    130,   143,   157,   173,   190,   209,   230,   253,   279,   307,\n    337,   371,   408,   449,   494,   544,   598,   658,   724,   796,\n    876,   963,  1060,  1166,  1282,  1411,  1552,  1707,  1878,  2066,\n    2272,  2499,  2749,  3024,  3327,  3660,  4026,  4428,  4871,  5358,\n    5894,  6484,  7132,  7845,  8630,  9493, 10442, 11487, 12635, 13899,\n    15289, 16818, 18500, 20350, 22385, 24623, 27086, 29794, 32767,\n  ];\n\n  public decode(data: Uint8Array): RawSamples {\n    const wav = new WaveFile(data);\n\n    const bitsPerSample: number = (wav.fmt as any).bitsPerSample;\n    const sampleRate: number = (wav.fmt as any).sampleRate;\n    const channels: number = (wav.fmt as any).numChannels;\n\n    if (bitsPerSample !== 4) {\n      throw new Error(\"Can only convert .wav files with 4 bits per sample.\");\n    }\n    if (channels !== 2) {\n      throw new Error(\"Can only convert .wav files with stereo sound.\");\n    }\n\n    const c1: ADPCMChannelStatus = {\n      step_index: 0,\n      predictor: 0\n    };\n    const c2: ADPCMChannelStatus = {\n      step_index: 0,\n      predictor: 0\n    };\n\n    const samples: Buffer = (wav.data as any).samples;\n    const left = new Int16Array(samples.length);\n    const right = new Int16Array(samples.length);\n    for (let i = 0; i < samples.length; i++) {\n      left[i] = this.decodeADPCM_IMA(c1, samples[i] >>> 4);\n      right[i] = this.decodeADPCM_IMA(c2, samples[i] & 0x0f);\n    }\n\n    return {\n      left,\n      right,\n      sampleRate\n    };\n  }\n\n  public encode(rawData: RawSamples) {\n    const numSamples = rawData.left.length;\n    const samples = new Int16Array(numSamples * 2);\n    for (let i = 0; i < numSamples; i++) {\n      samples[i * 2 + 0] = rawData.left[i];\n      samples[i * 2 + 1] = rawData.right[i];\n    }\n\n    const wav = new WaveFile();\n    wav.fromScratch(2, rawData.sampleRate, \"16\", samples as any);\n    return wav.toBuffer();\n  }\n\n  private av_clip(n: number, min: number, max: number) {\n    return Math.min(Math.max(min, n), max);\n  }\n\n  private av_clip_int16(a: number) {\n    if ((a + 0x8000) & ~0xffff) {\n      return (a >> 31) ^ 0x7fff;\n    } else {\n      return a;\n    }\n  }\n\n  private decodeADPCM_IMA(c: ADPCMChannelStatus, nibble: number) {\n    const step = this.adpcmStepTable[c.step_index];\n    const stepIndex = this.av_clip(\n      c.step_index + this.adpcmIndexTable[nibble],\n      0,\n      88\n    );\n\n    const sign = nibble & 8;\n    const delta = nibble & 7;\n    const diff = ((2 * delta + 1) * step) >>> 3;\n    let predictor = c.predictor;\n    if (sign) {\n      predictor -= diff;\n    } else {\n      predictor += diff;\n    }\n\n    c.predictor = this.av_clip_int16(predictor);\n    c.step_index = stepIndex;\n\n    return c.predictor;\n  }\n}\n","import { uInt8ToBase64 } from \"../../util/util\";\nimport { SpriteSheetConfig } from \"../BSH/bsh-parser\";\n\n// eslint-disable-next-line @typescript-eslint/no-var-requires\nconst xml = require(\"xml\");\n\nexport default class BitmapFontGenerator {\n  public async createBitmapFont(sheets: SpriteSheetConfig[], fontName: string) {\n    const pages = [];\n    const chars = [];\n\n    for (let pageId = 0; pageId < sheets.length; pageId++) {\n      const sheet = sheets[pageId];\n\n      pages.push({\n        page: [\n          {\n            _attr: {\n              id: pageId,\n              file: `data:image/png;base64,${uInt8ToBase64(\n                new Uint8Array(sheet.png)\n              )}`\n              // file: `${pageId}.png`,\n            }\n          }\n        ]\n      });\n\n      for (const idx of Object.keys(sheet.config.frames)) {\n        const config = sheet.config.frames[idx];\n\n        const char = parseInt(idx, 10) + 32;\n        chars.push({\n          char: [\n            {\n              _attr: {\n                id: char,\n                x: config.frame.x,\n                y: config.frame.y,\n                width: config.frame.w,\n                height: config.frame.h,\n                xoffset: 0,\n                yoffset: 0,\n                xadvance: config.frame.w,\n                page: pageId,\n                chnl: 15,\n                letter: String.fromCharCode(char)\n              }\n            }\n          ]\n        });\n      }\n    }\n\n    const fontSize = sheets[0].config.frames[0].sourceSize.h;\n\n    // http://www.angelcode.com/products/bmfont/doc/file_format.html\n    // https://raw.githubusercontent.com/pixijs/examples/gh-pages/required/assets/desyrel.xml\n    const font: any = {\n      font: [\n        {\n          info: [\n            {\n              _attr: {\n                face: fontName,\n                size: fontSize,\n                padding: \"0,0,0,0\",\n                spacing: \"0,0\",\n                italic: \"0\",\n                bold: \"0\",\n                stretchH: \"100\",\n                smooth: \"1\", // unsure\n                aa: \"1\" // unsure\n                // charset\n                // unicode\n              }\n            }\n          ]\n        },\n        {\n          common: [\n            {\n              _attr: {\n                pages: sheets.length,\n                lineHeight: fontSize,\n                // base\n                // scaleW\n                // scaleH\n                packed: 0\n                // alphaChnl\n                // redChnl\n                // greenChnl\n                // blueChnl\n              }\n            }\n          ]\n        },\n        { pages },\n        { chars }\n      ]\n    };\n\n    return xml(font, { indent: \"  \" });\n  }\n}\n","import { TranslationDomain } from \"./translations\";\n\nexport default function parseTranslations(\n  data: string\n): Record<TranslationDomain, string[]> {\n  const translations: any = {};\n  let currentDomain: string | null = null;\n\n  for (const line of data.split(\"\\r\\n\")) {\n    if (currentDomain) {\n      if (line === \"[END]\") {\n        currentDomain = null;\n      } else {\n        translations[currentDomain].push(line);\n      }\n    } else {\n      if (line.startsWith(\"[\")) {\n        currentDomain = line.split(/[[\\]]/)[1];\n        translations[currentDomain] = [];\n      }\n    }\n  }\n\n  return translations as Record<TranslationDomain, string[]>;\n}\n","import * as React from \"react\";\nimport { ChangeEvent } from \"react\";\nimport { UploadLogger } from \"./upload\";\n\ninterface Props {\n  onUploaded: (file: File) => Promise<boolean>;\n  onReset: () => Promise<void>;\n  onSaveOrMissionUploaded: (\n    evt: ChangeEvent<HTMLInputElement>\n  ) => Promise<void>;\n  setLogger: (logger: UploadLogger) => void;\n  onDownloadFiles: () => Promise<void>;\n}\n\ninterface State {\n  isUploading: boolean;\n  messages: Array<{ msg: string; type: \"info\" | \"warn\" | \"error\" }>;\n}\n\nexport default class UploadInfo extends React.Component<Props, State>\n  implements UploadLogger {\n  constructor(props: Props) {\n    super(props);\n\n    this.state = {\n      isUploading: false,\n      messages: []\n    };\n\n    this.props.setLogger(this);\n  }\n\n  public render() {\n    return (\n      <div\n        style={{\n          marginLeft: \"1em\",\n          marginRight: \"1em\",\n          fontFamily: \"Arial\",\n          maxWidth: \"800px\",\n          lineHeight: 1.4\n        }}\n      >\n        <h1>Anno 2018</h1>\n        <p>\n          Welcome to Anno 2018, an effort to port twenty-year-old Anno 1602 to\n          the browser. This is in early development, however, you can already\n          load your savegames and start new games. Much of the actual simulation\n          is still missing though. For copyright reasons, we can't include the\n          original Anno 1602 files and graphics.{\" \"}\n          <strong>\n            You need own your own copy of Anno 1602 for Anno 2018 work.\n          </strong>\n        </p>\n        <p>\n          The following versions have been tested by us and confirmed to work:\n        </p>\n        <ul>\n          <li>German \"Anno 1602 Kngisedition\"</li>\n          <li>English \"Anno 1602 A.D.\" from GOG</li>\n        </ul>\n        <p>\n          Anno 2018 is tested in the latest versions of{\" \"}\n          <strong>Chrome (preferred, faster) and Firefox</strong> only. Other\n          browsers <em>might</em> work, but aren't supported.\n        </p>\n        <p>\n          To get started, follow these steps. You will need to \"upload\" your\n          Anno files on this website. Don't worry though, the files{\" \"}\n          <em>never</em> leave your PC and are only uploaded into your browser.\n          Once uploaded, the files remain in your browser and will be there when\n          you re-open this website.\n        </p>\n        <ol>\n          <li>\n            Find your Anno 1602 files and zip them. If you are using a version\n            of Anno 1602 which came with a physical CD, copy the videosmk and\n            music8 folders into your Anno 1602 root folder before creating the\n            zip file.\n          </li>\n          <li>\n            Use the upload button below to upload the zip file. The file should\n            be around 50MB if it doesn't contain music and videos, and around\n            500MB if it does.\n          </li>\n          <li>\n            <p>\n              Grab a coffee. The upload takes some time. Progress is being\n              logged below. Should anything go wrong, take a look at the error\n              message. It might tell you what to do. If it doesn't, make sure\n              you're using a recent version of Chrome or Firefox. If it is still\n              not working,{\" \"}\n              <a href=\"https://reddit.com/u/cmfcmf\">drop me a note at reddit</a>\n              , <a href=\"https://twitter.com/christianmflach\">twitter</a>, or{\" \"}\n              <a href=\"https://github.com/cmfcmf/Anno2018\">\n                create an issue at GitHub\n              </a>\n              . Make sure to include the upload progress output.\n            </p>\n            Upload:{\" \"}\n            <input\n              type={\"file\"}\n              multiple={false}\n              accept={\".zip\"}\n              onChange={this.zipUploaded}\n              disabled={this.state.isUploading}\n            />\n          </li>\n        </ol>\n\n        <h2>\n          Upload Progress <small>(newest at the top)</small>\n        </h2>\n        {this.state.messages.length === 0 && <p>Nothing yet...</p>}\n        <div style={{ fontSize: \"10px\" }}>\n          {this.state.messages.map((message, i) => (\n            <div key={i}>\n              <span\n                style={{\n                  color:\n                    message.type === \"info\"\n                      ? \"blue\"\n                      : message.type === \"warn\"\n                      ? \"orange\"\n                      : \"red\"\n                }}\n              >\n                {message.type.toUpperCase()}\n              </span>\n              : {message.msg}\n            </div>\n          ))}\n        </div>\n\n        <h2>Uploading custom missions and additional savegames</h2>\n        <p>\n          Use this button to upload additional missions or savegames after you\n          uploaded the main game:{\" \"}\n          <input\n            type={\"file\"}\n            multiple={true}\n            accept={\".szm,.szs,.gam\"}\n            onChange={this.props.onSaveOrMissionUploaded}\n          />\n        </p>\n\n        <h2>Downloading all uploaded and converted files</h2>\n        <p>\n          Use this button to download an archive of all uploaded files. This\n          includes the original files as well as converted files:\n        </p>\n        <button type=\"button\" onClick={this.props.onDownloadFiles}>\n          Download files\n        </button>\n\n        <h2>Resetting files</h2>\n        <p>\n          You can use the \"Reset all files\" button to delete all uploaded files\n          if needed: <button onClick={this.resetFiles}>Reset all files</button>\n        </p>\n      </div>\n    );\n  }\n\n  public readonly info = (msg: string) => {\n    this.log(msg, \"info\");\n  };\n\n  public readonly warn = (msg: string) => {\n    this.log(msg, \"warn\");\n  };\n\n  public readonly error = (msg: string) => {\n    this.log(msg, \"error\");\n  };\n\n  private readonly log = (msg: string, type: \"info\" | \"warn\" | \"error\") => {\n    this.setState((prevState: State) => {\n      return {\n        ...prevState,\n        messages: [\n          { msg, type },\n          ...prevState.messages.filter(\n            (message, i) => message.type !== \"info\" || i < 50\n          )\n        ]\n      };\n    });\n  };\n\n  private zipUploaded = async (evt: ChangeEvent<HTMLInputElement>) => {\n    const files = evt.target.files;\n    if (files === null || files.length !== 1) {\n      alert(\"Please select the zipped Anno1602 folder to upload.\");\n      return;\n    }\n    const file = files[0];\n    if (!file.name.endsWith(\".zip\")) {\n      alert(\"You need to upload a .zip file!\");\n      return;\n    }\n\n    this.setState({ isUploading: true });\n    const worked = await this.props.onUploaded(file);\n    this.setState({ isUploading: false });\n\n    if (worked) {\n      this.info(\"Upload finished. Please reload the page.\");\n      alert(\"Upload finished. Please reload the page.\");\n    } else {\n      this.error(\"The upload failed.\");\n      alert(\"The upload failed.\");\n    }\n  };\n\n  private resetFiles = async () => {\n    await this.props.onReset();\n    alert(\"All files deleted. The page will now refresh.\");\n    window.location.reload(true);\n  };\n}\n","import JSZip from \"jszip\";\nimport { JSZipObject } from \"jszip\";\nimport * as log from \"loglevel\";\nimport * as React from \"react\";\nimport { ChangeEvent } from \"react\";\nimport * as ReactDOM from \"react-dom\";\nimport FileSystem from \"./filesystem\";\nimport BSHParser from \"./parsers/BSH/bsh-parser\";\nimport CODParser from \"./parsers/COD/cod-parser\";\nimport DATParser from \"./parsers/DAT/dat-parser\";\nimport SMKParser from \"./parsers/SMK/smk-parser\";\nimport Stream from \"./parsers/stream\";\n// import MP3Encoder from \"./parsers/WAV/mp3-encoder\";\nimport WAVParser from \"./parsers/WAV/wav-parser\";\nimport BitmapFontGenerator from \"./parsers/ZEI/bitmap-font-generator\";\nimport parseTranslations from \"./translation/translation-parser\";\nimport UploadInfo from \"./uploadInfo\";\nimport { findRootInZip } from \"./util/util\";\n\n// eslint-disable-next-line @typescript-eslint/no-var-requires\nconst escapeStringRegexp = require(\"escape-string-regexp\");\n\nexport interface UploadLogger {\n  readonly info: (msg: string) => void;\n  readonly warn: (msg: string) => void;\n  readonly error: (msg: string) => void;\n}\n\nexport default class UploadHandler {\n  private logger: UploadLogger;\n\n  constructor(private readonly fs: FileSystem) {\n    this.logger = log;\n  }\n\n  public async init() {\n    console.table(await this.fs.ls(\"/\"));\n  }\n\n  public render(game: HTMLElement) {\n    const notes = document.createElement(\"div\");\n    ReactDOM.render(\n      React.createElement(UploadInfo, {\n        onUploaded: this.uploadAndParse.bind(this),\n        onReset: this.reset.bind(this),\n        onSaveOrMissionUploaded: async (evt: ChangeEvent<HTMLInputElement>) => {\n          const files = evt.target.files;\n          if (files === null || files.length === 0) {\n            return;\n          }\n          await Promise.all(\n            Array.from(files).map(file => this.uploadSaveOrMission(file))\n          );\n          alert(\"Upload finished. The page will now refresh.\");\n          window.location.reload(true);\n        },\n        onDownloadFiles: async () => {\n          await this.fs.download(\"/\");\n        },\n        setLogger: this.setLogger.bind(this)\n      }),\n      game\n    );\n\n    game.appendChild(notes);\n  }\n\n  public async isUploaded() {\n    return this.fs.exists(\"/fields.dat\");\n  }\n\n  public setLogger(logger: UploadLogger) {\n    this.logger = logger;\n  }\n\n  private async reset() {\n    await this.fs.rmRoot();\n  }\n\n  private async uploadAndParse(file: File): Promise<boolean> {\n    let zip;\n    try {\n      await this.fs.write(\"/original.zip\", file);\n      const zipFileEntry = await this.fs.open(\"/original.zip\");\n      zip = await JSZip.loadAsync(zipFileEntry);\n    } catch (e) {\n      this.logger.error(`Could not upload the ZIP file: ${e.message}`);\n      return false;\n    }\n\n    try {\n      const annoRoot = findRootInZip(zip);\n      await this.fs.rmRoot();\n\n      await this.copyIslands(annoRoot);\n      await this.copySaves(annoRoot);\n      const customMissionPath = await this.parseTranslations(annoRoot);\n      await this.copyMissions(annoRoot, customMissionPath);\n      await this.decryptCODs(annoRoot);\n      await this.parseDATs();\n      await this.parseGADs(annoRoot);\n      await this.parseBSHs(annoRoot);\n      await this.parseZEIs(annoRoot);\n      await this.parseMusic(annoRoot);\n      await this.parseVideos(annoRoot);\n    } catch (e) {\n      this.logger.error(e.message);\n      return false;\n    }\n\n    return true;\n  }\n\n  private async uploadSaveOrMission(file: File) {\n    if (file.name.endsWith(\".gam\")) {\n      await this.fs.write(`/saves/${file.name}`, file);\n    } else {\n      await this.fs.write(`/missions-custom/${file.name}`, file);\n    }\n  }\n\n  private async parseDATs() {\n    return Promise.all(\n      [\n        [\"/fields.dat\", \"/fields.json\"],\n        [\"/animations.dat\", \"/animations.json\"]\n      ].map(async r => {\n        const inName = r[0];\n        const outName = r[1];\n        this.logger.info(`Started parsing \"${inName}\".`);\n\n        const parser = new DATParser();\n        const data = parser.parse(\n          await this.fs.openAndGetContentAsText(inName)\n        );\n        await this.fs.write(outName, JSON.stringify(data));\n\n        this.logger.info(`Finished parsing \"${inName}\".`);\n      })\n    );\n  }\n\n  private async parseGADs(annoRoot: JSZip) {\n    await this.fs.mkdir(\"/screens\");\n\n    const parser = new DATParser();\n\n    const toolsIncPath = \"GADDATA/TOOLS.INC\";\n    this.logger.info(`Started parsing \"${toolsIncPath}\".`);\n    const toolsIncFile = this.findFileCaseInsensitive(annoRoot, toolsIncPath);\n    const toolsIncData = parser.parse(await toolsIncFile.async(\"text\"));\n    const initialVariables = new Map(Object.entries(toolsIncData.variables));\n    this.logger.info(`Finished parsing \"${toolsIncPath}\".`);\n\n    const files = [\n      [\"Anno.gad\", \"\"],\n      [\"BASE.GAD\", \"menu_main\"],\n      [\"BAU.GAD\", \"\"],\n      [\"BAUKONT.GAD\", \"\"],\n      [\"BAUSHIP.GAD\", \"\"],\n      [\"BERGWERK.GAD\", \"\"],\n      [\"BUBBLE01.GAD\", \"\"],\n      [\"BUBBLE.GAD\", \"\"],\n      [\"CHAT.GAD\", \"\"],\n      [\"CLIENT.GAD\", \"\"],\n      [\"CTRL.GAD\", \"\"],\n      [\"DISK.GAD\", \"\"],\n      // [\"ENDE_DEM.GAD\", \"\"],\n      [\"ENDE.GAD\", \"menu_points\"],\n      [\"FARBWAHL.GAD\", \"menu_player_selection\"],\n      [\"HANDEL.GAD\", \"\"],\n      [\"HOST.GAD\", \"menu_missions\"],\n      [\"INFO.GAD\", \"\"],\n      [\"INFRA.GAD\", \"\"],\n      [\"KONTOR.GAD\", \"\"],\n      [\"LAGER.GAD\", \"\"],\n      [\"LEIST.GAD\", \"\"],\n      [\"MARKT.GAD\", \"\"],\n      [\"MILITAR.GAD\", \"\"],\n      [\"MISSION.GAD\", \"menu_mission_details\"],\n      [\"MISSZIEL.GAD\", \"\"],\n      [\"MKSHIP.GAD\", \"\"],\n      [\"MKSOLDAT.GAD\", \"\"],\n      [\"MUSIK.GAD\", \"\"],\n      [\"OPTION.GAD\", \"\"],\n      [\"PIRAT.GAD\", \"\"],\n      [\"PIRATORD.GAD\", \"\"],\n      [\"PLANTAGE.GAD\", \"\"],\n      [\"PROD.GAD\", \"\"],\n      [\"ROUTE.GAD\", \"\"],\n      [\"SCAPE.GAD\", \"\"],\n      [\"SHIP.GAD\", \"\"],\n      [\"SHIPLIST.GAD\", \"\"],\n      [\"SIEDLER.GAD\", \"\"],\n      [\"SKSHIP.GAD\", \"\"],\n      [\"SKSOLDAT.GAD\", \"\"],\n      [\"STADT.GAD\", \"\"],\n      [\"STADTLST.GAD\", \"\"],\n      // [\"TOOLS.INC\", \"\"],\n      [\"TRADE.GAD\", \"\"],\n      [\"TRADER.GAD\", \"\"],\n      [\"TRANSFER.GAD\", \"\"],\n      [\"TRIBUT.GAD\", \"\"],\n      [\"TUTOR.GAD\", \"\"],\n      [\"VERTRAG.GAD\", \"\"],\n      [\"WAITLOAD.GAD\", \"menu_loading\"],\n      [\"WERFT.GAD\", \"\"]\n    ];\n\n    for (const r of files) {\n      if (r[1] === \"\") {\n        r[1] = r[0];\n      }\n      const inName = `GADDATA/${r[0]}`;\n      const outName = `/screens/${r[1]}.json`;\n      this.logger.info(`Started parsing \"${inName}\".`);\n\n      const gadFile = this.findFileCaseInsensitive(annoRoot, inName);\n      const data = parser.parse(await gadFile.async(\"text\"), initialVariables);\n      await this.fs.write(outName, JSON.stringify(data));\n\n      this.logger.info(`Finished parsing \"${inName}\".`);\n    }\n  }\n\n  private async decryptCODs(annoRoot: JSZip) {\n    const parser = new CODParser();\n\n    return Promise.all(\n      [[\"haeuser.cod\", \"/fields.dat\"], [\"figuren.cod\", \"/animations.dat\"]].map(\n        async r => {\n          const inName = r[0];\n          const outName = r[1];\n\n          this.logger.info(`Started parsing \"${inName}\".`);\n\n          const codFile = this.findFileCaseInsensitive(annoRoot, inName);\n          const codStream = await Stream.fromZipObject(codFile);\n          await this.fs.write(outName, parser.decrypt(codStream));\n\n          this.logger.info(`Finished parsing \"${inName}\".`);\n        }\n      )\n    );\n  }\n\n  private async parseBSHs(annoRoot: JSZip) {\n    const parser = new BSHParser();\n\n    const files = [\n      [\"GFX/NUMBERS\", \"NUMBERS\"],\n      [\"GFX/STADTFLD\", \"STADTFLD\"],\n      [\"GFX/EFFEKTE\", \"EFFEKT\"],\n      [\"GFX/FISCHE\", \"WAL\"],\n      [\"GFX/GAUKLER\", \"GAUKLER\"],\n      [\"GFX/MAEHER\", \"MAEHER\"],\n      [\"GFX/SCHATTEN\", \"SCHATTEN\"],\n      [\"GFX/SHIP\", \"SHIP\"],\n      [\"GFX/SOLDAT\", \"SOLDAT\"],\n      [\"GFX/TIERE\", \"RIND\"],\n      [\"GFX/TRAEGER\", \"TRAEGER\"],\n      [\"ToolGfx/BAUHAUS\", \"TOOLS/BAUHAUS\"],\n      [\"ToolGfx/BAUSHIP\", \"TOOLS/BAUSHIP\"],\n      // [\"ToolGfx/EDITOR\",  \"TOOLS/EDITOR\"],\n      [\"ToolGfx/START\", \"TOOLS/START\"],\n      [\"ToolGfx/SYMBOL\", \"TOOLS/SYMBOL\"],\n      [\"ToolGfx/TOOLS\", \"TOOLS/TOOLS\"]\n    ];\n    for (const r of files) {\n      const inName = r[0] + \".BSH\";\n      const outName = r[1];\n\n      this.logger.info(`Started parsing \"${inName}\".`);\n      const bshFile = this.findFileCaseInsensitive(annoRoot, inName);\n      const images = await parser.decodeBSH(\n        await Stream.fromZipObject(bshFile)\n      );\n      const sheets = parser.createSpriteSheets(images);\n      await parser.saveSpriteSheets(this.fs, sheets, `/gfx/${outName}`);\n      this.logger.info(`Finished parsing \"${inName}\".`);\n    }\n  }\n\n  private async parseTranslations(annoRoot: JSZip) {\n    this.logger.info(\"Started parsing translations.\");\n    const translationFile = this.findFileCaseInsensitive(annoRoot, \"text.cod\");\n    const codParser = new CODParser();\n    const translations = parseTranslations(\n      codParser.decrypt(await Stream.fromZipObject(translationFile))\n    );\n    await this.fs.write(\"/translations.json\", JSON.stringify(translations));\n    this.logger.info(\"Finished parsing translations.\");\n\n    return translations.PATH[0];\n  }\n\n  private async parseZEIs(annoRoot: JSZip) {\n    await this.fs.mkdir(\"/fonts\");\n\n    const parser = new BSHParser();\n    const bitmapFontGenerator = new BitmapFontGenerator();\n\n    const files = [\n      \"ZEI11A\",\n      \"ZEI14A\",\n      \"ZEI14V\",\n      \"ZEI16G\",\n      \"ZEI16H\",\n      \"ZEI16V\",\n      \"ZEI20H\",\n      \"ZEI20V\",\n      \"ZEI24V\",\n      \"ZEI28V\",\n      \"ZEI2\",\n      \"ZEI9A\"\n    ];\n    for (const fontName of files) {\n      const inName = `TOOLGFX/${fontName}.ZEI`;\n      this.logger.info(`Started parsing \"${inName}\".`);\n\n      const zeiFile = this.findFileCaseInsensitive(annoRoot, inName);\n      const images = await parser.decodeZEI(\n        await Stream.fromZipObject(zeiFile)\n      );\n      const sheets = parser.createSpriteSheets(images);\n      await parser.saveSpriteSheets(this.fs, sheets, `/fonts/${fontName}`);\n      const font = await bitmapFontGenerator.createBitmapFont(sheets, fontName);\n\n      await this.fs.write(`/fonts/${fontName}/font.xml`, font);\n\n      this.logger.info(`Finished parsing \"${inName}\".`);\n    }\n  }\n\n  private async parseMusic(annoRoot: JSZip) {\n    await this.fs.mkdir(\"/music\");\n\n    if (!this.hasFolderCaseInsensitive(annoRoot, \"MUSIC8\")) {\n      this.logger.warn(\"No music files found.\");\n      return;\n    }\n\n    const wavParser = new WAVParser();\n    // const mp3Encoder = new MP3Encoder();\n\n    const songs = this.findFilesInZip(annoRoot, \"MUSIC8\", \".wav\");\n    for (const song of songs) {\n      const name = song.path.substr(1);\n      this.logger.info(`Converting song ${name}`);\n      const rawData = wavParser.decode(await song.file.async(\"uint8array\"));\n      const wavData = wavParser.encode(rawData);\n\n      await this.fs.write(`/music/${name}`, wavData);\n\n      // Alternatively, we could convert the .wav files into .mp3 format.\n      // This takes about 10 seconds per .wav file.\n      //\n      // const mp3Data = mp3Encoder.encode(rawData);\n      // await this.fs.write(\n      //     `/music/${name.replace(\".wav\", \".mp3\")}`,\n      //     mp3Data,\n      // );\n\n      this.logger.info(`Finished converting song ${name}`);\n    }\n  }\n\n  private async parseVideos(annoRoot: JSZip) {\n    await this.fs.mkdir(\"/videos\");\n\n    if (!this.hasFolderCaseInsensitive(annoRoot, \"VIDEOSMK\")) {\n      this.logger.warn(\"No video files found.\");\n      return;\n    }\n\n    const smkParser = new SMKParser();\n\n    const videos = this.findFilesInZip(annoRoot, \"VIDEOSMK\", \".smk\");\n    for (const video of videos) {\n      const name = video.path.substr(1);\n      this.logger.info(`Converting video ${name}`);\n\n      const videoData = await video.file.async(\"uint8array\");\n      const result = await smkParser.parse(videoData);\n\n      await this.fs.write(`/videos/${name.replace(\".smk\", \".mp4\")}`, result);\n      this.logger.info(`Finished converting video ${name}`);\n    }\n  }\n\n  private async copyIslands(annoRoot: JSZip) {\n    return Promise.all(\n      [\n        [\"NOKLIMA\", \"/islands/noklima\"],\n        [\"NORD\", \"/islands/north\"],\n        [\"NORDNAT\", \"/islands/northnat\"],\n        [\"SUED\", \"/islands/south\"],\n        [\"SUEDNAT\", \"/islands/southnat\"]\n      ].map(r => {\n        return this.copyFolderFromZip(annoRoot, r[0], r[1], \".scp\");\n      })\n    );\n  }\n\n  private async copySaves(annoRoot: JSZip) {\n    await this.copyFolderFromZip(annoRoot, \"SAVEGAME\", \"/saves\", \".gam\");\n  }\n\n  private async copyMissions(annoRoot: JSZip, customMissionPath: string) {\n    await this.copyFolderFromZip(\n      annoRoot,\n      \"Szenes\",\n      \"/missions-original\",\n      \".szm|.szs|.hss\"\n    );\n    await this.copyFolderFromZip(\n      annoRoot,\n      customMissionPath,\n      \"/missions-custom\",\n      \".szm|.szs|.hss\"\n    );\n  }\n\n  private async copyFolderFromZip(\n    zip: JSZip,\n    inPath: string,\n    outPath: string,\n    fileExtensions: string,\n    makeLowerCase: boolean = true\n  ) {\n    inPath = `${inPath}/`;\n    this.logger.info(\n      `Copying '${fileExtensions}' files from '${inPath}' to '${outPath}'.`\n    );\n\n    const files = this.findFilesInZip(zip, inPath, fileExtensions);\n\n    await this.fs.mkdir(outPath);\n\n    for (const fileAndPath of files) {\n      const relativePath = makeLowerCase\n        ? fileAndPath.path.toLowerCase()\n        : fileAndPath.path;\n      const file = fileAndPath.file;\n\n      const targetPath = `${outPath}/${relativePath}`;\n      this.logger.info(`Copying '${relativePath}' to '${targetPath}'.`);\n      await this.fs.write(targetPath, await file.async(\"blob\"));\n    }\n  }\n\n  private findFilesInZip(zip: JSZip, inPath: string, fileExtensions: string) {\n    const files: Array<{ path: string; file: JSZipObject }> = [];\n    zip.forEach((relativePath, file) => {\n      if (relativePath.startsWith(inPath)) {\n        for (const fileExtension of fileExtensions.split(\"|\")) {\n          if (\n            relativePath.toLowerCase().endsWith(fileExtension.toLowerCase())\n          ) {\n            relativePath = relativePath.substring(inPath.length);\n            relativePath = relativePath.substring(\n              0,\n              relativePath.length - fileExtension.length\n            );\n            relativePath += fileExtension;\n            files.push({\n              path: relativePath,\n              file: file\n            });\n            break;\n          }\n        }\n      }\n    });\n    return files;\n  }\n\n  private findFileCaseInsensitive(zip: JSZip, path: string): JSZip.JSZipObject {\n    const caseInsensitiveFileName = new RegExp(escapeStringRegexp(path), \"i\");\n    const file = zip.file(caseInsensitiveFileName)[0];\n    if (file === undefined) {\n      throw new Error(`Could not find file ${path}.`);\n    }\n\n    return file;\n  }\n\n  private hasFolderCaseInsensitive(zip: JSZip, path: string): boolean {\n    const caseInsensitiveFolderName = new RegExp(escapeStringRegexp(path), \"i\");\n    return zip.folder(caseInsensitiveFolderName)[0] !== undefined;\n  }\n}\n","import * as log from \"loglevel\";\nimport { Viewport } from \"pixi-viewport\";\nimport {\n  Application,\n  MIPMAP_MODES,\n  Point,\n  Rectangle,\n  SCALE_MODES,\n  settings\n} from \"pixi.js\";\nimport FileSystem from \"./filesystem\";\nimport GameLoader from \"./game-loader\";\nimport AnimationRenderer from \"./game/animation-renderer\";\nimport ConfigLoader from \"./game/config-loader\";\nimport FontLoader from \"./game/font-loader\";\nimport GADRenderer from \"./game/gad-renderer\";\nimport IslandRenderer from \"./game/island-renderer\";\nimport IslandSpriteLoader from \"./game/island-sprite-loader\";\nimport MenuStructure from \"./game/menu-structure\";\nimport MusicPlayer from \"./game/music-player\";\nimport { islandFromSaveGame } from \"./game/world/island\";\nimport { Block } from \"./parsers/GAM/block\";\nimport GAMParser from \"./parsers/GAM/gam-parser\";\nimport IslandLoader from \"./parsers/GAM/island-loader\";\nimport SpriteLoader from \"./sprite-loader\";\nimport { loadTranslations } from \"./translation/translator\";\nimport UploadHandler from \"./upload\";\nimport { getQueryParameter } from \"./util/util\";\n\n// eslint-disable-next-line @typescript-eslint/no-floating-promises\n(async () => {\n  log.enableAll();\n\n  const style = document.createElement(\"style\");\n  style.innerText = `\n        body, html {\n            margin: 0;\n        }\n    `;\n  const game = document.createElement(\"div\");\n  game.id = \"game\";\n  const version = document.createElement(\"p\");\n  version.innerHTML = `Anno 2018, version ${__VERSION__},\n                         made by <a href=\"https://github.com/cmfcmf\">@cmfcmf</a>.\n                         The sourcecode can be found at <a href=\"https://github.com/cmfcmf/Anno2018\">GitHub</a>.`;\n\n  document.head.appendChild(style);\n  document.body.appendChild(game);\n  document.body.appendChild(version);\n\n  const fs = new FileSystem();\n  const FS_SIZE_MB = 2000;\n  await fs.init(1024 * 1024 * FS_SIZE_MB);\n  (window as any).fs = fs;\n\n  const uploadHandler = new UploadHandler(fs);\n  await uploadHandler.init();\n  uploadHandler.render(game);\n\n  if (!(await uploadHandler.isUploaded())) {\n    console.warn(\"Anno 1602 files not yet uploaded.\");\n    return;\n  }\n\n  // utils.skipHello();\n  settings.SCALE_MODE = SCALE_MODES.NEAREST;\n  settings.MIPMAP_TEXTURES = MIPMAP_MODES.OFF;\n  // settings.RENDER_OPTIONS.antialias = false;\n\n  const app = new Application({\n    width: window.innerWidth,\n    height: window.innerHeight - 120,\n    antialias: false,\n    transparent: false\n  });\n  game.insertAdjacentElement(\"afterbegin\", app.view);\n\n  const viewport = new Viewport({\n    screenWidth: app.screen.width,\n    screenHeight: app.screen.height,\n    passiveWheel: false\n  });\n  app.stage.addChild(viewport);\n\n  viewport\n    .drag({ direction: \"all\", wheel: false })\n    .wheel()\n    .mouseEdges({ distance: 20, speed: 15 });\n\n  const menuViewport = new Viewport({\n    screenWidth: app.screen.width,\n    screenHeight: app.screen.height,\n    worldWidth: 1024,\n    worldHeight: 768\n  });\n  app.stage.addChild(menuViewport);\n\n  await loadTranslations(fs);\n\n  const fontLoader = new FontLoader(fs);\n  await fontLoader.load();\n\n  const configLoader = new ConfigLoader(fs);\n  await configLoader.load();\n  console.log(`Finished loading config.`);\n\n  const musicPlayer = new MusicPlayer(fs);\n  await musicPlayer.load();\n  console.log(`Finished loading music.`);\n\n  const spriteLoader = new SpriteLoader(fs);\n  const islandLoader = new IslandLoader(fs, configLoader.getFieldData());\n\n  const animationData = JSON.parse(\n    await fs.openAndGetContentAsText(\"/animations.json\")\n  );\n  const animationRenderer = new AnimationRenderer(animationData, spriteLoader);\n\n  const gamParser = new GAMParser(islandLoader);\n  const islandSpriteLoader = new IslandSpriteLoader(\n    configLoader,\n    spriteLoader,\n    animationRenderer\n  );\n\n  const gameLoader = new GameLoader(\n    fs,\n    gamParser,\n    islandSpriteLoader,\n    app,\n    viewport,\n    configLoader,\n    musicPlayer,\n    animationRenderer\n  );\n\n  const queryGameName = getQueryParameter(\"load\");\n  const gad = getQueryParameter(\"gad\");\n  const animationName = getQueryParameter(\"animation\");\n  const islandName = getQueryParameter(\"island\");\n  if (queryGameName !== null) {\n    await gameLoader.loadByName(queryGameName);\n    // eslint-disable-next-line require-atomic-updates\n    menuViewport.visible = false;\n  } else if (gad !== null) {\n    console.info(`Rendering \"${gad}\" screen.`);\n    const gadRenderer = new GADRenderer(menuViewport, spriteLoader);\n    const menuStructure = new MenuStructure(fs, gadRenderer, musicPlayer);\n    await menuStructure.renderScreen(gad);\n  } else if (animationName !== null) {\n    console.log(`Rendering animation \"${animationName}\".`);\n    await animationRenderer.renderAnimation(animationName, viewport);\n  } else if (islandName !== null) {\n    console.info(`Rendering island \"${islandName}\".`);\n    const islandFile = await islandLoader.loadIslandFileByName(islandName);\n\n    const blocks: Block[] = [];\n    while (!islandFile.eof()) {\n      blocks.push(Block.fromStream(islandFile));\n    }\n    console.table(blocks);\n\n    const island = islandFromSaveGame(\n      blocks.find(block => [\"INSEL5\", \"INSEL4\", \"INSEL3\"].includes(block.type))!\n        .data\n    );\n    islandLoader.setIslandFields(island, [\n      blocks.find(block => block.type === \"INSELHAUS\")!\n    ]);\n    island.position = new Point(0, 0);\n    island.positionRect = new Rectangle(0, 0, island.size.x, island.size.y);\n\n    // eslint-disable-next-line require-atomic-updates\n    menuViewport.visible = false;\n    const islandRenderer = new IslandRenderer(viewport, islandSpriteLoader);\n    await islandRenderer.render([island]);\n  } else {\n    // menuViewport.fit(); // TODO: Makes usage of sliders harder\n    const gadRenderer = new GADRenderer(menuViewport, spriteLoader);\n    const menuStructure = new MenuStructure(fs, gadRenderer, musicPlayer);\n    menuStructure.on(\"load-game\", async (mission: string) => {\n      await gameLoader.load(mission);\n      menuViewport.visible = false;\n    });\n    await menuStructure.renderScreen(\"menu_main\");\n  }\n})();\n","import AsyncLock from \"async-lock\";\n\nlet loadedFFmpeg: any;\n\nconst lock = new AsyncLock();\n\nexport async function loadFFmpeg(): Promise<any> {\n  await lock.acquire(\"ffmpeg\", async () => {\n    if (!loadedFFmpeg) {\n      // eslint-disable-next-line require-atomic-updates\n      loadedFFmpeg = await doLoadFFmpeg();\n\n      await new Promise((resolve, reject) => {\n        loadedFFmpeg({\n          arguments: [\"-version\"],\n          returnCallback: resolve\n        });\n      });\n    }\n  });\n\n  return loadedFFmpeg;\n}\n\nasync function doLoadFFmpeg() {\n  console.log(\"Loading FFmpeg\");\n  let ffmpeg;\n\n  if (typeof window !== \"undefined\") {\n    ffmpeg = await loadFFmpegInBrowser();\n  } else {\n    // We can't write require() directly, because we don't want webpack to interpret it.\n    // It is only used when running this script under Node.js.\n    ffmpeg = eval(\"require\")(\n      __dirname + \"/../../node_modules/smk2mp4/demo/ffmpeg.js\"\n    );\n  }\n  console.log(\"Finished loading FFmpeg\");\n  return ffmpeg;\n}\n\nasync function loadFFmpegInBrowser(): Promise<any> {\n  return new Promise<any>((resolve, reject) => {\n    const callback = () => {\n      const ffmpeg_run = (self as any).ffmpeg_run;\n      if (ffmpeg_run) {\n        resolve(ffmpeg_run);\n      } else {\n        reject(\"Could not load FFmpeg!\");\n      }\n    };\n\n    const head = document.getElementsByTagName(\"head\")[0];\n    const script = document.createElement(\"script\");\n    script.type = \"text/javascript\";\n    script.src = \"ffmpeg.js\";\n    (script as any).onreadystatechange = callback;\n    script.onload = callback;\n\n    head.appendChild(script);\n  });\n}\n","import { JSZipObject } from \"jszip\";\n\nexport default class Stream {\n  public static async fromZipObject(zip: JSZipObject) {\n    const data = await zip.async(\"uint8array\");\n\n    return new Stream(data);\n  }\n\n  private pos: number;\n  private readonly data: Uint8Array;\n\n  public constructor(data: Uint8Array) {\n    this.pos = 0;\n    this.data = data;\n  }\n\n  get length(): number {\n    return this.data.length;\n  }\n\n  public position(): number {\n    return this.pos;\n  }\n\n  public seek(pos: number) {\n    this.pos = pos;\n  }\n\n  public readString(length: number) {\n    let result = \"\";\n    let done = false;\n    while (length--) {\n      const character = this.read8();\n      if (done || character === 0) {\n        done = true;\n        continue;\n      }\n      result += String.fromCharCode(character);\n    }\n\n    return result;\n  }\n\n  public readStringUnterminated(length: number) {\n    let result = \"\";\n    while (length--) {\n      result += String.fromCharCode(this.read8());\n    }\n\n    return result;\n  }\n\n  public read(length: number, size: number = 1) {\n    length *= size;\n    const result = [];\n    while (length > 0) {\n      result.push(this.readNBytes(size));\n      length -= size;\n    }\n    return result;\n  }\n\n  public slice(length: number) {\n    const data = this.data.slice(this.pos, this.pos + length);\n    this.pos += length;\n    return data;\n  }\n\n  public read16() {\n    return this.readNBytes(2);\n  }\n\n  public read24() {\n    return this.readNBytes(3);\n  }\n\n  public read32() {\n    return this.readNBytes(4);\n  }\n\n  public read32S(): number {\n    return this.readNBytes(4) >> 0;\n  }\n\n  public read64() {\n    return this.readNBytes(8);\n  }\n\n  public read8() {\n    return this.data[this.pos++];\n  }\n\n  public eof() {\n    return this.pos === this.length;\n  }\n\n  public read8Bool(): boolean {\n    return this.read8() !== 0;\n  }\n\n  private readNBytes(n: number) {\n    let result = 0;\n    for (let i = 0; i < n; i++) {\n      result += this.read8() * 2 ** (i * 8);\n    }\n    return result;\n  }\n}\n","import { decode as iconv_decode, encode as iconv_encode } from \"iconv-lite\";\nimport Stream from \"../stream\";\n\nexport default class CODParser {\n  private encoding = \"win1252\";\n\n  public decrypt(data: Stream): string {\n    const decryptedBytes = new Buffer(data.length);\n    for (let i = 0; i < data.length; i++) {\n      decryptedBytes[i] = 256 - data.read8();\n    }\n\n    // Decode the bytes using Windows 1252 \"Western\" encoding.\n    // The resulting string will then be written in UTF-8 format.\n    return iconv_decode(decryptedBytes, this.encoding);\n  }\n\n  public encrypt(content: string): Uint8Array {\n    const file = new Stream(iconv_encode(content, this.encoding));\n    const encryptedBytes = new Buffer(file.length);\n    for (let i = 0; i < file.length; i++) {\n      encryptedBytes[i] = 256 - file.read8();\n    }\n\n    return encryptedBytes;\n  }\n}\n","// https://stackoverflow.com/a/12713326/2560557\nimport JSZip from \"jszip\";\n\nexport function uInt8ToBase64(arr: Uint8Array): string {\n  const CHUNK_SIZE = 0x8000; // arbitrary number\n  let index = 0;\n  const length = arr.length;\n  let result = \"\";\n  while (index < length) {\n    const slice = arr.subarray(index, Math.min(index + CHUNK_SIZE, length));\n    result += String.fromCharCode.apply(null, slice);\n    index += CHUNK_SIZE;\n  }\n\n  return typeof window !== \"undefined\"\n    ? btoa(result)\n    : eval(\"require\")(\"btoa\")(result);\n}\n\n/**\n * Get the value of the first query parameter with the given name.\n *\n * Taken from https://stackoverflow.com/a/901144\n */\nexport function getQueryParameter(\n  name: string,\n  defaultValue: string | null = null\n): string | null {\n  const url = window.location.href;\n  name = name.replace(/[[\\]]/g, \"\\\\$&\");\n  const regex = new RegExp(\"[?&]\" + name + \"(=([^&#]*)|&|#|$)\");\n  const results = regex.exec(url);\n  if (!results) {\n    return defaultValue;\n  }\n  if (!results[2]) {\n    return \"\";\n  }\n  return decodeURIComponent(results[2].replace(/\\+/g, \" \"));\n}\n\nexport function findRootInZip(zip: JSZip): JSZip {\n  const gfxFolder = zip.filter(relativePath =>\n    (\"/\" + relativePath).endsWith(\"/GFX/\")\n  );\n  if (gfxFolder.length === 1) {\n    return zip.folder(gfxFolder[0].name.replace(\"GFX/\", \"\"));\n  }\n  throw new Error(\"Your ZIP file does not have the expected structure.\");\n}\n\nexport function make2DArray<T>(x: number, y: number): Array<Array<T | null>> {\n  return Array(x)\n    .fill(undefined)\n    .map(() => Array(y).fill(null));\n}\n\nexport function assertNever(x: never): never {\n  throw new Error(`Unexpected object: ${x}`);\n}\n"],"sourceRoot":""}